/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isSome as e,isNone as t}from"../../../core/maybe.js";import{open as r}from"../../../core/workers/workers.js";import{c as n}from"../../../chunks/vec3f64.js";import{fromValues as o}from"../ray.js";import{intersectRay as a}from"../triangle.js";import i from"./ElevationSamplerWorker.js";import{ElevationSamplerBase as s}from"../../../layers/support/ElevationSampler.js";async function l(e,t){const r=await m(),n=await f.createIndex(e,r);return u(r),new c(e,n,t)}class c extends s{constructor(t,r,n){super(),this.rindex=r,this.demResolution={min:0,max:0},this.spatialReference=t.spatialReference.clone(),this.extent=t.extent.clone(),this.noDataValue=e(n)&&n.noDataValue||0}elevationAt(e){const r=this.projectIfRequired(e,this.spatialReference);if(t(r))return this.noDataValue;let n=Number.NEGATIVE_INFINITY;return o([r.x,r.y,0],[0,0,-1],N),this.rindex.search({minX:r.x,maxX:r.x,minY:r.y,maxY:r.y},(e=>{a(e,N,y)&&y[2]>n&&(n=y[2])})),n===Number.NEGATIVE_INFINITY?this.noDataValue:n}}function m(){return++h,p(),x||(x=r("ElevationSamplerWorker").catch((()=>null)),x)}function u(t){--h,e(t)&&0===h&&(I=setTimeout((()=>{t.close(),x=null,I=0}),j))}function p(){I&&(clearTimeout(I),I=0)}const f=new i;let h=0,x=null,I=0;const j=1e4,N=o([0,0,0],[0,0,-1]),y=n();export{l as create};
