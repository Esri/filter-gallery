/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import e from"../../renderers/ClassBreaksRenderer.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../renderers/support/jsonUtils.js";import i from"../../core/Error.js";import{isSome as a}from"../../core/maybe.js";import{toPt as s}from"../../core/screenUtils.js";import{fetchMessageBundle as n}from"../../intl/messages.js";import{substitute as l}from"../../intl/substitute.js";import r from"../../renderers/support/AuthoringInfo.js";import o from"../../renderers/support/AuthoringInfoVisualVariable.js";import{setLabelsForClassBreaks as t}from"../../renderers/support/utils.js";import m from"../../renderers/visualVariables/SizeVariable.js";import{TransformationType as p}from"../../renderers/visualVariables/support/sizeVariableUtils.js";import u from"../heuristics/ageUnit.js";import d from"../heuristics/outline.js";import y from"../heuristics/sizeRange.js";import{getSummaryStatistics as c,getClassBreaks as b,formatDate as f,updateAgeRendererAuthoringInfoVV as w,verifyBasicFieldValidity as v,getDataRange as h,getSizeRangeForAxis as z,createSymbol as g,getSymbolOutlineFromScheme as x,getSymbolSizeFromScheme as T,getBasemapInfo as S}from"./support/utils.js";import{getAgeExpressions as E,verifyDates as V,supportedAgeUnits as j}from"../statistics/support/ageUtils.js";import{getFieldsList as k,getNormalizationType as O}from"../support/utils.js";import{createLayerAdapter as I,featureCapableLayerTypes as q,getLayerTypeLabels as F}from"../support/adapters/support/layerUtils.js";import{c as U,g as D}from"../../chunks/size.js";const M="date",R=2**53-1;async function B(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new i("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new i("size-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");const s={...e};if("90-10"===s.theme)throw new i("size-visual-variable:not-supported","Only 'high-to-low', 'above', 'below' themes are supported.");const n=I(s.layer,q);if(s.layer=n,!n)throw new i("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+F(q).join(", "));"height"===s.axis&&(s.sizeOptimizationEnabled=!1);const l=a(s.signal)?{signal:s.signal}:null;await n.load(l);const r=n.geometryType;if("mesh"===r)throw new i("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(s.worldScale){if("polyline"===r||"polygon"===r)throw new i("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers");if(!s.view||"3d"!==s.view.type)throw new i("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true")}const o=await k({field:s.field,normalizationField:s.normalizationField,valueExpression:s.valueExpression}),t=v(n,o,"size-visual-variable:invalid-parameters");if(t)throw t;return s}async function C(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new i("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new i("size-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");const s={...e};s.symbolType=s.symbolType||"2d",s.defaultSymbolEnabled=null==s.defaultSymbolEnabled||s.defaultSymbolEnabled;const n=I(s.layer,q);if(s.layer=n,!n)throw new i("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+F(q).join(", "));const l=a(s.signal)?{signal:s.signal}:null;await n.load(l);const r=n.geometryType,o=s.symbolType.indexOf("3d")>-1;if(s.outlineOptimizationEnabled="polygon"===r&&s.outlineOptimizationEnabled,"mesh"===r)throw new i("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(o&&("polyline"===r||"polygon"===r))throw new i("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(s.symbolType.indexOf("3d-volumetric")>-1&&(!s.view||"3d"!==s.view.type))throw new i("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const t=await k({field:s.field,normalizationField:s.normalizationField,valueExpression:s.valueExpression}),m=v(n,t,"size-continuous-renderer:invalid-parameters");if(m)throw m;return s}async function A(e){if(!e||!e.layer||!e.field&&!e.valueExpression)throw new i("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new i("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");const s={...e};s.symbolType=s.symbolType||"2d",s.defaultSymbolEnabled=null==s.defaultSymbolEnabled||s.defaultSymbolEnabled,s.classificationMethod=s.classificationMethod||"equal-interval",s.normalizationType=O(s);const n=I(s.layer,q);if(s.layer=n,!n)throw new i("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+F(q).join(", "));if(!(null!=s.minValue&&null!=s.maxValue)&&(null!=s.minValue||null!=s.maxValue))throw new i("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");const l=a(s.signal)?{signal:s.signal}:null;await n.load(l);const r=n.geometryType,o=s.symbolType.indexOf("3d")>-1;if(s.outlineOptimizationEnabled="polygon"===r&&s.outlineOptimizationEnabled,"mesh"===r)throw new i("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(o&&("polyline"===r||"polygon"===r))throw new i("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(s.symbolType.indexOf("3d-volumetric")>-1&&(!s.view||"3d"!==s.view.type))throw new i("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const t=await k({field:s.field,normalizationField:s.normalizationField}),m=v(n,t,"size-class-breaks-renderer:invalid-parameters");if(m)throw m;return s}function W(e){const i={...e};delete i.basemap,delete i.sizeScheme,delete i.legendOptions,delete i.symbolType,delete i.defaultSymbolEnabled;const a=i;return a.analyzeData=!(null!=i.minValue&&null!=i.maxValue),a}function L(e){const i={...e},a=i.symbolType.indexOf("3d-volumetric")>-1,s=i;return s.worldScale=a,a&&(s.axis="3d-volumetric-uniform"===i.symbolType?"all":"height"),delete i.symbolType,delete i.defaultSymbolEnabled,s}async function P(e){if(!(e&&e.layer&&e.view&&e.startTime&&e.endTime))throw new i("size-age-renderer:missing-parameters","'layer', 'view', 'startTime', 'endTime' parameters are required");const s={...e};s.symbolType=s.symbolType||"2d",s.defaultSymbolEnabled=null==s.defaultSymbolEnabled||s.defaultSymbolEnabled;const n=I(s.layer,q);if(s.layer=n,!n)throw new i("size-age-renderer:invalid-parameters","'layer' must be one of these types: "+F(q).join(", "));const l=a(s.signal)?{signal:s.signal}:null;await n.load(l);const r=n.geometryType,o=s.symbolType.indexOf("3d")>-1;if(s.outlineOptimizationEnabled="polygon"===r&&s.outlineOptimizationEnabled,"mesh"===r)throw new i("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(o&&("polyline"===r||"polygon"===r))throw new i("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(s.symbolType.indexOf("3d-volumetric")>-1&&(!s.view||"3d"!==s.view.type))throw new i("size-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const t=V(n,s.startTime,s.endTime,"size-age-renderer:invalid-parameters");if(t)throw t;if(s.unit&&-1===j.indexOf(s.unit))throw new i("size-age-renderer:invalid-unit",`Supported units are: ${j.join(", ")}`);return s}async function $(e){let i=e.sizeScheme,s=null,n=null;const l=await S(e.basemap,e.view);if(s=a(l.basemapId)?l.basemapId:null,n=a(l.basemapTheme)?l.basemapTheme:null,i)return{scheme:U(i),basemapId:s,basemapTheme:n};const r=D({basemap:s,basemapTheme:n,geometryType:e.geometryType,worldScale:e.worldScale,view:e.view});return r&&(i=r.primaryScheme,s=r.basemapId,n=r.basemapTheme),{scheme:i,basemapId:s,basemapTheme:n}}function H(e,i){let a;switch(i){case"point":case"multipoint":{const i=e;a=[i.minSize,i.maxSize];break}case"polyline":{const i=e;a=[i.minWidth,i.maxWidth];break}case"polygon":{const i=e;a=[i.marker.minSize,i.marker.maxSize];break}}return a}function _(e,i){e.transformationType===p.ClampedLinear&&"below"===i&&e.flipSizes()}async function G(e,a,s,n){const{theme:l,field:t,normalizationField:p,minValue:u,maxValue:d,axis:y}=e,c=e.layer,b=t&&!("function"==typeof t)?c.getField(t):null,f=b&&b.type===M,w=c.geometryType,v=await $({basemap:e.basemap,geometryType:w,sizeScheme:e.sizeScheme,worldScale:e.worldScale,view:e.view}),g=v.scheme;if(!g)throw new i("size-visual-variable:insufficient-info","Unable to find size scheme");const x=n&&[n.minSize,n.maxSize]||H(g,w),{minDataValue:T,maxDataValue:S,defaultValuesUsed:E}=h(a,s,l,f,"above"===l||"below"===l),V=[],j="height"===y,k=j?y:void 0,O=x[0];let I=x[1];if(j&&"number"==typeof O&&"number"==typeof I){const e=z({minSize:O,maxSize:I},k);V.push(new m({axis:"width-and-depth",minSize:e.minSize})),I=e.maxSize}const q=new m({field:t,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,valueUnit:"unknown",normalizationField:p,axis:k,minSize:O,maxSize:I,minDataValue:T,maxDataValue:S,legendOptions:e.legendOptions});_(q,l),V.unshift(q);const F=new o({type:"size",theme:l,minSliderValue:null!=u?u:a.min,maxSliderValue:null!=d?d:a.max}),D=new r({visualVariables:[F]});return{basemapId:v.basemapId,basemapTheme:v.basemapTheme,visualVariables:V,statistics:a,defaultValuesUsed:E,sizeScheme:U(g),authoringInfo:D}}async function J(i,a,s,l,r){const o=await n("esri/smartMapping/t9n/smartMapping"),t=r.layer,m=r.field,p=t.geometryType,u=r.defaultSymbolEnabled,d=U(i.sizeScheme),y="polygon"===p,c=y?d.marker:d,b=y?d.background:null,f=y?"point":p,w=a&&a.opacity,v=i.visualVariables.map((e=>e.clone()));a&&a.visualVariables&&a.visualVariables.length&&v.push(...a.visualVariables.map((e=>e.clone())));return{renderer:new e({backgroundFillSymbol:b&&g(p,{type:r.symbolType,color:b.color,outline:x(b,p,w)}),classBreakInfos:[{minValue:-R,maxValue:R,symbol:g(f,{type:r.symbolType,color:c.color,size:T(c,f),outline:x(c,f,w)})}],defaultLabel:u?o.other:null,defaultSymbol:u?g(f,{type:r.symbolType,color:c.noDataColor,size:T(c,f,!0),outline:x(c,f,w)}):null,field:m,normalizationField:l,normalizationType:s,valueExpression:r.valueExpression,valueExpressionTitle:r.valueExpressionTitle,visualVariables:v,authoringInfo:i.authoringInfo&&i.authoringInfo.clone()}),visualVariables:i.visualVariables.map((e=>e.clone())),statistics:i.statistics,defaultValuesUsed:i.defaultValuesUsed,sizeScheme:U(i.sizeScheme),basemapId:i.basemapId,basemapTheme:i.basemapTheme}}function K(e,i){const a=s(e.minSize),n=(s(e.maxSize)-a)/(i>=4?i-1:i),l=[];for(let s=0;s<i;s++)l.push(a+n*s);return l}async function N(i,a){const s=await n("esri/smartMapping/t9n/smartMapping"),l=i.layer,o=i.defaultSymbolEnabled,m=l.geometryType,p="polygon"===m,u=i.symbolType.indexOf("3d-volumetric")>-1,d=await $({basemap:i.basemap,geometryType:m,sizeScheme:i.sizeScheme,worldScale:u,view:i.view}),y=d.scheme,{result:c,outlineResult:b}=a,f=c.classBreakInfos,w=i.classificationMethod,v=i.normalizationType,h=p?y.marker:y,S=p?y.background:null,E=p?"point":m,V=H(h,E),j=u&&z({minSize:V[0],maxSize:V[1]},"height"),k=K({minSize:V[0],maxSize:u?j.maxSize:V[1]},f.length),O=b&&b.opacity,I=new e({backgroundFillSymbol:S&&g(m,{type:i.symbolType,color:S.color,outline:x(S,m,O)}),classBreakInfos:f.map(((e,a)=>({minValue:e.minValue,maxValue:e.maxValue,symbol:g(E,{type:i.symbolType,color:h.color,size:k[a],widthAndDepth:j&&j.minSize,outline:x(h,E,O)}),label:e.label}))),defaultLabel:o?s.other:null,defaultSymbol:o?g(E,{type:i.symbolType,color:h.noDataColor,size:T(h,E,!0),widthAndDepth:j&&j.minSize,outline:x(h,E,O)}):null,field:i.field,valueExpression:i.valueExpression,valueExpressionTitle:i.valueExpressionTitle,normalizationType:v,normalizationField:i.normalizationField,normalizationTotal:"percent-of-total"===v?c.normalizationTotal:void 0,legendOptions:i.legendOptions,authoringInfo:new r({type:"class-breaks-size",classificationMethod:w,standardDeviationInterval:i.standardDeviationInterval})});return"standard-deviation"!==w&&t({classBreakInfos:I.classBreakInfos,classificationMethod:w,normalizationType:v,round:!0}),b&&b.visualVariables&&b.visualVariables.length&&(I.visualVariables=b.visualVariables.map((e=>e.clone()))),{renderer:I,sizeScheme:U(y),classBreaksResult:c,defaultValuesUsed:a.defaultValuesUsed,basemapId:d.basemapId,basemapTheme:d.basemapTheme}}async function Q(e){const i=await B(e),{view:a,field:s,valueExpression:n,minValue:l,maxValue:r,layer:o,normalizationField:t,signal:m,statistics:p}=i,u=t?"field":void 0,[d,f,w]=await Promise.all([p||c({layer:o,field:s,valueExpression:n,sqlExpression:i.sqlExpression,sqlWhere:i.sqlWhere,normalizationType:u,normalizationField:t,minValue:l,maxValue:r,view:a,signal:m}),"90-10"===i.theme?b({layer:o,field:s,normalizationField:t,valueExpression:n,classificationMethod:"quantile",minValue:l,maxValue:r,view:a,numClasses:10,signal:m}):null,i.sizeOptimizationEnabled?y({view:a,layer:o,signal:m}):null]);return G(i,d,null==f?void 0:f.result,w)}async function X(e){const i=await C(e),a={layer:i.layer,view:i.view,signal:i.signal},[s,n]=await Promise.all([Q(L(i)),i.outlineOptimizationEnabled?d(a):null]),l=i.normalizationField;return J(s,n,l?"field":void 0,l,i)}async function Y(e){const i=await A(e);return N(i,await b(W(i),i.outlineOptimizationEnabled))}async function Z(e){const i=await P(e),{defaultSymbolEnabled:a,view:s,startTime:r,endTime:o,symbolType:t,minValue:m,maxValue:p,signal:y}=i,c=i.layer,b={layer:i.layer,view:i.view,signal:y},[v,h]=await Promise.all([i.unit?{unit:i.unit,statistics:null,valueExpression:null}:await u({view:s,layer:c,startTime:r,endTime:o,minValue:m,maxValue:p,signal:y}),i.outlineOptimizationEnabled?d(b):null]),{unit:z,statistics:g}=v,x=E({layer:c,startTime:r,endTime:o,unit:z}).valueExpression,T=await n("esri/smartMapping/t9n/smartMapping"),S=l(T[`ageInfo_${z}`],{unit:z,startTime:f(r,z,c),endTime:f(o,z,c)}),V=await Q(L({layer:c,basemap:i.basemap,valueExpression:x,symbolType:t,statistics:g,legendOptions:{title:S},theme:i.theme,sizeScheme:i.sizeScheme,sizeOptimizationEnabled:i.sizeOptimizationEnabled,view:i.view,minValue:m,maxValue:p,signal:y})),j={layer:c,valueExpression:x,defaultSymbolEnabled:a,symbolType:t},k=await J(V,h,null,null,j);return k.renderer.authoringInfo.visualVariables.forEach((e=>w(e,r,o,z))),{...k,unit:z}}export{Z as createAgeRenderer,Y as createClassBreaksRenderer,X as createContinuousRenderer,Q as createVisualVariables};
