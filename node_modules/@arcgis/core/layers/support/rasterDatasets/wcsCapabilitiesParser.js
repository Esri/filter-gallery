/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import t from"../../../geometry/Extent.js";import{getElementValue as r,getElement as i,getElements as o,getSpaceDelimitedNumericValues as n,getElementValues as a,isSameTagIgnoreNS as s,getNodeNameIgnoreNS as l}from"./xmlUtilities.js";function c(e){return e.indexOf("?")===e.length-1?e.substring(0,e.length-1):e}function u(e){var a,s,l;const u=r(e,"Service/name"),m=i(e,"Capability"),p=null!=(a=i(m,"GetCapabilities/Get/OnlineResource").getAttribute("xlink:href"))?a:"",g=null!=(s=i(m,"DescribeCoverage/Get/OnlineResource").getAttribute("xlink:href"))?s:"",f=null!=(l=i(m,"GetCoverage/Get/OnlineResource").getAttribute("xlink:href"))?l:"",v={getCapabilities:c(p),describeCoverage:c(g),getCoverage:c(f)},d=o(e,"CoverageOfferingBrief"),b=[];for(let i=0;i<d.length;i++){const e=d[i],a=r(e,"name"),s=o(e,"pos"),l=n(s[0]),c=n(s[1]),u=new t({xmin:l[0],ymin:l[1],xmax:c[0],ymax:c[1],spatialReference:{wkid:4326}});b.push({id:a,lonLatEnvelope:u})}return{name:u,onlineResources:v,coverages:b,supportedVersions:["1.0.0"]}}function m(e){const i={};for(let o=0;o<e.childNodes.length;o++){const a=e.childNodes[o];if(1!==a.nodeType)continue;const s=l(a).toLowerCase();switch(s){case"title":case"abstract":i[s]=r(a);break;case"identifier":i.id=r(a);break;case"wgs84boundingbox":{const e=n(a,"LowerCorner"),r=n(a,"UpperCorner");i.lonLatEnvelope=new t({xmin:e[0],ymin:e[1],xmax:r[0],ymax:r[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":i.coverageSummaries=i.coverageSummaries||[],i.coverageSummaries.push(m(a))}}return i}function p(e,t){if(e.coverageSummaries)for(let r=0;r<e.coverageSummaries.length;r++)e.coverageSummaries[r].abstract=e.coverageSummaries[r].abstract||e.abstract,e.coverageSummaries[r].lonLatEnvelope=e.coverageSummaries[r].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[r].title=e.coverageSummaries[r].title||e.title,p(e.coverageSummaries[r],t);null!=e.id&&t.push(e)}function g(e){const t=i(e.querySelector("Operation[name=GetCapabilities]"),"Get").getAttribute("xlink:href")||"",r=i(e.querySelector("Operation[name=DescribeCoverage]"),"Get").getAttribute("xlink:href")||"",o=i(e.querySelector("Operation[name=GetCoverage]"),"Get").getAttribute("xlink:href")||"";return{getCapabilities:c(t),describeCoverage:c(r),getCoverage:c(o)}}function f(e){const t=r(e,"ServiceIdentification/Title"),o=a(e,"ServiceIdentification/ServiceTypeVersion"),n=g(i(e,"OperationsMetadata")),l=[],c=i(e,"Contents");for(let r=0;r<c.childNodes.length;r++){const e=c.childNodes[r];1===e.nodeType&&(s(e,"CoverageSummary")&&p(m(e),l))}return{name:t,onlineResources:n,coverages:l,supportedVersions:o,supportedFormats:a(c,"SupportedFormat")}}function v(e){const s=i(e,"ServiceIdentification"),l=r(s,"Title"),c=a(s,"ServiceTypeVersion"),u=a(s,"Profile"),m=g(i(e,"OperationsMetadata")),p=o(e,"Contents/CoverageSummary"),f=[];for(let o=0;o<p.length;o++){const e=p[o],a=r(e,"CoverageId"),s=i(e,"WGS84BoundingBox");let l;if(s){const e=n(s,"LowerCorner"),r=n(s,"UpperCorner");l=new t({xmin:e[0],ymin:e[1],xmax:r[0],ymax:r[1],spatialReference:{wkid:4326}})}f.push({id:a,lonLatEnvelope:l})}const v=i(e,"ServiceMetadata");return{name:l,supportedVersions:c,supportedFormats:a(v,"formatSupported"),supportedInterpolations:a(v,"interpolationSupported"),onlineResources:m,profiles:u,coverages:f}}function d(t,r=null){let i=null;if("string"==typeof t){i=(new DOMParser).parseFromString(t,"text/xml")}else i=t;const o=i.documentElement.getAttribute("version"),n=(o||r||"1.0.0").slice(0,3);let a;if("2.0"===n)a=v(i);else if("1.1"===n)a=f(i);else{if("1.0"!==n)throw new e("wcsraster:parsecapabilities","the capabilities version is not supported");a=u(i)}return a.capabilitiesVersion=o,a}export{d as parseCapabilities};
