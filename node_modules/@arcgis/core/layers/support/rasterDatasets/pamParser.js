/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import"../../../geometry.js";import{isSameTagIgnoreNS as e,getElementValue as t,getElements as n,getElement as r,getElementNumericValue as s,getElementNumericValues as a}from"./xmlUtilities.js";import i from"../rasterTransforms/PolynomialTransform.js";import l from"../../../geometry/SpatialReference.js";function o(e,t){if(!e||!t)return null;const n=[];for(let r=0;r<e.length;r++)n.push(e[r]),n.push(t[r]);return n}function u(e){var n;const l=r(e,"GeodataXform"),u=c(s(l,"SpatialReference/WKID")||t(l,"SpatialReference/WKT"));if("typens:PolynomialXform"!==l.getAttribute("xsi:type"))return{spatialReference:u,transform:null};const f=null!=(n=s(l,"PolynomialOrder"))?n:1,m=a(l,"CoeffX/Double"),d=a(l,"CoeffY/Double"),p=a(l,"InverseCoeffX/Double"),S=a(l,"InverseCoeffY/Double"),C=o(m,d),I=o(p,S);return{spatialReference:u,transform:new i({spatialReference:u,polynomialOrder:f,forwardCoefficients:C,inverseCoefficients:I})}}function f(e){var a;const i=s(e,"NoDataValue"),l=r(e,"Histograms/HistItem"),o=s(l,"HistMin"),u=s(l,"HistMax"),f=s(l,"BucketCount"),c=null==(a=t(l,"HistCounts"))?void 0:a.split("|").map((e=>Number(e)));let m,d,p,S;n(e,"Metadata/MDI").forEach((e=>{var t;const n=Number(null!=(t=e.textContent)?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":m=n;break;case"STATISTICS_MAXIMUM":d=n;break;case"STATISTICS_MEAN":p=n;break;case"STATISTICS_STDDEV":S=n}}));const C=s(e,"Metadata/SourceBandIndex");return{noDataValue:i,histogram:null!=c&&c.length&&null!=m&&null!=d?{min:o,max:u,size:f||c.length,counts:c}:null,sourceBandIndex:C,statistics:null!=m&&null!=d?{min:m,max:d,avg:p,stddev:S}:null}}function c(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&0!==t)return new l({wkid:t});if((e=String(e)).startsWith("COMPD_CS")){if(!e.includes("VERTCS")||!e.includes("GEOGCS")&&!e.startsWith("PROJCS"))return null;const n=e.indexOf("VERTCS"),r=e.indexOf("PROJCS"),s=r>-1?r:e.indexOf("GEOGCS");if(-1===s)return null;const a=e.slice(s,e.lastIndexOf("]",n)+1).trim(),i=e.slice(n,e.lastIndexOf("]")).trim();t=m(a);const o=new l(t?{wkid:t}:{wkt:a}),u=m(i);return u&&(o.vcsWkid=u),o}return e.startsWith("GEOGCS")||e.startsWith("PROJCS")?(t=m(e),new l(0!==t?{wkid:t}:{wkt:e})):null}function m(e){var t;const n=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map((e=>e.trim())).filter((e=>""!==e)),r=n[n.length-1].split(","),s=null==(t=r[0])?void 0:t.toLowerCase();if(("epsg"===s||"esri"===s)&&e.endsWith('"]]')){const e=Number(r[1]);if(!isNaN(e)&&0!==e)return e}return 0}function d(r){var s;if("pamdataset"!==(null==r||null==(s=r.documentElement.tagName)?void 0:s.toLowerCase()))return{};const a={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};r.documentElement.childNodes.forEach((r=>{if(1===r.nodeType)if(e(r,"SRS")){if(!a.spatialReference){const e=t(r);a.spatialReference=c(e)}}else if(e(r,"Metadata"))if("xml:ESRI"===r.getAttribute("domain")){const{spatialReference:e,transform:t}=u(r);a.transform=t,a.spatialReference||(a.spatialReference=e)}else{n(r,"MDI").forEach((e=>a.metadata[e.getAttribute("key")]=t(e)))}else if(e(r,"PAMRasterBand")){const e=f(r);null!=e.sourceBandIndex&&null==a.rasterBands[e.sourceBandIndex]?a.rasterBands[e.sourceBandIndex]=e:a.rasterBands.push(e)}}));const i=a.rasterBands;if(i){const e=!!i[0].statistics;a.statistics=e?i.map((e=>e.statistics)):null;const t=!!i[0].histogram;a.histograms=t?i.map((e=>e.histogram)):null}return a}export{d as parsePAMInfo,c as parseSpatialReference};
