/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import t from"../../../../core/Handles.js";import{addFrameTask as i}from"../../../../core/scheduling.js";import{init as a}from"../../../../core/watchUtils.js";import{translateBy as e,scaleAndRotateBy as s}from"../../viewpointUtils.js";import{InputHandler as n}from"../../../input/InputHandler.js";import{resetTransformation as r,extractTransformation as o,isZeroTransformation as h}from"../../../navigation/gamepadAndKeyboardUtils.js";class l extends n{constructor(i){super(!0),this.view=i,this.frameTask=null,this.watchHandles=new t,this.currentDevice=null,this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.handle=this.registerIncoming("gamepad",(t=>this._handleGamePadEvent(t))),this.handle.pause()}onInstall(t){super.onInstall(t),this.watchHandles.add([a(this.view.navigation.gamepad,"enabled",(t=>{t?(this.handle.resume(),this.frameTask||(this.frameTask=i({update:t=>this._frameUpdate(t.deltaTime)}))):(this.handle.pause(),this.frameTask&&(this.frameTask.remove(),this.frameTask=null))}))])}onUninstall(){this.watchHandles.removeAll(),this.frameTask&&(this.frameTask.remove(),this.frameTask=null),super.onUninstall()}_handleGamePadEvent(t){const i=this.view.navigation.gamepad.device;i&&t.data.device!==i||this.currentDevice&&this.currentDevice!==t.data.device||("end"===t.data.action?(this.currentDevice=null,r(this.transformation)):(this.currentDevice=t.data.device,o(t.data,this.view.navigation.gamepad,this.transformation)))}_frameUpdate(t){const i=this.transformation;if(h(i))return;const a=this.view.viewpoint.clone(),n=this.view.navigation.gamepad.velocityFactor,r=m*n*t;e(a,a,[i.translation[0]*r,-i.translation[1]*r]);const o=1+i.translation[2]*c*t,l=this.view.constraints.rotationEnabled?-i.heading*d*t:0,v=this.view.size,p=[v[0]/2,v[1]];s(a,a,o,l,p,v);const f=this.view.constraints.constrain(a,this.view.viewpoint);this.view.viewpoint=f}}const d=.06,m=.7,c=6e-4;export{l as GamepadNavigation};
