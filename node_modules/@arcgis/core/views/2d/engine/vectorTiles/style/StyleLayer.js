/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{CapType as t}from"../../../../../symbols/cim/enums.js";import{ShaderProgramType as i}from"../enums.js";import{VTLBackgroundMaterial as e}from"../shaders/VTLBackgroundMaterial.js";import{VTLCircleMaterial as a}from"../shaders/VTLCircleMaterial.js";import{VTLFillMaterial as o,VTLOutlineMaterial as r}from"../shaders/VTLFillMaterial.js";import{VTLLineMaterial as s}from"../shaders/VTLLineMaterial.js";import{VTLIconMaterial as n,VTLTextMaterial as l}from"../shaders/VTLSymbolMaterial.js";import h from"./Filter.js";import{StyleLayerType as u,StyleDefinition as p,RotationAlignment as g}from"./StyleDefinition.js";import y from"./StyleProperty.js";import{THIN_LINE_HALF_WIDTH_THRESHOLD as D}from"../../webgl/definitions.js";class P{constructor(t,i,e,a){switch(this.type=t,this.typeName=i.type,this.id=i.id,this.source=i.source,this.sourceLayer=i["source-layer"],this.minzoom=i.minzoom,this.maxzoom=i.maxzoom,this.filter=i.filter,this.layout=i.layout,this.paint=i.paint,this.z=e,this.uid=a,t){case u.BACKGROUND:this._layoutDefinition=p.backgroundLayoutDefinition,this._paintDefinition=p.backgroundPaintDefinition;break;case u.FILL:this._layoutDefinition=p.fillLayoutDefinition,this._paintDefinition=p.fillPaintDefinition;break;case u.LINE:this._layoutDefinition=p.lineLayoutDefinition,this._paintDefinition=p.linePaintDefinition;break;case u.SYMBOL:this._layoutDefinition=p.symbolLayoutDefinition,this._paintDefinition=p.symbolPaintDefinition;break;case u.CIRCLE:this._layoutDefinition=p.circleLayoutDefinition,this._paintDefinition=p.circlePaintDefinition}this._layoutProperties=this._parseLayout(this.layout),this._paintProperties=this._parsePaint(this.paint)}getFeatureFilter(){return void 0!==this._featureFilter?this._featureFilter:this._featureFilter=h.createFilter(this.filter)}getLayoutProperty(t){return this._layoutProperties[t]}getPaintProperty(t){return this._paintProperties[t]}getLayoutValue(t,i,e){let a;const o=this._layoutProperties[t];return o&&(a=o.getValue(i,e)),void 0===a&&(a=this._layoutDefinition[t].default),a}getPaintValue(t,i,e){let a;const o=this._paintProperties[t];return o&&(a=o.getValue(i,e)),void 0===a&&(a=this._paintDefinition[t].default),a}isPainterDataDriven(){const t=this._paintProperties;if(t)for(const i in t)if(t[i].isDataDriven)return!0;return!1}_parseLayout(t){const i={};for(const e in t){const a=this._layoutDefinition[e];a&&(i[e]=new y(a,t[e]))}return i}_parsePaint(t){const i={};for(const e in t){const a=this._paintDefinition[e];a&&(i[e]=new y(a,t[e]))}return i}computeAttributesKey(t,i,e,a){let o=0,r=0;for(const s of i){let t=3;if(!s||s!==a){const i=e[s],{isLayout:a,isOptional:o}=i,r=a?this.getLayoutProperty(s):this.getPaintProperty(s);t=null!=r&&r.interpolator?2:null!=r&&r.isDataDriven?1:o&&!r?3:0}r|=t<<o,o+=2}return r<<3|t}}class c extends P{constructor(t,a,o,r){super(t,a,o,r),this.backgroundMaterial=new e(this.computeAttributesKey(i.BACKGROUND,e.ATTRIBUTES,e.ATTRIBUTES_INFO))}}class f extends P{constructor(t,e,a,s){super(t,e,a,s);const n=this.getPaintProperty("fill-color"),l=this.getPaintProperty("fill-opacity"),h=this.getPaintProperty("fill-pattern");this.hasDataDrivenColor=null==n?void 0:n.isDataDriven,this.hasDataDrivenOpacity=null==l?void 0:l.isDataDriven,this.hasDataDrivenFill=this.hasDataDrivenColor||this.hasDataDrivenOpacity||(null==h?void 0:h.isDataDriven);const u=this.getPaintProperty("fill-outline-color");this.outlineUsesFillColor=!u,this.hasDataDrivenOutlineColor=null==u?void 0:u.isDataDriven,this.hasDataDrivenOutline=u?u.isDataDriven:!!n&&n.isDataDriven,this.hasDataDrivenOutline=(u?this.hasDataDrivenOutlineColor:this.hasDataDrivenColor)||this.hasDataDrivenOpacity,this.fillMaterial=new o(this.computeAttributesKey(i.FILL,o.ATTRIBUTES,o.ATTRIBUTES_INFO)),this.outlineMaterial=new r(this.computeAttributesKey(i.OUTLINE,this.outlineUsesFillColor?r.ATTRIBUTES_FILL:r.ATTRIBUTES_OUTLINE,this.outlineUsesFillColor?r.ATTRIBUTES_INFO_FILL:r.ATTRIBUTES_INFO_OUTLINE),this.outlineUsesFillColor)}}class d extends P{constructor(t,e,a,o){var r,n,l,h,u,p,g,y,P;super(t,e,a,o);const c=this.getPaintProperty("line-pattern");if(this.lineMaterial=new s(this.computeAttributesKey(i.LINE,s.ATTRIBUTES,s.ATTRIBUTES_INFO,c?"line-dasharray":"")),this.hasDataDrivenLine=(null==(r=this.getPaintProperty("line-blur"))?void 0:r.isDataDriven)||(null==(n=this.getPaintProperty("line-color"))?void 0:n.isDataDriven)||(null==(l=this.getPaintProperty("line-gap-width"))?void 0:l.isDataDriven)||(null==(h=this.getPaintProperty("line-offset"))?void 0:h.isDataDriven)||(null==(u=this.getPaintProperty("line-opacity"))?void 0:u.isDataDriven)||(null==(p=this.getPaintProperty("line-pattern"))?void 0:p.isDataDriven)||(null==(g=this.getPaintProperty("line-dasharray"))?void 0:g.isDataDriven)||(null==(y=this.getLayoutProperty("line-cap"))?void 0:y.isDataDriven)||(null==(P=this.getPaintProperty("line-width"))?void 0:P.isDataDriven),this.canUseThinTessellation=!1,!this.hasDataDrivenLine){const t=this.getPaintProperty("line-width");if(!t||"number"==typeof t&&.5*t<D){const t=this.getPaintProperty("line-offset");(!t||"number"==typeof t&&0===t)&&(this.canUseThinTessellation=!0)}}}getDashKey(i,e){let a;switch(e){case t.BUTT:a="Butt";break;case t.ROUND:a="Round";break;case t.SQUARE:a="Square";break;default:a="Butt"}return`dasharray-[${i.toString()}]-${a}`}}class v extends P{constructor(t,e,a,o){var r,s,h,u,p,g,y,D,P,c,f,d;super(t,e,a,o),this.iconMaterial=new n(this.computeAttributesKey(i.ICON,n.ATTRIBUTES,n.ATTRIBUTES_INFO)),this.textMaterial=new l(this.computeAttributesKey(i.TEXT,l.ATTRIBUTES,l.ATTRIBUTES_INFO)),this.hasDataDrivenIcon=(null==(r=this.getPaintProperty("icon-color"))?void 0:r.isDataDriven)||(null==(s=this.getPaintProperty("icon-halo-blur"))?void 0:s.isDataDriven)||(null==(h=this.getPaintProperty("icon-halo-color"))?void 0:h.isDataDriven)||(null==(u=this.getPaintProperty("icon-halo-width"))?void 0:u.isDataDriven)||(null==(p=this.getPaintProperty("icon-opacity"))?void 0:p.isDataDriven)||(null==(g=this.getLayoutProperty("icon-size"))?void 0:g.isDataDriven),this.hasDataDrivenText=(null==(y=this.getPaintProperty("text-color"))?void 0:y.isDataDriven)||(null==(D=this.getPaintProperty("text-halo-blur"))?void 0:D.isDataDriven)||(null==(P=this.getPaintProperty("text-halo-color"))?void 0:P.isDataDriven)||(null==(c=this.getPaintProperty("text-halo-width"))?void 0:c.isDataDriven)||(null==(f=this.getPaintProperty("text-opacity"))?void 0:f.isDataDriven)||(null==(d=this.getLayoutProperty("text-size"))?void 0:d.isDataDriven)}}class _ extends P{constructor(t,e,o,r){super(t,e,o,r),this.circleMaterial=new a(this.computeAttributesKey(i.CIRCLE,a.ATTRIBUTES,a.ATTRIBUTES_INFO))}}class L{constructor(t,i,e){var a,o,r,s,n;let l;this.allowOverlap=t.getLayoutValue("icon-allow-overlap",i),this.ignorePlacement=t.getLayoutValue("icon-ignore-placement",i),this.keepUpright=t.getLayoutValue("icon-keep-upright",i),this.optional=t.getLayoutValue("icon-optional",i),this.rotationAlignment=t.getLayoutValue("icon-rotation-alignment",i),this.rotationAlignment===g.AUTO&&(this.rotationAlignment=e?g.MAP:g.VIEWPORT),l=t.getLayoutProperty("icon-anchor"),null!=(a=l)&&a.isDataDriven?this._anchorProp=l:this.anchor=t.getLayoutValue("icon-anchor",i),l=t.getLayoutProperty("icon-offset"),null!=(o=l)&&o.isDataDriven?this._offsetProp=l:this.offset=t.getLayoutValue("icon-offset",i),l=t.getLayoutProperty("icon-padding"),null!=(r=l)&&r.isDataDriven?this._paddingProp=l:this.padding=t.getLayoutValue("icon-padding",i),l=t.getLayoutProperty("icon-rotate"),null!=(s=l)&&s.isDataDriven?this._rotateProp=l:this.rotate=t.getLayoutValue("icon-rotate",i),l=t.getLayoutProperty("icon-size"),null!=(n=l)&&n.isDataDriven?this._sizeProp=l:this.size=t.getLayoutValue("icon-size",i)}update(t,i){this._anchorProp&&(this.anchor=this._anchorProp.getValue(t,i)),this._offsetProp&&(this.offset=this._offsetProp.getValue(t,i)),this._paddingProp&&(this.padding=this._paddingProp.getValue(t,i)),this._rotateProp&&(this.rotate=this._rotateProp.getValue(t,i)),this._sizeProp&&(this.size=this._sizeProp.getValue(t,i))}}class m{constructor(t,i,e){var a,o,r,s,n,l,h,u,p,y,D;let P;this.allowOverlap=t.getLayoutValue("text-allow-overlap",i),this.ignorePlacement=t.getLayoutValue("text-ignore-placement",i),this.keepUpright=t.getLayoutValue("text-keep-upright",i),this.optional=t.getLayoutValue("text-optional",i),this.rotationAlignment=t.getLayoutValue("text-rotation-alignment",i),this.rotationAlignment===g.AUTO&&(this.rotationAlignment=e?g.MAP:g.VIEWPORT),P=t.getLayoutProperty("text-anchor"),null!=(a=P)&&a.isDataDriven?this._anchorProp=P:this.anchor=t.getLayoutValue("text-anchor",i),P=t.getLayoutProperty("text-justify"),null!=(o=P)&&o.isDataDriven?this._justifyProp=P:this.justify=t.getLayoutValue("text-justify",i),P=t.getLayoutProperty("text-letter-spacing"),null!=(r=P)&&r.isDataDriven?this._letterSpacingProp=P:this.letterSpacing=t.getLayoutValue("text-letter-spacing",i),P=t.getLayoutProperty("text-line-height"),null!=(s=P)&&s.isDataDriven?this._lineHeightProp=P:this.lineHeight=t.getLayoutValue("text-line-height",i),P=t.getLayoutProperty("text-max-angle"),null!=(n=P)&&n.isDataDriven?this._maxAngleProp=P:this.maxAngle=t.getLayoutValue("text-max-angle",i),P=t.getLayoutProperty("text-max-width"),null!=(l=P)&&l.isDataDriven?this._maxWidthProp=P:this.maxWidth=t.getLayoutValue("text-max-width",i),P=t.getLayoutProperty("text-offset"),null!=(h=P)&&h.isDataDriven?this._offsetProp=P:this.offset=t.getLayoutValue("text-offset",i),P=t.getLayoutProperty("text-padding"),null!=(u=P)&&u.isDataDriven?this._paddingProp=P:this.padding=t.getLayoutValue("text-padding",i),P=t.getLayoutProperty("text-rotate"),null!=(p=P)&&p.isDataDriven?this._rotateProp=P:this.rotate=t.getLayoutValue("text-rotate",i),P=t.getLayoutProperty("text-size"),null!=(y=P)&&y.isDataDriven?this._sizeProp=P:this.size=t.getLayoutValue("text-size",i),P=t.getLayoutProperty("text-writing-mode"),null!=(D=P)&&D.isDataDriven?this._writingModeProp=P:this.writingMode=t.getLayoutValue("text-writing-mode",i)}update(t,i){this._anchorProp&&(this.anchor=this._anchorProp.getValue(t,i)),this._justifyProp&&(this.justify=this._justifyProp.getValue(t,i)),this._letterSpacingProp&&(this.letterSpacing=this._letterSpacingProp.getValue(t,i)),this._lineHeightProp&&(this.lineHeight=this._lineHeightProp.getValue(t,i)),this._maxAngleProp&&(this.maxAngle=this._maxAngleProp.getValue(t,i)),this._maxWidthProp&&(this.maxWidth=this._maxWidthProp.getValue(t,i)),this._offsetProp&&(this.offset=this._offsetProp.getValue(t,i)),this._paddingProp&&(this.padding=this._paddingProp.getValue(t,i)),this._rotateProp&&(this.rotate=this._rotateProp.getValue(t,i)),this._sizeProp&&(this.size=this._sizeProp.getValue(t,i)),this._writingModeProp&&(this.writingMode=this._writingModeProp.getValue(t,i))}}export{c as BackgroundStyleLayer,_ as CircleStyleLayer,f as FillStyleLayer,L as IconLayout,d as LineStyleLayer,P as StyleLayer,v as SymbolStyleLayer,m as TextLayout};
