/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{isSome as t}from"../../../../core/maybe.js";import{b as e,c as s,r as a,j as r,m as i}from"../../../../chunks/mat3.js";import{c as o}from"../../../../chunks/mat3f32.js";import{f as n}from"../../../../chunks/vec2f32.js";import{createVFMesh as l,createVFMeshScalar as c}from"../../../../layers/support/rasterFunctions/vectorFieldUtils.js";import{DisplayObject as h}from"../DisplayObject.js";import{createProgramDescriptor as m}from"../webgl/Utils.js";import{BufferObject as u}from"../../../webgl/BufferObject.js";import{Usage as d,DataType as v}from"../../../webgl/enums.js";import{VertexArrayObject as f}from"../../../webgl/VertexArrayObject.js";class _ extends h{constructor(t=null){super(),this._source=null,this._symbolizerParameters=null,this._vaoInvalidated=!0,this.coordScale=[1,1],this.height=null,this.stencilRef=0,this.resolution=null,this.pixelRatio=1,this.x=0,this.y=0,this.rotation=0,this.rawPixelData=null,this.width=null,this.source=t}destroy(){var e,s;t(this.vaoData)&&(null==(e=this.vaoData.magdir)||e.vao.dispose(),null==(s=this.vaoData.scalar)||s.vao.dispose(),this.vaoData=null)}get symbolizerParameters(){return this._symbolizerParameters}set symbolizerParameters(t){JSON.stringify(this._symbolizerParameters)!==JSON.stringify(t)&&(this._symbolizerParameters=t,this.invalidateVAO())}get source(){return this._source}set source(t){this._source=t,this.invalidateVAO()}invalidateVAO(){var e,s;!this._vaoInvalidated&&t(this.vaoData)&&(null==(e=this.vaoData.magdir)||e.vao.dispose(),null==(s=this.vaoData.scalar)||s.vao.dispose(),this.vaoData=null,this._vaoInvalidated=!0,this.requestRender())}updateVectorFieldVAO(e){if(this._vaoInvalidated){if(this._vaoInvalidated=!1,t(this.source)&&!t(this.vaoData)){const{style:t}=this.symbolizerParameters;switch(t){case"beaufort_ft":case"beaufort_km":case"beaufort_kn":case"beaufort_m":case"beaufort_mi":case"classified_arrow":case"ocean_current_kn":case"ocean_current_m":case"single_arrow":{const t=l(this.source,this.symbolizerParameters),s=this._createVectorFieldVAO(e.context,t);this.vaoData={magdir:s}}break;case"simple_scalar":{const t=c(this.source,this.symbolizerParameters),s=this._createVectorFieldVAO(e.context,t);this.vaoData={scalar:s}}break;case"wind_speed":{const t=l(this.source,this.symbolizerParameters),s=this._createVectorFieldVAO(e.context,t),a=c(this.source,this.symbolizerParameters),r=this._createVectorFieldVAO(e.context,a);this.vaoData={magdir:s,scalar:r}}}}this.ready(),this.requestRender()}}_createTransforms(){return{dvs:o()}}setTransform(t){const o=e(this.transforms.dvs),[l,c]=t.toScreenNoRotation([0,0],[this.x,this.y]),h=this.resolution/this.pixelRatio/t.resolution,m=h*this.width,u=h*this.height,d=Math.PI*this.rotation/180;s(o,o,n(l,c)),s(o,o,n(m/2,u/2)),a(o,o,-d),s(o,o,n(-m/2,-u/2)),r(o,o,n(m,u)),i(this.transforms.dvs,t.displayViewMat3,o)}onAttach(){this.invalidateVAO()}onDetach(){this.invalidateVAO()}_createVectorFieldVAO(t,e){const{vertexData:s,indexData:a}=e,r=u.createVertex(t,d.STATIC_DRAW,new Float32Array(s)),i=u.createIndex(t,d.STATIC_DRAW,new Uint32Array(a)),o=m("vector-field",{geometry:[{location:0,name:"a_pos",count:2,type:v.FLOAT,normalized:!1},{location:1,name:"a_offset",count:2,type:v.FLOAT,normalized:!1},{location:2,name:"a_vv",count:2,type:v.FLOAT,normalized:!1}]});return{vao:new f(t,o.attributes,o.bufferLayouts,{geometry:r},i),elementCount:a.length}}}export{_ as RasterVFDisplayObject};
