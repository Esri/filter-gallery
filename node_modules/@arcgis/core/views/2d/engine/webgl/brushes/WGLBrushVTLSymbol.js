/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isNone as e}from"../../../../../core/maybe.js";import{c as t,f as a}from"../../../../../chunks/vec2f32.js";import{FADE_DURATION as i}from"../../vectorTiles/decluttering/config.js";import{RotationAlignment as r,SymbolPlacement as s,TranslateAnchor as n}from"../../vectorTiles/style/StyleDefinition.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as o,VTL_TEXTURE_BINDING_UNIT_GLYPHS as l}from"../definitions.js";import{WGLDrawPhase as f}from"../enums.js";import{degToByte as c}from"../GeometryUtils.js";import{u32to4Xu8 as m}from"../number.js";import p from"./WGLBrush.js";import{TextureSamplingMode as u,CompareFunction as g,PrimitiveType as y,DataType as d}from"../../../../webgl/enums.js";const _=1/65536;class h extends p{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=t()}dispose(){}drawMany(e,t){const{drawPhase:a,styleLayerUID:i}=e,r=e.styleLayer;let s;a===f.HITTEST&&(s=m(i+1)),this._drawIcons(e,r,t,s),this._drawText(e,r,t,s)}_drawIcons(t,a,l,m){const{context:p,displayLevel:u,drawPhase:g,painter:y,spriteMosaic:d,state:_,styleLayerUID:h}=t,M=a.iconMaterial,P=y.vectorTilesMaterialManager;let T,U=!1;for(const e of l)if(e.layerData.has(h)&&(T=e.layerData.get(h),T.iconPerPageElementsMap.size>0)){U=!0;break}if(!U)return;const E=a.getPaintValue("icon-translate",u),x=a.getPaintValue("icon-translate-anchor",u);let v=a.getLayoutValue("icon-rotation-alignment",u);v===r.AUTO&&(v=a.getLayoutValue("symbol-placement",u)===s.POINT?r.VIEWPORT:r.MAP);const I=v===r.MAP,S=a.getLayoutValue("icon-keep-upright",u)&&I,D=T.isIconSDF,V=g===f.HITTEST,R=this._iconProgramOptions;R.id=V,R.sdf=D;const w=P.getMaterialProgram(p,M,R);p.useProgram(w),w.setUniformMatrix3fv("u_displayViewMat3",v===r.MAP?_.displayViewMat3:_.displayMat3),w.setUniformMatrix3fv("u_displayMat3",x===n.VIEWPORT?_.displayMat3:_.displayViewMat3),w.setUniform2fv("u_iconTranslation",E),w.setUniform1f("u_depth",a.z),w.setUniform1f("u_mapRotation",c(_.rotation)),w.setUniform1f("u_keepUpright",S?1:0),w.setUniform1f("u_level",10*u),w.setUniform1i("u_texture",o),w.setUniform1f("u_fadeDuration",i/1e3),V&&w.setUniform4fv("u_id",m);let A=-1;for(const i of l){if(!i.layerData.has(h))continue;if(i.key.level!==A&&(A=i.key.level,M.setDataUniforms(w,u,a,A,d)),T=i.layerData.get(h),0===T.iconPerPageElementsMap.size)continue;T.prepareForRendering(p),T.updateOpacityInfo();const r=T.iconVertexArrayObject;if(!e(r)){p.bindVAO(r),w.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),w.setUniform1f("u_time",(performance.now()-T.lastOpacityUpdate)/1e3);for(const[e,a]of T.iconPerPageElementsMap)this._renderIconRange(t,w,a,e,i)}}}_renderIconRange(e,t,a,i,r){const{context:s,spriteMosaic:n}=e;this._spritesTextureSize[0]=n.getWidth(i)/4,this._spritesTextureSize[1]=n.getHeight(i)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),n.bind(s,u.LINEAR,i,o),s.setStencilTestEnabled(!0),s.setStencilFunction(g.GREATER,255,255),s.setStencilWriteMask(0),s.drawElements(y.TRIANGLES,a[1],d.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),r.triangleCount+=a[1]/3}_drawText(t,o,m,p){const{context:u,displayLevel:y,drawPhase:d,glyphMosaic:h,painter:M,pixelRatio:P,spriteMosaic:T,state:U,styleLayerUID:E}=t,x=o.textMaterial,v=M.vectorTilesMaterialManager;let I,S=!1;for(const e of m)if(e.layerData.has(E)&&(I=e.layerData.get(E),I.glyphPerPageElementsMap.size>0)){S=!0;break}if(!S)return;const D=o.getPaintProperty("text-opacity");if(D&&!D.isDataDriven&&0===D.getValue(y))return;const V=o.getPaintProperty("text-color"),R=!V||V.isDataDriven||V.getValue(y)[3]>0,w=o.getPaintProperty("text-halo-width"),A=o.getPaintProperty("text-halo-color"),L=(!w||w.isDataDriven||w.getValue(y)>0)&&(!A||A.isDataDriven||A.getValue(y)[3]>0);if(!R&&!L)return;const O=24/8;let N=o.getLayoutValue("text-rotation-alignment",y);N===r.AUTO&&(N=o.getLayoutValue("symbol-placement",y)===s.POINT?r.VIEWPORT:r.MAP);const b=N===r.MAP,z=o.getLayoutValue("text-keep-upright",y)&&b,k=d===f.HITTEST,j=.8*O/P;this._glyphTextureSize||(this._glyphTextureSize=a(h.width/4,h.height/4));const G=o.getPaintValue("text-translate",y),W=o.getPaintValue("text-translate-anchor",y),F=this._sdfProgramOptions;F.id=k;const B=v.getMaterialProgram(u,x,F);u.useProgram(B),B.setUniformMatrix3fv("u_displayViewMat3",N===r.MAP?U.displayViewMat3:U.displayMat3),B.setUniformMatrix3fv("u_displayMat3",W===n.VIEWPORT?U.displayMat3:U.displayViewMat3),B.setUniform2fv("u_textTranslation",G),B.setUniform1f("u_depth",o.z+_),B.setUniform2fv("u_mosaicSize",this._glyphTextureSize),B.setUniform1f("u_mapRotation",c(U.rotation)),B.setUniform1f("u_keepUpright",z?1:0),B.setUniform1f("u_level",10*y),B.setUniform1i("u_texture",l),B.setUniform1f("u_antialiasingWidth",j),B.setUniform1f("u_fadeDuration",i/1e3),k&&B.setUniform4fv("u_id",p);let H=-1;for(const a of m){if(!a.layerData.has(E))continue;if(a.key.level!==H&&(H=a.key.level,x.setDataUniforms(B,y,o,H,T)),I=a.layerData.get(E),0===I.glyphPerPageElementsMap.size)continue;I.prepareForRendering(u),I.updateOpacityInfo();const t=I.textVertexArrayObject;if(e(t))continue;u.bindVAO(t),B.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs),u.setStencilTestEnabled(!0),u.setStencilFunction(g.GREATER,255,255),u.setStencilWriteMask(0);const i=(performance.now()-I.lastOpacityUpdate)/1e3;B.setUniform1f("u_time",i),I.glyphPerPageElementsMap.forEach(((e,t)=>{this._renderGlyphRange(u,e,t,h,B,L,R,a)}))}}_renderGlyphRange(e,t,a,i,r,s,n,o){i.bind(e,u.LINEAR,a,l),s&&(r.setUniform1f("u_halo",1),e.drawElements(y.TRIANGLES,t[1],d.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),o.triangleCount+=t[1]/3),n&&(r.setUniform1f("u_halo",0),e.drawElements(y.TRIANGLES,t[1],d.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),o.triangleCount+=t[1]/3)}}export{h as WGLBrushVTLSymbol};
