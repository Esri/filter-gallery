/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{nextPowerOfTwo as t}from"../../../../../core/mathUtils.js";import{isSome as r}from"../../../../../core/maybe.js";import{c as o}from"../../../../../chunks/mat3f32.js";import{f as e}from"../../../../../chunks/vec4f32.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as i,VTL_HIGH_RES_CUTOFF as s}from"../definitions.js";import{WGLDrawPhase as a}from"../enums.js";import{u32to4Xu8 as n}from"../number.js";import c from"./WGLBrush.js";import{BufferObject as m}from"../../../../webgl/BufferObject.js";import{TextureSamplingMode as f,CompareFunction as l,PrimitiveType as u,Usage as p}from"../../../../webgl/enums.js";import{VertexArrayObject as _}from"../../../../webgl/VertexArrayObject.js";class d extends c{constructor(){super(...arguments),this._color=e(1,0,0,1),this._patternMatrix=o(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(o,e){const{context:c,painter:m,styleLayerUID:p}=o;this._loadWGLResources(o);const _=o.displayLevel,d=o.styleLayer,h=d.backgroundMaterial,g=m.vectorTilesMaterialManager,v=d.getPaintValue("background-color",_),b=d.getPaintValue("background-opacity",_),y=d.getPaintValue("background-pattern",_),M=void 0!==y,x=v[3]*b,j=1|window.devicePixelRatio,U=o.spriteMosaic;let L,w;const A=j>s?2:1,P=o.drawPhase===a.HITTEST,I=this._programOptions;I.id=P,I.pattern=M;const k=g.getMaterialProgram(c,h,I);if(c.bindVAO(this._vao),c.useProgram(k),M){const t=U.getMosaicItemPosition(y,!0);if(r(t)){const{tl:o,br:e,page:s}=t;L=e[0]-o[0],w=e[1]-o[1];const a=U.getPageSize(s);r(a)&&(U.bind(c,f.LINEAR,s,i),k.setUniform4f("u_tlbr",o[0],o[1],e[0],e[1]),k.setUniform2fv("u_mosaicSize",a),k.setUniform1i("u_texture",i))}k.setUniform1f("u_opacity",b)}else this._color[0]=x*v[0],this._color[1]=x*v[1],this._color[2]=x*v[2],this._color[3]=x,k.setUniform4fv("u_color",this._color);if(k.setUniform1f("u_depth",d.z||0),P){const t=n(p+1);k.setUniform4fv("u_id",t)}for(const r of e){if(k.setUniform1f("u_coord_range",r.rangeX),k.setUniformMatrix3fv("u_dvsMat3",r.transforms.dvs),M){const o=Math.max(2**(Math.round(_)-r.key.level),1),e=A*r.width*o,i=e/t(L),s=e/t(w);this._patternMatrix[0]=i,this._patternMatrix[4]=s,k.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}c.setStencilFunction(l.EQUAL,r.stencilRef,255),c.drawArrays(u.TRIANGLE_STRIP,0,4)}}_loadWGLResources(t){if(this._vao)return;const{context:r,styleLayer:o}=t,e=o.backgroundMaterial,i=new Int8Array([0,0,1,0,0,1,1,1]),s=m.createVertex(r,p.STATIC_DRAW,i),a=new _(r,e.getAttributeLocations(),e.getLayoutInfo(),{geometry:s});this._vao=a}}export{d as WGLBrushVTLBackground};
