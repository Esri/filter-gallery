/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isSome as e,isNone as t}from"../../../../../core/maybe.js";import{TranslateAnchor as i}from"../../vectorTiles/style/StyleDefinition.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as n}from"../definitions.js";import{WGLDrawPhase as a}from"../enums.js";import{u32to4Xu8 as r}from"../number.js";import o from"./WGLBrush.js";import{TextureSamplingMode as s,CompareFunction as l,PrimitiveType as f,DataType as m}from"../../../../webgl/enums.js";class u extends o{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(o,u){const{context:c,displayLevel:p,state:d,drawPhase:g,painter:y,pixelRatio:E,spriteMosaic:v,styleLayerUID:M}=o;if(!u.some((e=>{var t,i;return null!=(t=null==(i=e.layerData.get(M))?void 0:i.lineIndexCount)&&t})))return;const _=o.styleLayer,U=_.lineMaterial,I=y.vectorTilesMaterialManager,P=_.getPaintValue("line-translate",p),x=_.getPaintValue("line-translate-anchor",p),T=_.getPaintProperty("line-pattern"),S=void 0!==T,D=S&&T.isDataDriven;let L,N;if(S&&!D){const e=T.getValue(p);L=v.getMosaicItemPosition(e)}let V=!1;if(!S){const e=_.getPaintProperty("line-dasharray");if(N=void 0!==e,V=N&&e.isDataDriven,N&&!V){const t=e.getValue(p),i=_.getDashKey(t,_.getLayoutValue("line-cap",p));L=v.getMosaicItemPosition(i)}}const R=1/E,h=g===a.HITTEST,A=this._programOptions;A.id=h,A.pattern=S,A.sdf=N;const j=I.getMaterialProgram(c,U,A);if(c.useProgram(j),j.setUniformMatrix3fv("u_displayViewMat3",d.displayViewMat3),j.setUniformMatrix3fv("u_displayMat3",x===i.VIEWPORT?d.displayMat3:d.displayViewMat3),j.setUniform2fv("u_lineTranslation",P),j.setUniform1f("u_depth",_.z),j.setUniform1f("u_antialiasing",R),h){const e=r(M+1);j.setUniform4fv("u_id",e)}if(L&&e(L)){const{page:t}=L,i=v.getPageSize(t);e(i)&&(v.bind(c,s.LINEAR,t,n),j.setUniform2fv("u_mosaicSize",i),j.setUniform1i("u_texture",n))}let w=-1;for(const i of u){if(!i.layerData.has(M))continue;i.key.level!==w&&(w=i.key.level,U.setDataUniforms(j,p,_,w,v));const a=2**(p-w)/E;j.setUniform1f("u_zoomFactor",a);const r=i.layerData.get(M);if(!r.lineIndexCount)continue;r.prepareForRendering(c);const o=r.lineVertexArrayObject;if(!t(o)){if(c.bindVAO(o),j.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),c.setStencilFunction(l.EQUAL,i.stencilRef,255),D||V){const t=r.patternMap;if(!t)continue;for(const[i,a]of t){const t=v.getPageSize(i);e(t)&&(v.bind(c,s.LINEAR,i,n),j.setUniform2fv("u_mosaicSize",t),j.setUniform1i("u_texture",n),c.drawElements(f.TRIANGLES,a[1],m.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]))}}else c.drawElements(f.TRIANGLES,r.lineIndexCount,m.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*r.lineIndexStart);i.triangleCount+=r.lineIndexCount/3}}}}export{u as WGLBrushVTLLine};
