/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isNone as e}from"../../../../../core/maybe.js";import{TranslateAnchor as t}from"../../vectorTiles/style/StyleDefinition.js";import{WGLDrawPhase as r}from"../enums.js";import{u32to4Xu8 as i}from"../number.js";import n from"./WGLBrush.js";import{CompareFunction as a,PrimitiveType as s,DataType as o}from"../../../../webgl/enums.js";class l extends n{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(n,l){const{context:c,displayLevel:m,requiredLevel:u,state:f,drawPhase:d,painter:p,spriteMosaic:y,styleLayerUID:v}=n;if(!l.some((e=>{var t,r;return null!=(t=null==(r=e.layerData.get(v))?void 0:r.circleIndexCount)&&t})))return;const g=n.styleLayer,E=g.circleMaterial,M=p.vectorTilesMaterialManager,T=1.2,x=g.getPaintValue("circle-translate",m),I=g.getPaintValue("circle-translate-anchor",m),U=d===r.HITTEST,_=this._programOptions;_.id=U;const h=M.getMaterialProgram(c,E,_);c.useProgram(h),h.setUniformMatrix3fv("u_displayMat3",I===t.VIEWPORT?f.displayMat3:f.displayViewMat3),h.setUniform2fv("u_circleTranslation",x),h.setUniform1f("u_depth",g.z),h.setUniform1f("u_antialiasingWidth",T);let L=-1;if(U){const e=i(v+1);h.setUniform4fv("u_id",e)}for(const t of l){if(!t.layerData.has(v))continue;t.key.level!==L&&(L=t.key.level,E.setDataUniforms(h,m,g,L,y));const r=t.layerData.get(v);if(!r.circleIndexCount)continue;r.prepareForRendering(c);const i=r.circleVertexArrayObject;e(i)||(c.bindVAO(i),h.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),u!==t.key.level?c.setStencilFunction(a.EQUAL,t.stencilRef,255):c.setStencilFunction(a.GREATER,255,255),c.drawElements(s.TRIANGLES,r.circleIndexCount,o.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*r.circleIndexStart),t.triangleCount+=r.circleIndexCount/3)}}}export{l as WGLBrushVTLCircle};
