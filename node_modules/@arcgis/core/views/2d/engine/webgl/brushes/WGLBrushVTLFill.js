/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isNone as t,isSome as e}from"../../../../../core/maybe.js";import{TranslateAnchor as i}from"../../vectorTiles/style/StyleDefinition.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as a,VTL_HIGH_RES_CUTOFF as n}from"../definitions.js";import{WGLDrawPhase as r}from"../enums.js";import{u32to4Xu8 as o}from"../number.js";import l from"./WGLBrush.js";import{TextureSamplingMode as s,CompareFunction as f,PrimitiveType as u,DataType as c}from"../../../../webgl/enums.js";const d=1/65536;class m extends l{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(t,e){const{displayLevel:i,drawPhase:a,renderPass:n,spriteMosaic:l,styleLayerUID:s}=t;let f=!1;for(const r of e)if(r.layerData.has(s)){const t=r.layerData.get(s);if(t.fillIndexCount>0||t.outlineIndexCount>0){f=!0;break}}if(!f)return;const u=t.styleLayer,c=u.getPaintProperty("fill-pattern"),d=void 0!==c,m=d&&c.isDataDriven;let p;if(d&&!m){const t=c.getValue(i);p=l.getMosaicItemPosition(t,!0)}const y=!d&&u.getPaintValue("fill-antialias",i);let g=!0,_=1;if(!d){const t=u.getPaintProperty("fill-color"),e=u.getPaintProperty("fill-opacity");if(!(null!=t&&t.isDataDriven||null!=e&&e.isDataDriven)){const t=u.getPaintValue("fill-color",i);_=u.getPaintValue("fill-opacity",i)*t[3],_>=1&&(g=!1)}}if(g&&"opaque"===n)return;let E;a===r.HITTEST&&(E=o(s+1));const M=u.getPaintValue("fill-translate",i),P=u.getPaintValue("fill-translate-anchor",i);(g||"translucent"!==n)&&this._drawFill(t,s,u,e,M,P,d,p,m,E);const v=!u.hasDataDrivenOutlineColor&&u.outlineUsesFillColor&&_<1;y&&"opaque"!==n&&!v&&this._drawOutline(t,s,u,e,M,P,E)}_drawFill(o,l,m,p,y,g,_,E,M,P){if(_&&!M&&t(E))return;const{context:v,displayLevel:I,state:T,drawPhase:U,painter:x,pixelRatio:h,spriteMosaic:D}=o,S=m.fillMaterial,N=x.vectorTilesMaterialManager,w=h>n?2:1,L=U===r.HITTEST,R=this._fillProgramOptions;R.id=L,R.pattern=_;const A=N.getMaterialProgram(v,S,R);if(v.useProgram(A),e(E)){const{page:t}=E,i=D.getPageSize(t);e(i)&&(D.bind(v,s.LINEAR,t,a),A.setUniform2fv("u_mosaicSize",i),A.setUniform1i("u_texture",a))}A.setUniformMatrix3fv("u_displayMat3",g===i.VIEWPORT?T.displayMat3:T.displayViewMat3),A.setUniform2fv("u_fillTranslation",y),A.setUniform1f("u_depth",m.z+d),L&&A.setUniform4fv("u_id",P);let V=-1;for(const i of p){if(!i.layerData.has(l))continue;i.key.level!==V&&(V=i.key.level,S.setDataUniforms(A,I,m,V,D));const n=i.layerData.get(l);if(!n.fillIndexCount)continue;n.prepareForRendering(v);const r=n.fillVertexArrayObject;if(!t(r)){if(v.bindVAO(r),A.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),v.setStencilFunction(f.EQUAL,i.stencilRef,255),_){const t=Math.max(2**(Math.round(I)-i.key.level),1),e=i.rangeX/(w*i.width*t);A.setUniform1f("u_patternFactor",e)}if(M){const t=n.patternMap;if(!t)continue;for(const[i,n]of t){const t=D.getPageSize(i);e(t)&&(D.bind(v,s.LINEAR,i,a),A.setUniform2fv("u_mosaicSize",t),A.setUniform1i("u_texture",a),v.drawElements(u.TRIANGLES,n[1],c.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n[0]))}}else v.drawElements(u.TRIANGLES,n.fillIndexCount,c.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n.fillIndexStart);i.triangleCount+=n.fillIndexCount/3}}}_drawOutline(e,a,n,o,l,s,m){const{context:p,displayLevel:y,state:g,drawPhase:_,painter:E,pixelRatio:M,spriteMosaic:P}=e,v=n.outlineMaterial,I=E.vectorTilesMaterialManager,T=.75/M,U=_===r.HITTEST,x=this._outlineProgramOptions;x.id=U;const h=I.getMaterialProgram(p,v,x);p.useProgram(h),h.setUniformMatrix3fv("u_displayMat3",s===i.VIEWPORT?g.displayMat3:g.displayViewMat3),h.setUniform2fv("u_fillTranslation",l),h.setUniform1f("u_depth",n.z+d),h.setUniform1f("u_outline_width",T),U&&h.setUniform4fv("u_id",m);let D=-1;for(const i of o){if(!i.layerData.has(a))continue;i.key.level!==D&&(D=i.key.level,v.setDataUniforms(h,y,n,D,P));const e=i.layerData.get(a);if(e.prepareForRendering(p),!e.outlineIndexCount)continue;const r=e.outlineVertexArrayObject;t(r)||(p.bindVAO(r),h.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),p.setStencilFunction(f.EQUAL,i.stencilRef,255),p.drawElements(u.TRIANGLES,e.outlineIndexCount,c.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e.outlineIndexStart),i.triangleCount+=e.outlineIndexCount/3)}}}export{m as WGLBrushVTLFill};
