/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import r from"../../../../core/Accessor.js";import{property as s}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as t}from"../../../../core/accessorSupport/decorators/subclass.js";import{QueueProcessor as o}from"../../../support/QueueProcessor.js";function n(e){return e.some((e=>e.globalId))}function a(e){return e.filter((e=>!e.error)).map((e=>{var r;return null!=(r=e.objectId)?r:e.globalId}))}function d(e,r){const s=new Set(e);for(const t of r.values())s.add(t);return s}function i(e,r){const s=new Set(e);for(const t of r.values())s.delete(t);return s}let u=class extends r{constructor(e){super(e),this._hasGlobalIds=!1}normalizeCtorArgs(e){return this._queueProcessor=new o({concurrency:1,process:e.process}),{}}destroy(){this.clear()}get updating(){return this._queueProcessor.length>0}clear(){this._queueProcessor.clear()}push(e){const r=this._queueProcessor,s=r.last();switch(e.type){case"update":case"refresh":if((null==s?void 0:s.type)===e.type)return;r.push(e).finally((()=>this.notifyChange("updating")));break;case"edit":{const t="processed-edit"===(null==s?void 0:s.type)?s:null;t&&r.popLast();const o=this._mergeEdits(t,e);for(const e of o)r.push(e).finally((()=>this.notifyChange("updating")));break}}this.notifyChange("updating")}_mergeEdits(e,r){var s,t;const{addedFeatures:o,deletedFeatures:u,updatedFeatures:c}=r.edits;if(this._hasGlobalIds=this._hasGlobalIds||n(o)||n(c)||n(u),this._hasGlobalIds){return[e,{type:"processed-edit",edits:{addOrModified:[...o,...c],removed:u}}]}const l=new Set(a(null!=(s=null==e?void 0:e.edits.addOrModified)?s:[])),p=new Set(a(null!=(t=null==e?void 0:e.edits.removed)?t:[])),f=new Set([...a(o),...a(c)]),h=new Set(a(u));return[{type:"processed-edit",edits:{addOrModified:Array.from(d(i(l,h),f)).map((e=>({objectId:e}))),removed:Array.from(d(i(p,f),h)).map((e=>({objectId:e})))}}]}};e([s({readOnly:!0})],u.prototype,"updating",null),u=e([t("esri.views.2d.layers.support.FeatureCommandQueue")],u);const c=u;export{c as default};
