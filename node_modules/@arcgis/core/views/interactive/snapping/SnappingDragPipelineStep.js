/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isNone as e,abortMaybe as t,isSome as n}from"../../../core/maybe.js";import{createTask as r}from"../../../core/promiseUtils.js";import{pointEquals as a}from"../../../layers/graphics/dehydratedFeatureComparison.js";import{EventPipeline as o}from"../dragEventPipeline.js";import{SnappingContext as i}from"./SnappingContext.js";import{TaskPriority as s,ImmediateTask as p}from"../../support/Scheduler.js";class c{constructor(){this.next=new o}createSnapDragEventPipelineStep({predicate:c=(()=>!0),cancel:l,snappingManager:d,snappingContext:m,updatingHandles:u}){if(e(d))return e=>e;let x=null,y=null;const f=()=>{x=t(x),d.doneSnapping(),n(y)&&y.frameTask.remove(),y=null};return l.next((e=>(f(),e))),this.next=new o,e=>{if(!c(e))return e;if(x=t(x),"start"===e.action){const t="3d"===d.view.type?d.view.resourceController.scheduler.registerTask(s.SNAPPING):p;y={context:new i({editGeometryOperations:m.editGeometryOperations,elevationInfo:m.elevationInfo,pointer:m.pointer,vertexHandle:n(e.info)?e.info.handle:null,excludeFeature:m.excludeFeature,visualizer:m.visualizer}),originalPos:n(e.snapOrigin)?m.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,frameTask:t}}if(n(y)){const t=y.context.coordinateHelper.vectorToDehydratedPoint(y.context.coordinateHelper.arrayToVector([y.originalPos.x,y.originalPos.y,y.originalPos.z]));t.x+=e.mapEnd.x-e.mapStart.x,t.y+=e.mapEnd.y-e.mapStart.y;const n=e.mapStart.x-y.originalPos.x,o=e.mapStart.y-y.originalPos.y,i={...e,action:"udpate"},s=y.context,p=d.update(t,y.context);if(e.mapEnd.x=p.x+n,e.mapEnd.y=p.y+o,"end"!==e.action){const e=y.frameTask;x=r((async r=>{const c=await e.schedule((()=>d.snap(t,s,r)),r);if(c.valid){const t=await e.schedule((()=>c.apply()),r);a(t,p)||(i.mapEnd.x=t.x+n,i.mapEnd.y=t.y+o,this.next.execute(i))}})),u.addPromise(x.promise)}}return"end"===e.action&&f(),e}}}export{c as SnappingPipeline};
