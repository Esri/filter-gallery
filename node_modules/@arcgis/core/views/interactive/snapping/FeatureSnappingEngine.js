/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import{HandleOwner as t}from"../../../core/HandleOwner.js";import r from"../../../core/Handles.js";import{someMap as o}from"../../../core/MapUtils.js";import{isSome as i,unwrap as n,isNone as a}from"../../../core/maybe.js";import{eachAlwaysValues as s,throwIfAborted as c}from"../../../core/promiseUtils.js";import{sync as u}from"../../../core/reactiveUtils.js";import{init as l}from"../../../core/watchUtils.js";import{property as d}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as p}from"../../../core/accessorSupport/decorators/subclass.js";import{c as h}from"../../../chunks/vec3f64.js";import{SnappingTypes as g}from"../../../layers/graphics/data/QueryEngineResult.js";import{RayConstraint as y}from"./SnappingConstraint.js";import{sortCandidatesInPlace as f,anyMapPointToRender as S,anyMapPointToScreenPoint as m}from"./snappingUtils.js";import{EdgeSnappingCandidate as v}from"./candidates/EdgeSnappingCandidate.js";import{FeatureSnappingCandidate as w}from"./candidates/FeatureSnappingCandidate.js";import{RightAngleSnappingCandidate as _,OtherVertexType as j}from"./candidates/RightAngleSnappingCandidate.js";let x=class extends t{constructor(e){super(e),this.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}}}get updating(){return o(this.snappingSources,(({snappingSource:e})=>e.updating))||this.updatingHandles.updating}get snappingSources(){var e;const t=this._get("snappingSources")||new Map,r=new Map;if(null!=(e=this.options)&&e.featureSources)for(const o of this.options.featureSources.items){const e=o.layer.uid,n=t.get(e);if(n){t.delete(e),r.set(e,n);continue}if(!o.layer.loaded){this.updatingHandles.addPromise(o.layer.load());continue}const a=this._createSourceInfo(o);i(a)&&r.set(e,a)}for(const[,o]of t)o.destroy();return r}initialize(){this.updatingHandles.add((()=>this.snappingSources),(()=>this.notifyChange("updating")),u),i(this.view)&&this.handles.add([this.view.on("layerview-create",(e=>this._updateLayerView(e.layer,e.layerView))),this.view.on("layerview-destroy",(e=>this._updateLayerView(e.layer,null)))])}_updateLayerView(e,t){for(const[,r]of this.snappingSources)r.snappingSource.layerSource.layer===e&&(r.layerView=t)}destroy(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()}async fetchCandidates(e,t,r){if(!this.options.effectiveFeatureEnabled)return[];const o=[],n=this._computeScreeenSizeDistanceParameters(e,t),a={distance:n,point:e,coordinateHelper:t.coordinateHelper,types:this.types,filter:null};for(const[,{snappingSource:s,layerView:c}]of this.snappingSources)!s.layerSource.enabled||i(c)&&c.suspended||o.push(s.fetchCandidates(a,r).then((e=>e.filter((e=>!this._candidateIsExcluded(s,e,t.excludeFeature))))));const u=(await s(o)).flat();return this._addRightAngleCandidates(u,e,n,t),c(r),f(e,u),u}_addRightAngleCandidates(e,t,r,o){var a,s,c,u,l,d,p,h;const g=i(o.vertexHandle)?null==(a=o.vertexHandle.rightEdge)||null==(s=a.rightVertex)?void 0:s.pos:i(o.editGeometryOperations)&&"polygon"===o.editGeometryOperations.data.type?null==(c=n(null==(u=o.editGeometryOperations.data.components[0])?void 0:u.getFirstVertex()))?void 0:c.pos:null,y=i(o.vertexHandle)?null==(l=o.vertexHandle.leftEdge)||null==(d=l.leftVertex)?void 0:d.pos:i(o.editGeometryOperations)?null==(p=n(null==(h=o.editGeometryOperations.data.components[0])?void 0:h.getLastVertex()))?void 0:p.pos:null,f=e.length;for(let i=0;i<f;i++)this._addRightAngleCandidate(e[i],y,t,r,o,e),this._addRightAngleCandidate(e[i],g,t,r,o,e)}_addRightAngleCandidate(e,t,r,o,i,n){if(a(t)||!(e instanceof v))return;const s=e.constraint.closestTo(t),c=(s[0]-r[0])/o.x,u=(s[1]-r[1])/o.y;if(c*c+u*u<=1){const r=i.coordinateHelper;n.push(new _({coordinateHelper:r,targetPoint:s,otherVertex:t,otherVertexType:j.NEXT,previousVertex:e.constraint.start,constraint:new y(r,t,s),objectId:e.objectId}))}}_computeScreeenSizeDistanceParameters(e,t){const r=this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1);return a(this.view)?{x:r,y:r}:"2d"===this.view.type?{x:r*this.view.resolution,y:r*this.view.resolution}:this._computeScreeenSizeDistanceParameters3D(e,r,this.view,t)}_computeScreeenSizeDistanceParameters3D(e,t,r,o){const{coordinateHelper:i,elevationInfo:n}=o,a=r.state.camera.computeScreenPixelSizeAt(S(e,i,n,r,H))*r.renderCoordsHelper.unitInMeters/r.mapCoordsHelper.unitInMeters,s=t*a;return{x:s/this._computeScreenMagnitudeOfMapOffset(e,a,0,r,o),y:s/this._computeScreenMagnitudeOfMapOffset(e,0,a,r,o)}}_computeScreenMagnitudeOfMapOffset(e,t,r,o,{coordinateHelper:i,elevationInfo:n}){const a=i.clone(e);a[0]+=t,a[1]+=r;const s=m(e,i,n,o),c=m(a,i,n,o),u=c.x-s.x,l=c.y-s.y;return Math.sqrt(u*u+l*l)}get types(){return g.EDGE|g.VERTEX}_candidateIsExcluded(e,t,r){if(a(r))return!1;const o=this._getCandidateObjectId(t);if(a(o))return!1;const i=e.layerSource.layer;return"graphics"===i.type?r.uid===o:r.sourceLayer===i&&(!(!r.attributes||!("objectIdField"in i))&&r.attributes[i.objectIdField]===o)}_getCandidateObjectId(e){return e instanceof w?e.objectId:null}_createSourceInfo(e){const t=this._createFeatureSnappingSourceType(e);if(a(t))return null;if("loading"in t)return this.updatingHandles.addPromise(t.loading.then((()=>{this.destroyed||this.notifyChange("snappingSources")}))),null;const r=i(this.view)?this.view.allLayerViews.find((t=>t.layer===e.layer)):null;return new C(t.source,r)}_createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e)}return null}_createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source.type){case"feature-layer":{const t=this._getSourceModule("featureService");return i(t.module)?{source:new t.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}case"memory":case"csv":case"geojson":case"wfs":{if("mesh"===e.layer.geometryType)return null;const t=this._getSourceModule("featureCollection");return i(t.module)?{source:new t.module.FeatureCollectionSnappingSource({layerSource:e})}:{loading:t.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(e){const t=this._getSourceModule("graphics");return i(t.module)?{source:new t.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}_getSourceModule(e){const t=this.sourceModules[e];if(a(t.loader)){const r=this._loadSourceModule(e).then((e=>{t.module=e}));return t.loader=r,{module:t.module,loader:r}}return{module:t.module,loader:t.loader}}_loadSourceModule(e){switch(e){case"featureService":return this.updatingHandles.addPromise(import("./featureSources/FeatureServiceSnappingSource.js"));case"featureCollection":return this.updatingHandles.addPromise(import("./featureSources/FeatureCollectionSnappingSource.js"));case"graphics":return this.updatingHandles.addPromise(import("./featureSources/GraphicsSnappingSource.js"))}return null}};e([d({constructOnly:!0})],x.prototype,"spatialReference",void 0),e([d({constructOnly:!0})],x.prototype,"view",void 0),e([d()],x.prototype,"options",void 0),e([d({readOnly:!0})],x.prototype,"updating",null),e([d({readOnly:!0})],x.prototype,"snappingSources",null),x=e([p("esri.views.interactive.snapping.FeatureSnappingEngine")],x);class C{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new r;const o=this.snappingSource.layerSource.layer;if("refresh"in o){const t=o;this.handles.add(t.on("refresh",(()=>e.refresh())))}this.handles.add([l(e,"updating",(t=>e.layerSource.updating=t),!0),l(e,"availability",(t=>e.layerSource.availability=t),!0)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}const H=h();export{x as FeatureSnappingEngine};
