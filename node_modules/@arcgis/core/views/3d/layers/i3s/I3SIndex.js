/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isSome as e,isNone as t,unwrap as i}from"../../../../core/maybe.js";import s from"../../../../core/PooledArray.js";import{isAbortError as r}from"../../../../core/promiseUtils.js";import{l as n}from"../../../../chunks/vec3.js";import{d as o}from"../../../../chunks/vec4f64.js";import{LodMetric as a,NodeBase as d,Node as l,NodeFilterImpact as h,NodeIMModificationImpact as u,NodeTraversalState as c}from"./I3SNode.js";import{addWraparound as g}from"./I3SUtil.js";import{clone as _}from"../../support/orientedBoundingBox.js";class m{constructor(e,t,i,s,r){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=s,this.node=r,this.useAsHole=0,this.filterImpact=h.NotChecked}}class f{constructor(e,t,i,r,n,o,d,l,h,u,c,g,_,m){this.streamDataController=i,this.viewportQueries=r,this.logger=n,this.holeFilling=o,this._isLoaded=d,this._isReloading=l,this._isSelected=h,this._enable=u,this._needsUpdate=c,this._canRequest=g,this._computeVisibilityObb=_,this._computeNodeFiltering=m,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=a.None,this._lodConversion=e=>e,this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=P(0),this._visibilityCacheVersion=P(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new s({deallocator:null}),this._prefetch=new s({deallocator:null}),this._updates=new b(this._missing),this._imModificationUncategorized=new s({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=[],this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=e,e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=`${e.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this._init(t)}_init(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=a.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this.lodMetric=a.MaxScreenThreshold,this._lodConversion=L}this._addPage(C(this.rootIndex,this.nodesPerPage),e.rootPage),this._updateParentsAndLevel()}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this._makeRefNode(new d(e.rootNode.id,null),-1);const t=this._validateNode(e.rootNode.id,e.rootNode);t&&this._addNode(t,0)}}_loadPage(e){this._loading.add(e);const t=this.urlPrefix+e;this.streamDataController.request(t,"json").then((t=>{this._pageQueue.push({pageIndex:e,page:t})})).catch((t=>{this._loading.delete(e),r(t)||(this._failedPages.add(e),this.logger.error("#loadPage()",this.logLayer,`Error when loading page ${e}`,t))}))}_addQueuedPages(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:i}=this._pageQueue.shift();this._addPage(t,i),this._loading.delete(t),e.madeProgress()}this._updateParentsAndLevel()}_addPage(e,t){for(let n=this._nodePages.length;n<e;n++)this._nodePages[n]=null;const i=[],s=[],r=t.nodes.map(((t,r)=>{const a=i.length,d=t.children?t.children.length:0;s.push(-1);for(let e=0;e<d;e++)i.push(t.children[e]);const h=`${t.index}`,u=_(t.obb),c=o([u.center[0],u.center[1],u.center[2],n(u.halfSize)]),g=t.mesh&&t.mesh.attribute,f=t.mesh&&t.mesh.geometry,v=t.mesh&&t.mesh.material,b={hasSharedResource:!1,hasFeatureData:!!f,attributes:g&&null!=g.resource?`${g.resource}`:null,geometry:f&&null!=f.resource?`${f.resource}`:null,texture:v&&null!=v.resource?`${v.resource}`:null,geometryDefinition:f?f.definition:-1,materialDefinition:v?v.definition:-1},p=new l(h,e*this.nodesPerPage+r,c,d,0,b,this.lastUpdate,this.lodMetric,this._lodConversion(t.lodThreshold),f?f.featureCount:null);return p.serviceObb=u,p.visibilityObb=this._computeVisibilityObb(p),p.vertexCount=f?f.vertexCount:0,new m(a,d,y(this._visibilityCacheVersion),null,p)}));this._nodePages[e]={nodes:r,children:i,parents:s},this.nodeCount+=r.length}_updateParentsAndLevel(){const t=new Array,i=(i,s,r)=>{const n=this._getPage(i);if(e(n)){const o=w(i,this.nodesPerPage);n.parents[o]=s;const a=n.nodes[o].node;e(a)&&(a.level=r,t.push(i))}};for(i(this.rootIndex,-1,0);t.length;){const s=t.pop(),r=this.getNode(s);if(e(r))for(let e=0;e<r.childCount;e++){i(this.getChildIndex(r,e),s,r.level+1),this._maxLevel=Math.max(this._maxLevel,r.level+1)}}}_getPage(e){return this._nodePages[C(e,this.nodesPerPage)]}_getNodeInternal(e){const i=this._getPage(e);return t(i)?null:i.nodes[w(e,this.nodesPerPage)]}_addNode(t,s){null!=t.children&&this.populateChildren(s,t.children);const r=this.getParent(s),n=e(r)?r.level+1:0;this._maxLevel=Math.max(this._maxLevel,t.children?n+1:n);const{lodMetric:a,maxError:d}=S(t.lodSelection),h=i(this._getNodeInternal(s));return h.node=new l(t.id,s,o(t.mbs),h.childCount,n,t.resources,t.version,a,d,t.numFeatures),t.obb&&(h.node.serviceObb=_(t.obb)),h.node.visibilityObb=this._computeVisibilityObb(h.node),e(h.ref)&&(null==h.ref.mbs&&(h.ref.mbs=t.mbs),h.node.renderMbs=h.ref.renderMbs,h.node.serviceObbInRenderSR=h.ref.serviceObbInRenderSR,h.ref.visibilityObb=h.node.visibilityObb),h.node}_makeRefNode(t,i){const s=this._nodePages[0],r=s.nodes.length;return s.nodes.push(new m(0,0,y(this._visibilityCacheVersion),t,null)),this.nodeCount++,s.parents.push(i),t.renderMbs[3]=-1,e(t.serviceObbInRenderSR)&&(t.serviceObbInRenderSR.halfSize[0]=-1),r}populateChildren(e,t){const s=i(this._getNodeInternal(e)),r=i(this._getPage(e));s.childOffset=r.children.length,s.childCount=t.length;for(let i=0;i<t.length;i++){const s=this._makeRefNode(t[i],e);r.children.push(s)}}getNode(t){const i=this._getNodeInternal(t);return e(i)?i.node:null}getIndexById(t){let i;return this._forAllNodes(((s,r)=>{(e(s.node)&&s.node.id===t||e(s.ref)&&s.ref.id===t)&&(i=r)})),i}getNodeById(e){const t=this.getIndexById(e);return t>=0?this.getNode(t):null}getChildIndex(e,i){const s=this._getPage(e.index);if(t(s))return-1;const r=s.nodes[w(e.index,this.nodesPerPage)];return s.children[r.childOffset+i]}getParentIndex(t){const i=this._getPage(t);return e(i)?i.parents[w(t,this.nodesPerPage)]:-1}getParent(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}isLeaf(t){const i=this._getNodeInternal(t);return e(i)&&0===i.childCount}get rootNode(){return this.getNode(this.rootIndex)}get size(){return this.nodeCount}invalidateVisibilityCache(){this._visibilityCacheVersion=P(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(t){const i=this._getNodeInternal(t);e(i)&&this.invalidateNodeVisibilityCacheInternal(i)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=y(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(t){const i=this._getNodeInternal(t);e(i)&&(p(i),this.invalidateNodeVisibilityCacheInternal(i))}invalidateGeometryVisibility(t){const i=this._getNodeInternal(t);e(i)&&e(i.node)&&(i.node.geometryObb=null,i.node.renderMbs[3]=-1,e(i.node.serviceObbInRenderSR)&&(i.node.serviceObbInRenderSR.halfSize[0]=-1))}invalidateVisibilityObbs(){t(this.rootNode)||this.traverse(this.rootNode,(e=>(e.visibilityObb=this._computeVisibilityObb(e),e.geometryObb=null,!0)))}isNodeVisible(i){const s=this._getNodeInternal(i);if(t(s)||e(s.ref)&&!s.ref.mbs)return!0;if(!x(s.visibilityCache,this._visibilityCacheVersion)){const i=s.node,r=e(i)&&(t(s.ref)||e(i.visibilityObb))?i:e(s.ref)?s.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(e(i)||e(s.ref))&&s.filterImpact===h.NotChecked){const t=e(i)?i.mbs:e(s.ref)?s.ref.mbs:null;s.filterImpact=null!=t?this._computeNodeFiltering(t):h.Unmodified}const n=e(i)&&s.filterImpact===h.Culled,o=!(e(i)&&i.imModificationImpact===u.Culled)&&(!r||this.viewportQueries.isNodeVisible(r))&&!n;return s.visibilityCache=N(o,this._visibilityCacheVersion),o}return I(s.visibilityCache)}isGeometryVisible(t){if(!this.isNodeVisible(t))return!1;const i=this._getNodeInternal(t);return!(e(i)&&e(i.node)&&e(i.node.geometryObb)&&(!this.layerHasModifications||i.node.imModificationImpact!==u.NotChecked))||this.viewportQueries.isGeometryVisible(i.node)}_traverseCoverage(s,r,n,o,a){const d=this._getPage(s);if(t(d)||0===r.childCount)return;const l=r.childOffset+r.childCount,h=new Array;for(let t=r.childOffset;t<l;++t){const i=d.children[t],s=this._getNodeInternal(i);e(s)&&e(s.node)&&this.isGeometryVisible(i)&&h.push(s)}o/=h.length;for(const e of h){const t=i(e.node).index;this._isLoaded(t)||this._isReloading(t)?(a.delta=Math.max(a.delta,n),a.coverage+=o):this._traverseCoverage(t,e,n+1,o,a)}}useNodeAsHole(e){if("off"===this.holeFilling)return!1;const i=this._getNodeInternal(e);if(t(i))return!1;if("always"===this.holeFilling)return!0;if(x(i.useAsHole,this._version))return I(i.useAsHole);const s={delta:0,coverage:0};this._traverseCoverage(e,i,0,1,s);const r=s.delta*s.coverage<=.5;return i.useAsHole=N(r,this._version),r}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=P(this._version)}imModificationsChanged(t){this.layerHasModifications=t,this._forAllNodes((({node:t})=>{e(t)&&(t.imModificationImpact=u.NotChecked,t.visibilityObb=this._computeVisibilityObb(t),t.hasModifications&&this.invalidateGeometryVisibility(t.index))})),this.invalidateVisibilityCache()}layerFilterChanged(t){this._layerHasFilter=t,this._forAllNodes((t=>{if(e(t)){t.filterImpact=h.NotChecked;const i=t.node;e(i)&&this.invalidateNodeVisibilityCache(i.index)}})),this.invalidateVisibilityCache()}update(s,r,n){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(r),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(s),v.clear();let o=!0;const a=new O,d=new O,l=this._imModificationUncategorized;l.clear();const h=new Set,c=(c,g,_)=>{if(t(g)){let e=this._entryPriority(c);e===1/0&&(e=this._entryPriority(_));const t=C(c,this.nodesPerPage);return v.set(t,Math.max(e,v.get(t)||0)),this._loading.has(t)||this._failedPages.has(t)||this._missing.push(t),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const m=g.node;if(this._updateNodeFeatureEstimate(m,d),t(m)){const e=this._entryPriority(c);return this._loading.has(c)||this._failedNodes.has(c)||(this._missing.push(c),v.set(c,e)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e))}const f=i(this._getPage(c));if(0===this._missing.length&&0===this.nodesPerPage)for(let t=0;t<g.childCount;t++){const i=f.children[g.childOffset+t],s=this._getNodeInternal(i);!e(s)||s.node||this._loading.has(i)||this._failedNodes.has(i)||(v.set(i,this._entryPriority(i)),this._prefetch.push(i))}if(m.failed)return;if(h.add(m.id),this._isLoaded(c)){if(a.known+=m.memory,++a.knownNodes,this._isSelected(m)?g.childCount>0&&(o=!1):(a.unremoved+=m.memory,o=!1),this._needsUpdate(m)){const e=this._entryPriority(c);v.set(c,e),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,e),this._updates.update.push(c)}return}if(m.memory&&(a.known+=m.memory,++a.knownNodes),!this._isSelected(m))return void(this._isReloading(c)&&this._updates.remove.push(c));if(g.childCount>0&&(o=!1),m.memory?(a.missing+=m.memory,a.known+=m.memory,++a.knownNodes):++a.missingNodes,s.indexOf(m.index)>=0)return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(c)),void(this._updates.cancel=this._updates.cancel.filter((e=>e!==m.index)));if(!r.done&&this._enable(m))return void r.madeProgress();const b=this._entryPriority(c);v.set(c,b),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,b),this._updates.add.push(c),this.layerHasModifications&&n&&e(m)&&m.imModificationImpact===u.NotChecked&&l.push(c)};this.traverseVisible(c);const g=this._updates.add;g.length>0&&this.layerHasModifications&&(l.length>0&&n(l),g.filterInPlace((e=>{const i=this._getNodeInternal(e),s=t(i)||t(i.node)||i.node.imModificationImpact!==u.Culled;return s||this.invalidateNodeVisibilityCache(e),s}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(d),this._featureEstimate.leavesReached=o,this._missing.sort(((e,t)=>e-t)),this._missing.filterInPlace(((e,t)=>t<1||this._missing.data[t-1]!==e)),this._missing.sort(((e,t)=>v.get(e)-v.get(t))),this._missing.length>0&&(this._maxUnloadedPrio=v.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((e=>v.get(e)>=this._maxUnloadedPrio)).sort(((e,t)=>v.get(e)-v.get(t))),this._updates.update.sort(((e,t)=>v.get(e)-v.get(t))),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,v.clear()}checkFeatureTarget(e,t){const i=this.viewportQueries.updateScreenSpaceErrorBias(t);let s=t,r=t,n=i,o=10;for(;o--;){const i=new O;this._updateFeatureEstimate(s,i);if(this._computeFeatureEstimate(i)<=e){if(s>=t||i.missingNodes>0||0===o)break;n=s,s=.5*(s+r)}else r=s,s=.5*(s+n)}return this._version=P(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,s)}_updateFeatureEstimate(t,i){this._version=P(this._version),this.viewportQueries.updateScreenSpaceErrorBias(t),this.traverseVisible(((t,s)=>this._updateNodeFeatureEstimate(e(s)&&s.node,i)))}_updateNodeFeatureEstimate(i,s){if(!(t(i)||i.failed||t(i.numFeatures)))return this._isLoaded(i.index)?(s.known+=i.numFeatures,++s.knownNodes,void(this._isSelected(i)||(s.unremoved+=i.numFeatures))):void(this._isSelected(i)&&(e(i.numFeatures)?(s.missing+=i.numFeatures,s.known+=i.numFeatures,++s.knownNodes):++s.missingNodes))}_computeFeatureEstimate(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missing)}prefetch(){return this._prefetch.sort(((e,t)=>v.get(e)-v.get(t))),this._load(this._prefetch)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this._loadPage(e.pop());return!0}isLoading(){return this._indexMissing>0}getIndexLoading(){return this._loading.size}getIndexMissing(){return this._indexMissing}getUnloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}nodeTraversalState(e){if(t(e))return null;let i=this._nodeTraversalState.get(e.index);if(i&&x(i.version,this._version))return i;const s=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e);let n=!0;if(r){const t=this.getParentIndex(e.index);if(t>=0){const e=this._nodeTraversalState.get(t);n=e&&s>e.lodLevel}else n=s>0}else n=0===e.childCount;return i?(i.lodLevel=s,i.isChosen=n,i.version=N(!0,this._version),i):(i=new c(r,n,s,N(!0,this._version)),this._nodeTraversalState.set(e.index,i),i)}_loadNode(e){this._loading.add(e);const s=i(this._getNodeInternal(e)).ref;if(t(s))return void this._failedNodes.add(e);const n=s.id,o=this.urlPrefix+n,a=()=>{this._loading.delete(e),0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this.streamDataController.request(o,"json").then((t=>{a();const i=this._validateNode(n,t);if(null==i)return;i.obb&&this.invalidateNodeVisibilityCache(e);const s=this._addNode(i,e);this.nodeTraversalState(s)}),(t=>{a(),r(t)||(this.logger.error("#loadNode()",this.logLayer,"Error loading node: "+o),this._failedNodes.add(e))}))}_validateNode(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,`Invalid shared resource href on node "${e}"`),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,`Invalid geometry data on node "${e}"`),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some(((e,t)=>e.href!==`./attributes/f_${t}/0`))||this.logger.warn("#validateNode()",this.logLayer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const i=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,s=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,r=t=>{if(null==t)return null;const i=t=>this.logger.error("#validateNode()",this.logLayer,`Invalid node reference on node ${e}: ${t}`);if("number"==typeof t.id)i(`id ${t.id} is a number instead of a string.`);else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i(`Invalid bounding volume on reference ${t.id}.`),null;t.href&&t.href!=="../"+t.id&&this.logger.error("#validateNode()",this.logLayer,`Invalid node href on node "${e}"`);const s=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,r=new d(`${t.id}`,t.mbs);return r.serviceObb=s,r.visibilityObb=this._computeVisibilityObb(r),r},n=Array.isArray(t.children)?t.children.map(r).filter((e=>null!=e)):null;return{id:e,mbs:t.mbs,obb:i,children:n,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:s}}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((t=>{e(t.node)&&(t.node.failed=!1)}))}_entryPriority(i){const s=this._getNodeInternal(i),r=this.getParentIndex(i);if(t(s)||r<0&&null==s.node)return r<0?1/0:this._entryPriority(r);let n=0;if(s.node&&r>=0){const e=this._nodeTraversalState.get(r);null!=e&&(n=e.lodLevel)}let o=this.progressiveLoadPenalty;for(let e=i;e>=0;e=this.getParentIndex(e))if(this._isLoaded(e)){o=0;break}const a=e(s.ref)?this.viewportQueries.distToPOI(s.ref):e(s.node)?this.viewportQueries.distToPOI(s.node):0;return-a-n*(a+this.progressiveLoadPenalty)+o}traverseVisible(e){const i=this._getNodeInternal(this.rootIndex);t(i)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,i,e)}_traverseVisible(t,s,r,n){if(r.node&&0===r.childCount)return void(this.isGeometryVisible(t)&&n(t,r,s));if(!this.isNodeVisible(t))return;if(n(t,r,s),null==r.node)return;const o=this.nodeTraversalState(r.node);if(o.nodeHasLOD&&o.lodLevel===this._maxLodLevel)return;const a=i(this._getPage(t));for(let i=0;i<r.childCount;i++){const s=a.children[r.childOffset+i],o=this._getNodeInternal(s);e(o)?this._traverseVisible(s,t,o,n):n(s,null,t)}}traverse(e,t){t(e)&&this.traverseChildren(e,t)}traverseChildren(t,i){const s=t.index,r=this._getNodeInternal(s);e(r)&&this._traverseChildren(s,r,i)}_traverseChildren(i,s,r){const n=this._getPage(i);if(t(n))return;const o=s.childOffset+s.childCount;for(let t=s.childOffset;t<o;++t){const i=n.children[t],s=this._getNodeInternal(i);e(s)&&e(s.node)&&r(s.node)&&this._traverseChildren(i,s,r)}}updateStats(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||this._prefetch.length),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){const t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}getPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}updateElevationInfo(e){this._forAllNodes(p),this.viewportQueries.updateElevationInfo(e)}_forAllNodes(e){for(let t=0;t<this._nodePages.length;t++){const i=this._nodePages[t];if(i){const s=t*this.nodesPerPage;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t],s+t)}}}get test(){return{addNode:(e,t)=>this._addNode(e,t)}}}const v=new Map;class b{constructor(e){this.missing=e,this.update=new s({deallocator:null}),this.add=new s({deallocator:null}),this.remove=new s({deallocator:null}),this.cancel=[]}reset(e){this.add.clear(),this.update.clear(),this.cancel=e}}function p(t){e(t.node)&&(t.node.renderMbs[3]=-1,e(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1)),e(t.ref)&&(t.ref.renderMbs[3]=-1,e(t.ref.serviceObbInRenderSR)&&(t.ref.serviceObbInRenderSR.halfSize[0]=-1))}function y(e){return g(e,-2)}function P(e){return g(e,2)}function N(e,t){return t+(e?1:0)}function x(e,t){return(-2&e)===t}function I(e){return 1==(1&e)}function C(e,t){return 0===t?0:e/t|0}function w(e,t){return 0===t?e:e%t}const M=[["maxScreenThreshold",a.MaxScreenThreshold],["screenSpaceRelative",a.ScreenSpaceRelative],["removedFeatureDiameter",a.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",a.DistanceRangeFromDefaultCamera]];function S(e){if(e)for(let t=0;t<e.length;t++)for(const i of M)if(i[0]===e[t].metricType)return{lodMetric:i[1],maxError:e[t].maxError};return{lodMetric:a.None,maxError:0}}class O{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function L(e){return Math.sqrt(e*(4/Math.PI))}export{f as I3SIndex,S as selectErrorMetric};
