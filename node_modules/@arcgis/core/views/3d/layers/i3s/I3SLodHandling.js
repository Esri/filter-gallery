/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isNone as e,isSome as i}from"../../../../core/maybe.js";import o from"../../../../core/PooledArray.js";import{NodeState as s}from"./I3SNode.js";import{FadeDirection as t}from"../support/I3SLayerView.js";class d{constructor(e){this.layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,i,o,s){this._maxLodLevel=s.maxLodLevel,this._index=o,this._isNodeInScaleBounds=e,this._removeNodes=i}shouldLoadNode(i){if(e(i))return!1;const o=this._index.nodeTraversalState(i);return!!this._isChosenMaxLOD(o)||!!o.isChosen&&this._childrenRequireLoading(i)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const i=this.layerView.view.resourceController.memoryController.usedMemory,o=Math.max(0,Math.floor(10*(i-1)));r.clear(),this._lodGlobalHandling(this._index.rootNode,o,!1);const s=r.length;this._removeNodes(r,e);const t=r.length<s;return 0!==r.length&&(this._lodGlobalDirty=!0),r.clear(),t}_lodGlobalHandling(o,d,l){if(e(o))return!1;const n=o.index,a=this._index,h=this.layerView,u=a.nodeTraversalState(o),_=this._isChosenMaxLOD(u),c=h.isNodeLoaded(n),x=h.nodeCrossfadingEnabled;if(x&&c&&_){const e=!l&&this.hasNoVisibleChildren(o);h.fadeNode(n,t.FadeIn,!e)}const L=c&&(!h.isNodeFullyFadedIn||h.isNodeFullyFadedIn(n));if(c&&(h.updateNodeState(n,_?s.Leaf:s.Hole),_))return L&&this._removeChildrenRecursive(o),L;const N=o.childCount>0;let m=N;if(N)for(let e=0;e<o.childCount;e++){const s=a.getChildIndex(o,e),t=a.getNode(s);if(i(t)){!(!a.isGeometryVisible(s)||this._lodGlobalHandling(t,d,l||L))&&this._isNodeInScaleBounds(t)&&(m=!1)}else a.isNodeVisible(s)&&(m=!1)}const y=c&&!_&&(m||r.length<d);y&&r.push(n),!x||y||!c||l||m||h.fadeNode(n,t.FadeIn,!1);const b=!o.resources.hasFeatureData;return m||L&&!y||b}_removeChildrenRecursive(e){this._index.traverseChildren(e,(e=>((this.layerView.isNodeLoaded(e.index)||this.layerView.isNodeReloading(e.index))&&r.push(e.index),!0)))}hasNoVisibleChildren(e){let i=!0;return this._index.traverseChildren(e,(e=>!(!i||!this._index.isNodeVisible(e.index))&&(!this.layerView.isNodeLoaded(e.index)||(i=!1,!1)))),i}_childrenRequireLoading(e){let i=!1,o=!0;return this._index.traverseChildren(e,(e=>{if(!o||!this._index.isNodeVisible(e.index))return!1;const s=this._index.nodeTraversalState(e);return this._isChosenMaxLOD(s)&&this._index.isGeometryVisible(e.index)&&(i=!0),!this.layerView.isNodeLoaded(e.index)||(o=!1,!1)})),o&&i}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}const r=new o({deallocator:null});export{d as default};
