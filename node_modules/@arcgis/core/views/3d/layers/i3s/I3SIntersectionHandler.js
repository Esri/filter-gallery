/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{intersectLine as r}from"../../support/orientedBoundingBox.js";import{newIntersectorResult as i}from"../../webgl-engine/lib/Intersector.js";import{IntersectorType as t,StoreResults as s}from"../../webgl-engine/lib/IntersectorInterfaces.js";import{getVerticalOffsetI3S as n}from"../../webgl-engine/lib/verticalOffsetUtils.js";class o{constructor(e){this.type=t.I3S,this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this.collection=e.collection,this.traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}intersect(t,o,d,c){const a=t.results,b=t.options.store===s.ALL,u=t.ray.direction,m=t.tolerance;let y=e=>e,p=e=>e;const h=n(t.verticalOffset);e(h)&&(y=e=>h.applyToMbs(e),p=e=>h.applyToObb(e)),this.traverseNodeHierarchy(((s,n)=>!(e(s.serviceObbInRenderSR)&&!r(p(s.serviceObbInRenderSR),d,u,m))&&(!n||e(s.geometryObb)&&!r(p(s.geometryObb),d,u,m)||!e(s.serviceObbInRenderSR)&&!l(y(s.renderMbs),d,u,m)||this.collection.intersect(n,d,c,m,h,((e,r,n,l)=>{if(r>=0){if(null!=o&&!o(d,c,r))return;const u=i=>{const t={layerUid:this.layerUid,sublayerUid:this.sublayerUid,nodeIndex:s.index,componentIndex:e,triangleNr:l};i.set(this.type,t,r,n)};if(this.isGround&&(null==a.ground.dist||r<a.ground.dist)&&u(a.ground),t.options.isFiltered)return;if((null==a.min.dist||r<a.min.dist)&&u(a.min),(null==a.max.dist||r>a.max.dist)&&u(a.max),b){const e=i(t.ray);u(e),t.results.all.push(e)}}})),!0)))}}function l(e,r,i,t=0){const s=e[3]+t,n=r[0]-e[0],o=r[1]-e[1],l=r[2]-e[2],d=i[0],c=i[1],a=i[2],b=d*n+c*o+a*l;return b*b-(d*d+c*c+a*a)*(n*n+o*o+l*l-s*s)>=0}export{o as I3SIntersectionHandler};
