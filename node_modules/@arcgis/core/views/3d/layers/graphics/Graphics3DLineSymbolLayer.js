/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import"../../../../geometry.js";import e from"../../../../core/Error.js";import{applySome as t,isNone as r,isSome as i,releaseMaybe as a,unwrapOr as s,get as n,unwrap as o}from"../../../../core/maybe.js";import{px2pt as l,pt2px as h}from"../../../../core/screenUtils.js";import{I as p}from"../../../../chunks/mat4f64.js";import{s as m}from"../../../../chunks/vec4.js";import{b as c,f as d}from"../../../../chunks/vec4f64.js";import{create as y,empty as _,expandWithBuffer as u,intersectsClippingArea as f,expandWithAABB as g}from"../../../../geometry/support/aaBoundingBox.js";import{getDriverAxisSizeValueAny as M}from"../../../../renderers/support/renderingInfoUtils.js";import{sharedGeometryElevationAligner as b}from"./ElevationAligners.js";import{SymbolUpdateType as v,elevationModeChangeUpdateType as E,needsElevationUpdates2D as P}from"./elevationAlignmentUtils.js";import{ElevationContext as w}from"./ElevationContext.js";import L from"./Graphics3DDrapedGraphicLayer.js";import{Graphics3DObject3DGraphicLayer as x}from"./Graphics3DObject3DGraphicLayer.js";import{Graphics3DSymbolLayer as D,getAttributeValue as S}from"./Graphics3DSymbolLayer.js";import{ApplyRendererDiffResult as C}from"./interfaces.js";import{parseCapType as k,geometryToRenderInfo as R,RemoveDuplicateStartEnd as U,createGeometry as A,geometryToRenderInfoDraped as j}from"./lineUtils.js";import{initFastSymbolUpdatesState as z,updateFastSymbolUpdatesState as O}from"../support/FastSymbolUpdates.js";import{prepareMarkerResources as G}from"../support/markerUtils.js";import V from"../../support/debugFlags.js";import{Object3D as T}from"../../webgl-engine/lib/Object3D.js";import{RenderGeometry as F}from"../../webgl-engine/lib/RenderGeometry.js";import{LineMarkerMaterial as I}from"../../webgl-engine/materials/LineMarkerMaterial.js";import{getStipplePatternForLinePattern as W}from"../../webgl-engine/materials/lineStippleUtils.js";import{RibbonLineMaterial as B}from"../../webgl-engine/materials/RibbonLineMaterial.js";import H from"../../../../geometry/Extent.js";import N from"../../../../geometry/Polygon.js";const q=["polyline","polygon","extent"];class K extends D{constructor(e,t,r,i){super(e,t,r,i),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=z(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const t=null!=this.symbolLayer.size?this.symbolLayer.size:l(1);if(t<0)throw new e("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=t}this._markerTexture=G(this._context.sharedResources.textures,this.symbolLayer.marker)}_getMaterialParameters(e,r=!1){var i;const a=t(this.symbolLayer.marker,(e=>e.color)),s=t(this.symbolLayer.material,(e=>e.color)),n=this._getCombinedOpacityAndColor(r&&a||s);this._patternHidesLine&&!r&&(n[3]=0);const o=n[3],l={width:this._computeMaterialWidth(null==(i=this.symbolLayer)?void 0:i.size),color:n,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:k(this.symbolLayer.cap||"butt"),transparent:o<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:W(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?{...l,...this._fastUpdates.materialParameters}:l}get lineMaterial(){return r(this._lineMaterial)&&(this._lineMaterial=new B(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return r(this._ringMaterial)&&(this._ringMaterial=new B(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}get wireframeLineMaterial(){return r(this._wireframeLineMaterial)&&(this._wireframeLineMaterial=new B({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterial)),this._wireframeLineMaterial}get wireframeRingMaterial(){return r(this._wireframeRingMaterial)&&(this._wireframeRingMaterial=new B({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterial)),this._wireframeRingMaterial}get markerMaterial(){return r(this._markerMaterial)&&i(this.symbolLayer.marker)&&i(this._markerTexture)&&(this._markerMaterial=new I({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterial)),this._markerMaterial}destroy(){super.destroy(),this._forEachMaterial((e=>this._context.stage.remove(e))),this._lineMaterial=null,this._ringMaterial=null,this._wireframeLineMaterial=null,this._wireframeRingMaterial=null,this._markerMaterial=null,this._markerTexture=a(this._markerTexture)}_getDrivenSize(e){return this._drivenProperties.size&&e.size?h(M(e.size)):1}_getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?S(this._fastUpdates.visualVariables.size.field,e):null}_getDrivenColor(e){const t=d(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}_getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?S(this._fastUpdates.visualVariables.color.field,e):null}_getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?S(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,q,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new w);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,r,t.uid)}applyRendererDiff(e,t){for(const r in e.diff){if("visualVariables"!==r)return C.Recreate_Symbol;if(!O(this._fastUpdates,t,this._vvConvertOptions))return C.Recreate_Symbol;this._forEachMaterial((e=>e.setParameters(this._fastUpdates.materialParameters)))}return C.Fast_Update}prepareSymbolLayerPatch(e){var t,r;if("partial"!==e.diff.type)return;const i=e.diff.diff,a={};"complete"===(null==(t=i.size)?void 0:t.type)&&(a.width=this._computeMaterialWidth(i.size.newValue),delete i.size),"complete"===(null==(r=i.cap)?void 0:r.type)&&(a.cap=k(s(i.cap.newValue,"butt")),delete i.cap);const n=this._prepareMarkerPatch(e,i);this._prepareMaterialPatch(e,i,n),e.symbolLayerStatePatches.push((()=>this._forEachMaterial((e=>e.setParameters(a)))))}layerOpacityChanged(){return this._forEachMaterial(((e,t)=>this._updateMaterialLayerOpacity(e,t))),!0}_forEachMaterial(e){i(this._lineMaterial)&&e(this._lineMaterial),i(this._ringMaterial)&&e(this._ringMaterial),i(this._wireframeLineMaterial)&&e(this._wireframeLineMaterial),i(this._wireframeRingMaterial)&&e(this._wireframeRingMaterial),i(this._markerMaterial)&&e(this._markerMaterial,!0)}_updateMaterialLayerOpacity(e,t=!1){const r=e.parameters.color,i=n(this.symbolLayer,"material","color"),a=this._patternHidesLine&&!t?0:this._getCombinedOpacity(i),s=a<1||this.needsDrivenTransparentPass,o=[r[0],r[1],r[2],a];e.setParameters({color:o,transparent:s})}layerElevationInfoChanged(e,t,r){const i=this._elevationContext.mode,a=E(K.elevationModeChangeTypes,r,i);if(a!==v.UPDATE)return a;const s=P(i);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))}slicePlaneEnabledChanged(){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};return this._forEachMaterial((t=>t.setParameters(e))),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof H)return N.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,r){const a=e.graphic,s=this._getGeometryAsPolygonOrPolyline(a.geometry),n="polygon"===s.type?s.rings:s.paths,o=new Array,l=new Array,h=new Array,m=y(),c=R(s,this._context.elevationProvider,this._context.renderCoordsHelper,t),d="polygon"===s.type?"rings":"paths";this._logGeometryCreationWarnings(c,n,d,"LineSymbol3DLayer");for(let y=0;y<c.lines.length;y++){const{position:t,mapPosition:r}=c.lines[y];if(i(this._context.clippingExtent)&&(_(m),u(m,r),!f(m,this._context.clippingExtent)))continue;const a=this._createGeometry(e,t,r,s.type,J.ELEVATED);o.push(a),l.push("polygon"===s.type?this.ringMaterial:this.lineMaterial),h.push(p),V.LINE_WIREFRAMES&&(o.push(a.cloneShallow()),l.push("polygon"===s.type?this.wireframeRingMaterial:this.wireframeLineMaterial),h.push(p));const n=this.markerMaterial;i(n)&&(o.push(a.cloneShallow()),l.push(n),h.push(p))}if(0===o.length)return null;const g=new T({geometries:o,materials:l,transformations:h,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),M=new x(this,g,o,null,null,b,t);return M.alignedSampledElevation=c.sampledElevation,M.needsElevationUpdates=P(t.mode),M}_createGeometry(e,t,r,i,a){const s="polygon"===i?U.REMOVE:U.KEEP,n=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,o=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return A({overlayInfo:a===J.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:s,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:r,size:o?null:this._getDrivenSize(e.renderingInfo),color:n?null:this._getDrivenColor(e.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(e.graphic),colorFeature:this._getColorFeatureAttributeData(e.graphic),opacityFeature:this._getOpacityFeatureAttributeData(e.graphic)}})}_createAsOverlay(e,t){const r=e.graphic,a=this._getGeometryAsPolygonOrPolyline(r.geometry),s="polygon"===a.type?a.rings:a.paths,n="polygon"===a.type?this.ringMaterial:this.lineMaterial;n.renderPriority=this._renderPriority;const l=V.LINE_WIREFRAMES?"polygon"===a.type?this.wireframeRingMaterial:this.wireframeLineMaterial:null,h=this.markerMaterial;i(l)&&(l.renderPriority=this._renderPriority-.001),i(h)&&(h.renderPriority=this._renderPriority-.002);const p=new Array,m=y(),c=_(),d=j(a,this._context.overlaySR),M="polygon"===a.type?"rings":"paths";this._logGeometryCreationWarnings(d,s,M,"LineSymbol3DLayer");for(const y of d.lines){if(_(m),u(m,y.position),!f(m,this._context.clippingExtent))continue;g(c,m);const s=this._createGeometry(e,y.position,null,a.type,J.DRAPED),d=e=>{const i=new F(s,e,{layerUid:t,graphicUid:r.uid});return p.push(i),i};if(i(h)){const e=d(h),t=o(this.symbolLayer.marker).placement;"begin"!==t&&"begin-end"!==t||u(m,y.position,0,1),"end"!==t&&"begin-end"!==t||u(m,y.position,y.position.length-3,1),this._updateBoundingSphere(e,m)}const M=d(n);if(this._updateBoundingSphere(M,m),V.LINE_WIREFRAMES){const e=d(l);this._updateBoundingSphere(e,m)}}return new L(this,p,c)}_updateBoundingSphere(e,t){m(e.boundingSphere,.5*(t[0]+t[3]),.5*(t[1]+t[4]),0,.5*Math.sqrt((t[3]-t[0])*(t[3]-t[0])+(t[4]-t[1])*(t[4]-t[1])))}get _patternHidesLine(){const e=this.symbolLayer.pattern;return i(e)&&"style"===e.type&&"none"===e.style}_computeMaterialWidth(e){return e=s(e,l(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?h(1):1:h(e)}_prepareMaterialPatch(e,i,a){const s=i.material;if(r(s)||"collection"===s.type)return;const n="complete"===s.type?t(s.newValue,(e=>e.color)):"complete"===s.diff.color.type?s.diff.color.newValue:null,o=this._getCombinedOpacityAndColor(n);a&&this._patchMaterialColor(c(o),this._markerMaterial,e),this._patternHidesLine&&(o[3]=0),this._patchMaterialColor(o,this._lineMaterial,e),delete i.material}_prepareMarkerPatch(e,t){const a=t.marker;if(r(a)||"partial"!==a.type||i(a.diff.style)||i(a.diff.placement)||i(a.diff.color)&&"complete"!==a.diff.color.type)return!1;const s=a.diff.color;if(r(s))return delete t.marker,r(this.symbolLayer)||r(this.symbolLayer.marker)||r(this.symbolLayer.marker.color);const n=o(s.newValue);return r(n)?(delete t.marker,!0):(this._patchMaterialColor(this._getCombinedOpacityAndColor(n),this._markerMaterial,e),delete t.marker,!1)}_patchMaterialColor(e,t,i){if(r(t))return;const a=e[3];i.symbolLayerStatePatches.push((()=>t.setParameters({color:e,transparent:a<1||this.needsDrivenTransparentPass})))}}var J;K.elevationModeChangeTypes={definedChanged:v.RECREATE,staysOnTheGround:v.NONE,onTheGroundChanged:v.RECREATE},function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED"}(J||(J={}));export{K as Graphics3DLineSymbolLayer,K as default};
