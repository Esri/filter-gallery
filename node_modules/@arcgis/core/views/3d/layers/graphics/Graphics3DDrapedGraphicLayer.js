/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{s as t}from"../../../../chunks/vec3.js";import{c as r}from"../../../../chunks/vec3f64.js";import{create as i,empty as s,expandWithRect as o,center as n,set as a,toRect as d}from"../../../../geometry/support/aaBoundingBox.js";import{create as h}from"../../../../geometry/support/aaBoundingRect.js";import{demResolutionForBoundingBox as c}from"./graphicUtils.js";import{Object3DState as g}from"../../webgl-engine/lib/basicInterfaces.js";import{ModelDirty as m}from"../../webgl-engine/lib/ModelDirtyTypes.js";class l{constructor(e,t,r){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=r,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._graphicsCoreOwner=null,this.isElevationSource=!1}initialize(e,t,r){this.stage=e,this._graphicsCoreOwner=r,this._overlayRenderer=this._graphicsCoreOwner.view.basemapTerrain.overlayManager.renderer}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._graphicsCoreOwner,m.Geometry.ADD);if(e||this._addedToStage){for(const e of this.renderGeometries)e.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._graphicsCoreOwner,m.State.VISIBILITIES)}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._graphicsCoreOwner,m.Geometry.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=r()){return t(e,0,0,0)}getBoundingBoxObjectSpace(e=i()){return s(e)}addObjectState(e,t){e===g.Highlight&&(this.renderGeometries.forEach((e=>{const r=e.addHighlight();t.addRenderGeometry(e,r,this)})),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._graphicsCoreOwner))}removeObjectState(e){this.renderGeometries.forEach((t=>{e.removeRenderGeometry(t)}))}removeRenderGeometryObjectState(e,t){e.removeHighlight(t),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._graphicsCoreOwner)}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.computeAttachmentOrigin(_)&&(e.draped.origin[0]+=_[0],e.draped.origin[1]+=_[1],e.draped.num++)}async getProjectedBoundingBox(t,r,i,a,d){s(d);for(let e=0;e<this.renderGeometries.length;e++){const r=this.renderGeometries[e];this._getRenderGeometryProjectedBoundingRect(r,t,p,i),o(d,p)}if(r){let t;n(d,_);const i=c(d,r);try{t=await r.service.queryElevation(_[0],_[1],a,i,"ground")}catch(h){}e(t)&&(d[2]=Math.min(d[2],t),d[5]=Math.max(d[5],t))}return d}_getRenderGeometryProjectedBoundingRect(e,t,r,i){if(this.boundingBox)a(u,this.boundingBox);else{const t=e.boundingSphere,r=t[3];u[0]=t[0]-r,u[1]=t[1]-r,u[2]=t[2]-r,u[3]=t[0]+r,u[4]=t[1]+r,u[5]=t[2]+r}return t(u,0,2),this.calculateRelativeScreenBounds&&i.push({location:n(u),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),d(u,r)}}const p=h(),u=i(),_=r();export{l as default};
