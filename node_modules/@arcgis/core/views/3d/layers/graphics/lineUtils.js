/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{isNone as t,isSome as e,unwrapOr as o}from"../../../../core/maybe.js";import{slice as n}from"../../../../core/typedArrayUtil.js";import{d as r}from"../../../../chunks/vec2.js";import{s as i}from"../../../../chunks/vec3.js";import{c as s}from"../../../../chunks/vec3f64.js";import{projectBuffer as a,lonLatToWebMercatorComparable as u}from"../../../../geometry/projection.js";import{getReferenceEllipsoid as c}from"../../../../geometry/projectionEllipsoid.js";import{CounterClockwiseMode as l,pathsToTriangulationInfo as p}from"../../../../geometry/support/triangulationUtils.js";import{ViewingMode as f}from"../../../ViewingMode.js";import{WHITE_UNIT as m}from"./constants.js";import{applyPerVertexElevationAlignment as E}from"./elevationAlignmentUtils.js";import{DRAPED_Z as h}from"../../terrain/OverlayRenderer.js";import{PrimitiveType as T}from"../../webgl-engine/lib/basicInterfaces.js";import{Geometry as g}from"../../webgl-engine/lib/Geometry.js";import{VertexAttribute as y}from"../../webgl-engine/lib/VertexAttribute.js";import{C as A}from"../../../../chunks/RibbonLine.glsl.js";function O(t){const e=[],o=[];d(t,o,e);const n=o[0][1].data,r=e[0][1].length,i=new Uint16Array(r);return j(t,o,e),S(t,o,e,i),w(t,o,e,i),U(t,o,e,i),F(t,o,e,i),v(t,o,e,i),C(t,o,e,n),new g(o,e,T.Line)}function R(t,e,o,n){const r="polygon"===t.type?l.CCW_IS_HOLE:l.NONE,i="polygon"===t.type?t.rings:t.paths,{position:s,outlines:a}=p(i,t.hasZ,r),u=new Float64Array(s.length),c=E(s,t.spatialReference,0,u,0,s,0,s.length/3,e,o,n),f=null!=c;return{lines:f?b(a,s,u):[],projectionSuccess:f,sampledElevation:c}}function b(t,e,o){const n=new Array;for(const{index:r,count:i}of t){if(i<=1)continue;const t=3*r,s=t+3*i;n.push({position:e.subarray(t,s),mapPosition:o?o.subarray(t,s):void 0})}return n}function I(t,e){const o="polygon"===t.type?l.CCW_IS_HOLE:l.NONE,n="polygon"===t.type?t.rings:t.paths,{position:r,outlines:i}=p(n,!1,o),s=a(r,t.spatialReference,0,r,e,0,r.length/3);for(let a=2;a<r.length;a+=3)r[a]=h;return{lines:s?b(i,r):[],projectionSuccess:s}}function d(t,e,o){const{attributeData:{position:r},removeDuplicateStartEnd:i}=t,s=D(r)&&i===P.REMOVE,a=r.length/3-(s?1:0),u=new Uint32Array(2*(a-1)),c=s?n(r,0,r.length-3):r;let l=0;for(let n=0;n<a-1;n++)u[l++]=n,u[l++]=n+1;e.push([y.POSITION,{size:3,data:c,exclusive:s}]),o.push([y.POSITION,u])}function j(e,o,n){const r=e.attributeData.mapPosition;t(r)||(n.push([y.MAPPOS,n[0][1]]),o.push([y.MAPPOS,{size:3,data:r}]))}function S(t,n,r,i){if(e(t.attributeData.colorFeature))return;const s=t.attributeData.color;n.push([y.COLOR,{size:4,data:o(s,m)}]),r.push([y.COLOR,i])}function U(e,o,n,r){const i=e.attributeData.colorFeature;t(i)||(o.push([y.COLORFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([y.COLOR,r]))}function w(t,n,r,i){if(e(t.attributeData.sizeFeature))return;const s=t.attributeData.size;n.push([y.SIZE,{size:1,data:[o(s,1)]}]),r.push([y.SIZE,i])}function F(e,o,n,r){const i=e.attributeData.sizeFeature;t(i)||(o.push([y.SIZEFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([y.SIZEFEATUREATTRIBUTE,r]))}function v(e,o,n,r){const i=e.attributeData.opacityFeature;t(i)||(o.push([y.OPACITYFEATUREATTRIBUTE,{size:1,data:new Float32Array([i])}]),n.push([y.OPACITYFEATUREATTRIBUTE,r]))}function C(e,o,n,s){if(t(e.overlayInfo)||e.overlayInfo.renderCoordsHelper.viewingMode!==f.Global||!e.overlayInfo.spatialReference.isGeographic)return;const a=new Float64Array(s.length),l=c(e.overlayInfo.spatialReference);for(let t=0;t<a.length;t+=3)u(s,t,a,t,l);const p=s.length/3,m=new Float32Array(p+1);let E=z,h=N,T=0,g=0;i(E,a[g++],a[g++],a[g++]),m[0]=0;for(let t=1;t<p+1;++t)t===p&&(g=0),i(h,a[g++],a[g++],a[g++]),T+=r(E,h),m[t]=T,[E,h]=[h,E];o.push([y.DISTANCETOSTART,{size:1,data:m}]),n.push([y.DISTANCETOSTART,n[0][1]])}function D(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}var P;!function(t){t[t.KEEP=0]="KEEP",t[t.REMOVE=1]="REMOVE"}(P||(P={}));const z=s(),N=s();function L(t){switch(t){case"butt":return A.BUTT;case"square":return A.SQUARE;case"round":return A.ROUND;default:return null}}export{P as RemoveDuplicateStartEnd,O as createGeometry,R as geometryToRenderInfo,I as geometryToRenderInfoDraped,L as parseCapType};
