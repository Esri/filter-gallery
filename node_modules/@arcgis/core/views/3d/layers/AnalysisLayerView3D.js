/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as s}from"../../../chunks/tslib.es6.js";import e from"../../../core/Collection.js";import"../../../core/has.js";import i from"../../../core/Error.js";import{isSome as a,isNone as t}from"../../../core/maybe.js";import{createTask as r,isAborted as n}from"../../../core/promiseUtils.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import{subclass as l}from"../../../core/accessorSupport/decorators/subclass.js";import{LayerView3D as y}from"./LayerView3D.js";import c from"../../layers/LayerView.js";const m="analysis-view-handles";let w=class extends(y(c)){constructor(s){super(s),this.type="analysis-3d",this.allAnalysisViews=new e,this._creatingViewCount=0,this._analysisViewCreationTasks=new Map,this._analysisModules={"area-measurement":{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}initialize(){for(const s of this.layer.analyses)this._createAnalysisView(s);this.handles.add([this.layer.analyses.on("after-add",(s=>{this._createAnalysisView(s.item)})),this.layer.analyses.on("after-remove",(s=>{const e=this.allAnalysisViews.removeAt(this.allAnalysisViews.findIndex((e=>e.analysis===s.item)));a(e)&&e.destroy();const i=this._analysisViewCreationTasks.get(s.item);a(i)&&(i.abort(),this._analysisViewCreationTasks.delete(s.item))}))],m)}destroy(){this.handles.remove(m),this.allAnalysisViews.drain((s=>s.destroy())),this._analysisViewCreationTasks.clear(),this._creatingViewCount=0}whenAnalysisView(s){const e=this._analysisViewCreationTasks.get(s);if(a(e))return e.promise;const t=new i("layerview:no-analysisview-for-analysis","The analysis has not been added to the AnalysisLayer of this layer view",{analysis:s});return Promise.reject(t)}isUpdating(){return 0!==this._creatingViewCount||this.allAnalysisViews.some((s=>s.updating))}_createAnalysisView(s){this._analysisViewCreationTasks.set(s,r((e=>this._createAnalysisViewPromise(s,e))))}async _createAnalysisViewPromise(s,e){this._creatingViewCount+=1;const a=s.type,r=this._analysisModules[a];if(t(r.module)){const s=await this._loadAnalysisModule(a);r.module=s}const o=new r.module.default({analysis:s,view:this.view,parent:this});if(await o.when(),this._creatingViewCount-=1,n(e))throw o.destroy(),new i("layerview:no-analysisview-for-analysis","The analysis has not been added to the AnalysisLayer of this layer view",{analysis:s});return this.allAnalysisViews.add(o),o}_loadAnalysisModule(s){switch(s){case"area-measurement":return import("../analysis/AreaMeasurementAnalysisView3D.js");case"direct-line-measurement":return import("../analysis/DirectLineMeasurementAnalysisView3D.js");case"line-of-sight":return import("../analysis/LineOfSightAnalysisView3D.js");case"slice":return import("../analysis/SliceAnalysisView3D.js");default:return null}}};s([o()],w.prototype,"type",void 0),s([o()],w.prototype,"layer",void 0),s([o()],w.prototype,"allAnalysisViews",void 0),s([o()],w.prototype,"_creatingViewCount",void 0),w=s([l("esri.views.3d.layers.AnalysisLayerView3D")],w);const d=w;export{d as default};
