/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{handlesGroup as e,destroyHandle as t,refHandle as a}from"../../../../core/handleUtils.js";import{deg2rad as n}from"../../../../core/mathUtils.js";import{isSome as i}from"../../../../core/maybe.js";import{s as l,b as r,a as o}from"../../../../chunks/vec3.js";import{c as s}from"../../../../chunks/vec3f64.js";import{getGraphicEffectiveElevationInfo as c}from"../../../../support/elevationInfoUtils.js";import{Manipulator3D as p}from"../Manipulator3D.js";import{GrabbingState as m}from"./GrabbingState.js";import{ManipulatorState as h}from"./ManipulatorState.js";import{ManipulatorType as u}from"./ManipulatorType.js";import{settings as d}from"./settings.js";import{ExtendedLineVisualElement as g}from"../visualElements/ExtendedLineVisualElement.js";import{LaserlineVisualElement as f}from"../visualElements/LaserlineVisualElement.js";import{OutlineVisualElement as v}from"../visualElements/OutlineVisualElement.js";import{GraphicState as y}from"../../layers/graphics/GraphicState.js";import{RenderOccludedFlag as E}from"../../webgl-engine/lib/Material.js";function w(t){const{view:a,graphic:n}=t,i=new y({graphic:n}),l=b(t,i),r=[l,j(t,l.visualElement,i),a.maskOccludee(n),a.trackGraphicState(i)];return{visualElement:l.visualElement,remove:()=>e(r).remove()}}function b(a,n){const{view:i,graphic:l}=a,r=new v({view:i,geometry:G(l)?l.geometry:null,elevationInfo:c(l),attached:!1});d.visualElements.lineGraphics.shadowStyle.apply(r);const o=()=>{r.attached=n.displaying};d.visualElements.lineGraphics.outline.apply(r);const s=[n.watch("displaying",o),n.watch("isDraped",(e=>r.isDraped=e)),n.on("changed",(()=>r.geometry=G(l)?l.geometry:null)),t(r)];return o(),{visualElement:r,remove:()=>e(s).remove()}}function j(i,l,r){const{graphic:o,view:s}=i,p=[],u=c(o),v="on-the-ground"===u.mode||!u.offset&&"absolute-height"!==u.mode,y=new h,w=new g({view:s,extensionType:d.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:E.OccludeAndTransparent});d.visualElements.pointGraphics.shadowStyle.apply(w);const b=n(d.visualElements.heightPlaneAngleCutoff),j=new f({view:s,attached:!1,angleCutoff:b});d.visualElements.heightPlane.apply(j);let L=1,T=1;const A=()=>{if(y.update(i),!r.displaying||v&&(r.isDraped||!G(o)||!o.geometry.hasZ))return l.laserlineEnabled=!1,w.attached=!1,void(j.attached=!1);l.laserlineEnabled=!0;{const e=y.grabbingState&m.XY?d.visualElements.laserlineAlphaMultiplier:1;e!==L&&(L=e,d.visualElements.lineGraphics.shadowStyle.apply(l,e),d.visualElements.pointGraphics.shadowStyle.apply(w,e))}{const e=y.grabbingState&m.Z?d.visualElements.laserlineAlphaMultiplier:1;e!==T&&(T=e,d.visualElements.heightPlane.apply(j,e))}S(w,y),M(i,l,j,y)};d.visualElements.zVerticalLine.apply(w),p.push(r.on("changed",A),r.watch("displaying",A),l.events.on("attachment-origin-changed",A),t(w),t(j));const D=[],C=()=>{e(D).remove(),D.length=0,i.forEachManipulator((e=>D.push(e.events.on("grab-changed",A)))),i.forEachManipulator((e=>D.push(e.events.on("select-changed",A)))),A()};return C(),p.push(i.onManipulatorsChanged(C),a((()=>e(D)))),e(p)}function S(e,t){const a=1===t.numSelected?t.firstSelected:t.numSelected>1&&i(t.firstGrabbedXY)?t.firstGrabbedXY:null;i(a)?(e.setStartEndFromWorldDownAtLocation(a.renderLocation),e.attached=!0):e.attached=!1}function M(e,t,a,n){if(n.numSelected>0){l(L,0,0,0);let t=0;e.forEachManipulator(((e,a)=>{a===u.TRANSLATE_XY&&e.selected&&e instanceof p&&(r(L,L,e.renderLocation),t++)})),t>0?(a.heightManifoldTarget=o(L,L,1/t),a.attached=!0):a.attached=!1}else{const n=t.attachmentOrigin;i(n)&&e.view.renderCoordsHelper.toRenderCoords(n,L)?(a.heightManifoldTarget=L,a.attached=!0):a.attached=!1}}function G(e){return i(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const L=s();export{b as createGeometryRepresentationVisualElement,w as createVisualElements};
