/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import e from"../../../../../core/Evented.js";import{HandleOwnerMixin as i}from"../../../../../core/HandleOwner.js";import{makeHandle as a}from"../../../../../core/handleUtils.js";import{isSome as o,isNone as n,destroyMaybe as s}from"../../../../../core/maybe.js";import{property as r}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/arrayUtils.js";import"../../../../../core/has.js";import"../../../../../core/accessorSupport/ensureType.js";import{subclass as l}from"../../../../../core/accessorSupport/decorators/subclass.js";import p from"../../../../../geometry/Point.js";import{getGraphicEffectiveElevationInfo as h}from"../../../../../support/elevationInfoUtils.js";import{ViewingMode as c}from"../../../../ViewingMode.js";import{Manipulator3D as m}from"../../Manipulator3D.js";import{placeAtGraphic as d}from"../../manipulatorUtils.js";import{SnappingVisualizer3D as g}from"../../SnappingVisualizer3D.js";import{canMoveZ as u}from"../manipulatorUtils.js";import{createVisualElements as v}from"../visualElementUtils.js";import{ALIGN_ARROWS_SCALE_THRESHOLD as M}from"../manipulations/config.js";import{MoveManipulation as y,ManipulationType as f}from"../manipulations/MoveManipulation.js";import{GraphicScaleRotateTransform as S}from"./GraphicScaleRotateTransform.js";import{ScaleRotateMeshAdapter as R}from"./ScaleRotateMeshAdapter.js";import{ScaleRotateObjectSymbol3DAdapter as w}from"./ScaleRotateObjectSymbol3DAdapter.js";import{createGraphicGeometryUndoRecord as b}from"./undoRecords.js";import{GraphicState as j}from"../../../layers/graphics/GraphicState.js";import{InteractiveToolBase as _}from"../../../../interactive/InteractiveToolBase.js";import{EditGeometryOperations as A}from"../../../../interactive/editGeometry/EditGeometryOperations.js";import{SnappingContext as x}from"../../../../interactive/snapping/SnappingContext.js";import{SnappingPipeline as G}from"../../../../interactive/snapping/SnappingDragPipelineStep.js";let T=class extends(i(e.EventedMixin(_))){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.scaleRotate=null,this.snappingPipeline=new G}initialize(){this.graphicState=new j({graphic:this.graphic}),this.moveManipulation=new y({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&u(this.graphic),radius:y.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((t=>this.handles.add(t.events.on("immediate-click",(t=>{this.emit("immediate-click",{...t,graphic:this.graphicState.graphic}),t.stopPropagation()}))))),this.moveManipulation.elevationInfo=h(this.graphic);const t=this.graphic.geometry;if(this.moveManipulation.createGraphicDragPipeline(((e,i,a,n,s)=>(o(t)&&e===f.XY&&(a=a.next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new x({elevationInfo:h(this.graphic),pointer:s,editGeometryOperations:A.fromGeometry(new p({spatialReference:t.spatialReference}),this.view.state.viewingMode),visualizer:new g,excludeFeature:this.graphic}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:n}),this.snappingPipeline.next)),a)),this.graphicState,(t=>{const{action:e,graphic:i,dxScreen:a,dyScreen:o}=t,n={graphic:i,dxScreen:a,dyScreen:o};switch(e){case"start":this.emit("graphic-translate-start",n),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",n);break;case"end":this.emit("graphic-translate-stop",n)}})),this.moveManipulation.angle=o(this.scaleRotate)?this.scaleRotate.angle:0,this.scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(this.scaleRotateAdapter.watch("angle",(()=>this._updateMoveAngle()))),this.enableScaling||this.enableRotation){const t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new S({tool:this,mode:t,adapter:this.scaleRotateAdapter}),this.handles.add(this.scaleRotate.events.on("scale-changed",(()=>this._onScaleChanged())))}this.handles.add([v({view:this.view,graphic:this.graphic,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>a()}),this.graphicState.on("changed",(()=>this._onGeometryChanged())),this._hideManipulatorsForGraphicState(),this.view.watch("scale",(()=>this._updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator((t=>{t instanceof m&&this.handles.add(t.events.on("grab-changed",(()=>this._updateManipulatorsInteractive())))})),this.finishToolCreation()}_updateManipulatorsInteractive(){n(this.scaleRotate)||(this.scaleRotate.interactive=!this.moveManipulation.grabbing,this.moveManipulation.interactive=!this.scaleRotate.grabbing)}_createScaleRotateAdapter(){return o(this.graphic.geometry)&&"mesh"===this.graphic.geometry.type?new R({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new w({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find((t=>t.layer===this.graphic.layer))})}_forEachManipulator(t){this.moveManipulation.forEachManipulator(t),o(this.scaleRotate)&&this.scaleRotate.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",(t=>{this._forEachManipulator((e=>e.available=t)),this.moveManipulation.zManipulation.available=t&&this.enableZ&&u(this.graphic)}))}_createGeometryUndoRecord(){return b(this.graphic)}destroy(){this.moveManipulation.destroy(),this.scaleRotate=s(this.scaleRotate),this.scaleRotateAdapter=s(this.scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}set snapToScene(t){this.moveManipulation&&(this.moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this.moveManipulation.location=t,o(this.scaleRotate)&&(this.scaleRotate.location=t)}set elevationAlignedLocation(t){this.moveManipulation.elevationAlignedLocation=t,o(this.scaleRotate)&&(this.scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){o(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(n(this.scaleRotate))return;const t=this.scaleRotate.getScale();this.moveManipulation.displayScale=t}_updateMoveAngle(){this.view.state.viewingMode===c.Local||this.view.scale<M?this.moveManipulation.angle=this.scaleRotateAdapter.angle:this.moveManipulation.angle=0}_onGeometryChanged(){d(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this.moveManipulation.renderLocation)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,zManipulator:this.moveManipulation.zManipulation.test.manipulator,ringManipulator:o(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};t([r({constructOnly:!0,nonNullable:!0})],T.prototype,"view",void 0),t([r({constructOnly:!0,nonNullable:!0})],T.prototype,"graphic",void 0),t([r({constructOnly:!0,nonNullable:!0})],T.prototype,"enableZ",void 0),t([r()],T.prototype,"enableRotation",void 0),t([r()],T.prototype,"enableScaling",void 0),t([r({value:!1})],T.prototype,"snapToScene",null),t([r({constructOnly:!0})],T.prototype,"snappingManager",void 0),t([r({readOnly:!0})],T.prototype,"type",void 0),t([r({readOnly:!0})],T.prototype,"updating",null),T=t([l("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],T);export{T as GraphicTransformTool};
