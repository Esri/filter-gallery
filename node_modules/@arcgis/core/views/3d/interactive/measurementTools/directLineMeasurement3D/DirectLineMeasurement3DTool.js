/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import"../../../../../geometry.js";import e from"../../../../../core/Handles.js";import{unwrap as i,destroyMaybe as s,isNone as n,isSome as r,unwrapOr as a}from"../../../../../core/maybe.js";import{watch as o,syncAndInitial as l}from"../../../../../core/reactiveUtils.js";import{screenPointObjectToArray as c}from"../../../../../core/screenUtils.js";import{property as h}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/arrayUtils.js";import"../../../../../core/has.js";import"../../../../../core/accessorSupport/ensureType.js";import{subclass as u}from"../../../../../core/accessorSupport/decorators/subclass.js";import{c as p}from"../../../../../chunks/vec3f64.js";import{clonePoint as d}from"../../../../../layers/graphics/hydratedFeatures.js";import{isPrimaryPointerAction as m}from"../../../analysis/support/measurementUtils.js";import{screenToMap3D as v,SurfaceType as y,hideManipulatorWhileDragging as P}from"../../editingTools/dragEventPipeline3D.js";import{DirectLineMeasurement3DView as w}from"./DirectLineMeasurement3DView.js";import{PickRequest as _,PickResult as f}from"./PickRequest.js";import{getElevationAtPoint as g}from"../../../support/ElevationProvider.js";import{newIntersector as M}from"../../../webgl-engine/lib/Intersector.js";import{StoreResults as b}from"../../../webgl-engine/lib/IntersectorInterfaces.js";import{createManipulatorDragEventPipeline as j,resetProperties as S}from"../../../../interactive/dragEventPipeline.js";import{InteractiveToolBase as k}from"../../../../interactive/InteractiveToolBase.js";import{createScreenPointFromEvent as R}from"../../../../support/screenUtils.js";import T from"../../../../../geometry/Point.js";let D=class extends k{constructor(t){super(t),this._handles=new e,this._cachedPickRequest=null,this._isAnyPointerDown=!1,this.lineState="initial",this.analysisView=null,this.startPointSurfaceLocation=null,this.endPointSurfaceLocation=null,this.startManipulator=null,this.endManipulator=null}initialize(){this.measurementView=new w({toolState:this,view:this.view,analysis:this.analysis,analysisView:this.analysisView,cursorPoint:this.cursorPoint,visible:this.visible}),this._intersector=M(this.view.state.viewingMode),this._intersector.options.store=b.MIN;const{start:t,end:e}=this.measurementView.createManipulators(),s=(t,e,s)=>j(t,((t,n,r)=>{const a=P(t);n.next(a).next(v(this.view)).next((t=>"start"!==t.action?t:null)).next((i=>{const n=d(i.mapEnd,new T);this.analysis[e]=n,t.location=n,this[s]=this._surfaceLocation(n,i.surfaceType)})),r.next(a).next(S(this.analysis,[e])).next(S(this,[s])).next((()=>{t.location=i(this.analysis[e])}))})),n=i=>i.events.on("grab-changed",(()=>{const i=t.grabbing||e.grabbing;this.lineState=i?"editing":"measured"}));this._handles.add([s(t,"startPoint","startPointSurfaceLocation"),s(e,"endPoint","endPointSurfaceLocation"),n(t),n(e)]),this.manipulators.add(t),this.manipulators.add(e),this.startManipulator=t,this.endManipulator=e,this.startToolCreation(),this._handles.add(o((()=>this.state),(t=>{"measured"===t&&this.finishToolCreation()}),l))}destroy(){this.measurementView=s(this.measurementView),this._handles=s(this._handles)}get state(){return n(this.analysis.startPoint)&&n(this.analysis.endPoint)?"ready":this.validMeasurement&&"editing"!==this.lineState&&"drawing"!==this.lineState?"measured":"measuring"}get cursor(){return"ready"===this.state||"drawing"===this.lineState?"crosshair":null}set cursorPoint(t){this._set("cursorPoint",t),this.measurementView.cursorPoint=t}get validMeasurement(){return r(this.analysis.startPoint)&&r(this.analysis.endPoint)}onShow(){this.measurementView.show(),this._updateManipulatorAvailability()}onHide(){this.measurementView.hide()}onInputEvent(t){switch(t.type){case"immediate-click":this._handleImmediateClick(t);break;case"pointer-move":this._handlePointerMove(t);break;case"pointer-down":this._handlePointerDown();break;case"pointer-up":this._handlePointerUp()}this._updateManipulatorAvailability()}_handlePointerMove(t){this._clearCachedPickRequest();const e=R(t);"mouse"===t.pointerType&&(this._hoverAt(e),"drawing"===this.lineState&&(this.endManipulator.events.emit("drag",{action:"update",start:e,screenPoint:e}),t.stopPropagation()))}_handlePointerDown(){this._isAnyPointerDown=!0}_handlePointerUp(){this._isAnyPointerDown=!1}_handleImmediateClick(t){if(this._clearCachedPickRequest(),!m(t))return;const e=R(t),i=t.pointerType;let s=!1;if(this.active)switch(this.lineState){case"initial":this.startManipulator.events.emit("drag",{action:"start",pointerType:i,start:e,screenPoint:e}),this.startManipulator.events.emit("drag",{action:"end",start:e,screenPoint:e}),r(this.analysis.startPoint)&&(this.startManipulator.interactive=!1,this.endManipulator.interactive=!1,this.lineState="drawing",this.endManipulator.events.emit("drag",{action:"start",pointerType:i,start:e,screenPoint:e}),s=!0);break;case"drawing":this.endManipulator.events.emit("drag",{action:"update",start:e,screenPoint:e}),r(this.analysis.endPoint)&&(this.endManipulator.events.emit("drag",{action:"end",start:e,screenPoint:e}),this.startManipulator.interactive=!0,this.endManipulator.interactive=!0,this.lineState="measured",s=!0)}s&&t.stopPropagation(),"mouse"===t.pointerType&&this._hoverAt(e)}_hoverAt(t){const e=this._isAnyPointerDown&&"drawing"!==this.lineState&&"editing"!==this.lineState;if((n(this.analysis.startPoint)||n(this.analysis.endPoint))&&this.active&&!e){const e=this._pick(t);r(e)&&(this.cursorPoint=e)}else this.cursorPoint=null}_pick(t){if(r(this._cachedPickRequest)&&r(this._cachedPickRequest.result)){const e=this._cachedPickRequest.screenPoint;if(e.x===t.x&&e.y===t.y)return this._cachedPickRequest.result.mapPoint}else this._cachedPickRequest=new _(t);const e=c(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,s=V;if(!i.getIntersectionPoint(s))return null;const n=this.view.renderCoordsHelper.fromRenderCoords(s,this.view.spatialReference);return this._cachedPickRequest.result=new f(s,n),n}_clearCachedPickRequest(){this._cachedPickRequest=null}_surfaceLocation(t,e){return e===y.GROUND?"on-the-surface":t.z>=this._getElevation(t)?"above-the-surface":"below-the-surface"}_updateManipulatorAvailability(){this.startManipulator.available=r(this.analysis.startPoint),this.endManipulator.available=r(this.analysis.endPoint)}_getElevation(t){return this.view.basemapTerrain.ready?a(g(this.view.elevationProvider,t),0):0}};t([h({readOnly:!0})],D.prototype,"state",null),t([h()],D.prototype,"lineState",void 0),t([h({readOnly:!0})],D.prototype,"cursor",null),t([h()],D.prototype,"cursorPoint",null),t([h({constructOnly:!0})],D.prototype,"analysis",void 0),t([h({constructOnly:!0})],D.prototype,"analysisView",void 0),t([h()],D.prototype,"measurementView",void 0),t([h({constructOnly:!0})],D.prototype,"view",void 0),t([h({readOnly:!0})],D.prototype,"validMeasurement",null),t([h({value:null})],D.prototype,"startPointSurfaceLocation",void 0),t([h({value:null})],D.prototype,"endPointSurfaceLocation",void 0),D=t([u("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DTool")],D);const V=p(),q=D;export{q as default};
