/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import e from"../../../../core/Handles.js";import{isSome as t,unwrap as s,isNone as i,unwrapOr as r}from"../../../../core/maybe.js";import{g as n,f as a,k as l,o}from"../../../../chunks/vec3.js";import{c as h,f as _}from"../../../../chunks/vec3f64.js";import{g as d,c as p}from"../../../../chunks/vec4.js";import{f as u,a as c}from"../../../../chunks/vec4f32.js";import{create as f,fromRay as m,getStart as y,getEnd as g}from"../../../../geometry/support/clipRay.js";import{intersectClipRay as x}from"../../../../geometry/support/frustum.js";import{create as w,fromPoints as b,pointAt as E}from"../../../../geometry/support/lineSegment.js";import{create as R,fromPoints as O}from"../../../../geometry/support/ray.js";import{LaserlineVisualElement as D}from"./LaserlineVisualElement.js";import{Object3DVisualElement as A}from"./Object3DVisualElement.js";import C from"../../webgl-engine/lib/GeometryUtil.js";import{RenderOccludedFlag as P}from"../../webgl-engine/lib/Material.js";import{VertexAttribute as j}from"../../webgl-engine/lib/VertexAttribute.js";import{RibbonLineMaterial as v}from"../../webgl-engine/materials/RibbonLineMaterial.js";class M extends A{constructor(t){super(t),this._ray=R(),this._externalResources=null,this._handles=new e,this._isWorldDown=!1,this._start=h(),this._end=_(1,0,0),this._width=1,this._color=u(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=u(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=T.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=P.OccludeAndTransparent,this._fadedExtensions=N,this.applyProps(t)}createExternalResources(){const e=new v(this.materialParameters);this._handles.add(this.view.state.watch("camera",(()=>{this._updateGeometry()})));const t=new D({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:t}}destroyExternalResources(){t(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){t(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const t=[h(),h()],i=this.extensionType===T.FADED;i&&t.push(h(),h());const r=i?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,n=C.createPolylineGeometry(t,null,r);e.addGeometry(n,s(this._externalResources).material),this._updateVertices(e)}updateVisibility(e){super.updateVisibility(e),t(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,n(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),a(this._end,e,this._end),O(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,l(this._start,e)||(n(this._start,e),O(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,l(this._end,e)||(n(this._end,e),O(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){d(e,this._color)||(p(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){d(e,this._innerColor)||(p(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const s=t(e)!==t(this._stipplePattern);this._stipplePattern=e,s?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(i(e)||i(this._stippleOffColor)||!d(e,this._stippleOffColor))&&(this._stippleOffColor=t(e)?c(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this._updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&t(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,t(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,t(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,t(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=r(e,N),this.recreateGeometry()}_updateMaterial(){if(i(this._externalResources))return;this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateGeometry(){t(this.object)&&this._updateVertices(this.object)}_updateVertices(e){const s=this._extensionType===T.FADED?this._updateLineSegmentFinite(S):this._updateLineSegmentInfinite(this._extensionType,S);this._updateVertexAttributes(e,s),t(this._externalResources)&&(this._externalResources.laserline.intersectsLine=s)}_updateLineSegmentFinite(e){return b(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const s=this.view.state.camera;switch(m(this._ray,G),e){case T.LINE:G.c0=-Number.MAX_VALUE;break;case T.RAY:case T.GROUND_RAY:{const e=this._ray.origin,t=r(this.view.elevationProvider.getElevation(e[0],e[1],e[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),s=this.view.renderCoordsHelper.getAltitude(e);this._isWorldDown&&s<t&&o(G.ray.direction,G.ray.direction),this._extensionType===T.GROUND_RAY&&null!=t&&(G.c1=Math.abs(s-t));break}}if(!x(s.frustum,G))return b(this._start,this._end,t);const i=y(G,W),n=g(G,L);return b(i,n,t)}_updateVertexAttributes(e,t){const s=e.geometries[0].getMutableAttribute(j.POSITION).data;if(this.extensionType===T.FADED){const e=E(t,-this.fadedExtensions.start,W);s[0]=e[0],s[1]=e[1],s[2]=e[2];const i=E(t,0,W);s[3]=i[0],s[4]=i[1],s[5]=i[2];const r=E(t,1,W);s[6]=r[0],s[7]=r[1],s[8]=r[2];const n=E(t,1+this.fadedExtensions.end,W);s[9]=n[0],s[10]=n[1],s[11]=n[2]}else{const e=E(t,0,W);s[0]=e[0],s[1]=e[1],s[2]=e[2];const i=E(t,1,W);s[3]=i[0],s[4]=i[1],s[5]=i[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const G=f(),W=h(),L=h(),S=w();var T;!function(e){e[e.LINE=0]="LINE",e[e.RAY=1]="RAY",e[e.GROUND_RAY=2]="GROUND_RAY",e[e.FADED=3]="FADED"}(T||(T={}));const V=1/3,N={start:V,end:V};export{M as ExtendedLineVisualElement,T as ExtensionType};
