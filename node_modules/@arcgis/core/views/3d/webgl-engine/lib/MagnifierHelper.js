/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import s from"../../../../core/Accessor.js";import t from"../../../../core/Evented.js";import r from"../../../../core/Handles.js";import{clamp as i}from"../../../../core/mathUtils.js";import{isNone as o,isSome as a}from"../../../../core/maybe.js";import{createTask as n}from"../../../../core/promiseUtils.js";import{createScreenPointArray as m,createRenderScreenPointArray as u,screenPointObjectToArray as l}from"../../../../core/screenUtils.js";import{isSVG as h}from"../../../../core/urlUtils.js";import{property as p}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as c}from"../../../../core/accessorSupport/decorators/subclass.js";import{requestImage as d}from"../../../../support/requestImageUtils.js";import{Pos2 as _}from"./DefaultVertexBufferLayouts.js";import{createQuadVAO as g}from"./glUtil3D.js";import{Program as f}from"./Program.js";import{VertexAttribute as T}from"./VertexAttribute.js";import{build as v}from"../shaders/Magnifier.glsl.js";import{loadMagnifierResources as y}from"../../../magnifier/resources.js";import{PrimitiveType as k,BlendFactor as R,TextureType as L,PixelFormat as S,PixelType as x,TextureWrapMode as E,TextureSamplingMode as b}from"../../../webgl/enums.js";import{makePipelineState as A,simpleBlendingParams as j,defaultColorWriteParams as w}from"../../../webgl/renderState.js";import{Texture as M}from"../../../webgl/Texture.js";let U=class extends s{constructor(){super(...arguments),this._handles=new r,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new t,this.attributeLocations=new Map([[T.POSITION,0]]),this.tmpScreenPoint=m(),this.tmpRenderPoint=u()}get updating(){return o(this._imageSources)&&a(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const s=()=>{this._updateResourceLoading(),this.events.emit("request-render")};a(this._magnifier)&&this._handles.add(this._magnifier.watch("version",s)),s()}get enabled(){return a(this._validMagnifier)}get _validMagnifier(){return a(this._magnifier)&&this._magnifier.visible&&a(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return a(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),a(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,s){const t=this._validMagnifier;if(o(t))return;const r=s.camera.pixelRatio,a=Math.ceil(r*t.size);if(this._updateResources(e,a),o(this._resources))return;const n=this._resources.program;e.useProgram(n);const m=this._resources.textures,u=Math.ceil(1/this.factor*a);m.input.resize(u,u);const h=s.camera.fullWidth,p=s.camera.fullHeight;l(t.position,this.tmpScreenPoint);const c=s.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),d=.5*u,_=.5*u;c[0]=i(c[0],d,h-d-1),c[1]=i(c[1],_,p-_-1);const g=Math.floor(c[0]-d),f=Math.floor(c[1]-_);n.bindTexture(m.input,"textureInput"),e.gl.copyTexImage2D(m.input.descriptor.target,0,m.input.descriptor.pixelFormat,g,f,u,u,0);const T=t.offset.x*r,v=t.offset.y*r,y=(c[0]+T)/h*2-1,R=(c[1]-v)/p*2-1,L=a/h*2,S=a/p*2;e.bindVAO(this._resources.vao),n.bindTexture(m.overlay,"textureOverlay"),n.bindTexture(m.mask,"textureMask"),n.setUniform4f("drawPosition",y,R,L,S),n.setUniform1b("maskEnabled",t.maskEnabled),n.setUniform1b("overlayEnabled",t.overlayEnabled),e.setPipelineState(this._resources.pipelineState),e.drawArrays(k.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(o(e))return;const s=e.maskUrl,t=e.overlayUrl;!a(this._imageLoadTask)||this._imageLoadTask.maskUrl===s&&this._imageLoadTask.overlayUrl===t||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),a(this._imageSources)||a(this._imageLoadTask)||(this._imageLoadTask={maskUrl:s,overlayUrl:t,task:n((async e=>{const r=o(s)||o(t)?y(e):null,i=a(s)?d(s,{signal:e}):r.then((e=>e.mask)),n=a(t)?d(t,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await i,overlay:await n},this._disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))}_updateResources(e,s){if(!this.enabled)return void this._disposeResources();if(a(this._resources)){if(this._resources.textures.size!==s){const t=this._createTextureResources(e,s);if(o(t))return void this._disposeResources();this._disposeTextureResources(this._resources.textures),this._resources.textures=t}return}const t=this._createTextureResources(e,s);o(t)||(this._resources={textures:t,program:this._createProgram(e),vao:g(e,_,this.attributeLocations,0,1),pipelineState:A({blending:j(R.ONE,R.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:w})})}_disposeResources(){o(this._resources)||(this._disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,s){if(o(this._imageSources))return null;this._imageSources.overlay.width=s,this._imageSources.overlay.height=s,this._imageSources.mask.width=s,this._imageSources.mask.height=s;const t=new M(e,{target:L.TEXTURE_2D,pixelFormat:S.RGBA,internalFormat:S.RGBA,dataType:x.UNSIGNED_BYTE,wrapMode:E.CLAMP_TO_EDGE,samplingMode:b.LINEAR,flipped:!0,preMultiplyAlpha:!h(this._imageSources.overlay.src)||!e.driverTest.svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new M(e,{target:L.TEXTURE_2D,pixelFormat:S.ALPHA,internalFormat:S.ALPHA,dataType:x.UNSIGNED_BYTE,wrapMode:E.CLAMP_TO_EDGE,samplingMode:b.LINEAR,flipped:!0},this._imageSources.mask);return{input:new M(e,{target:L.TEXTURE_2D,pixelFormat:S.RGBA,internalFormat:S.RGBA,dataType:x.UNSIGNED_BYTE,wrapMode:E.CLAMP_TO_EDGE,samplingMode:b.LINEAR,flipped:!1}),mask:r,overlay:t,size:s}}_createProgram(e){const s=v();return new f(e,s,this.attributeLocations)}};e([p()],U.prototype,"_imageSources",void 0),e([p()],U.prototype,"_imageLoadTask",void 0),e([p({readOnly:!0})],U.prototype,"updating",null),U=e([c("esri/views/3d/webgl-engine/lib/MagnifierHelper")],U);export{U as MagnifierHelper};
