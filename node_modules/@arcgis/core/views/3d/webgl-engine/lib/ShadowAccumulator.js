/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/Accessor.js";import{equals as i}from"../../../../core/arrayUtils.js";import s from"../../../../core/Handles.js";import{smoothstep as r}from"../../../../core/mathUtils.js";import{isNone as a,disposeMaybe as o,releaseMaybe as n}from"../../../../core/maybe.js";import{watch as h,syncAndInitial as c}from"../../../../core/reactiveUtils.js";import{property as _}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as u}from"../../../../core/accessorSupport/decorators/subclass.js";import{j as l,a as m}from"../../../../chunks/mat4.js";import{c as p}from"../../../../chunks/mat4f64.js";import{a as d}from"../../../../chunks/vec2f64.js";import{y as g,g as f}from"../../../../chunks/vec3.js";import{c as w}from"../../../../chunks/vec3f64.js";import{c as v}from"../../../../chunks/vec4f64.js";import b from"./Camera.js";import{ZERO as j}from"./depthRange.js";import{createQuadVAO as S}from"./glUtil3D.js";import{ShadowCastRenderer as y,shadowCastDisabledElevationThreshold as A,shadowCastDisableElevationMax as C,shadowCastDisableElevationMin as R}from"./ShadowCastRenderer.js";import T from"./ShadowMap.js";import{inverseProjectionInfo as D}from"./Util.js";import{S as F,s as E}from"../../../../chunks/ShadowCast.glsl.js";import{ShadowCastTechniqueConfiguration as M,ShadowCastTechnique as x}from"../shaders/ShadowCastTechnique.js";import{TaskPriority as P}from"../../../support/Scheduler.js";import{TargetType as q,DepthStencilTargetType as U,TextureType as V,PixelFormat as I,PixelType as k,TextureSamplingMode as L,TextureWrapMode as O,ClearBufferBit as N}from"../../../webgl/enums.js";import{FramebufferObject as z}from"../../../webgl/FramebufferObject.js";import{vertexCount as B}from"../../../webgl/Util.js";var H;let G=H=class extends t{constructor(e,t,i,r,o,n){super({}),this._rctx=e,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=o,this._requestRender=n,this._progress=0,this._sampleCount=0,this._cachedCamera=new b,this._contentCamera=new b,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=j,this._previewing=!1,this._handles=new s,this._cameraForcedForScreenshot=!1,this._shadowMap=new T(e,i.viewingMode),this._shadowMap.enabled=!0,this._vao=S(e);const _={colorTarget:q.TEXTURE,depthStencilTarget:U.NONE,width:0,height:0},u={target:V.TEXTURE_2D,pixelFormat:I.RGBA,dataType:k.UNSIGNED_BYTE,samplingMode:L.LINEAR,wrapMode:O.CLAMP_TO_EDGE,width:0,height:0};this._fbo=new z(e,_,u),this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseViewMatrix:p(),projInfo:v(),zScale:d()},this._accumulationRenderer=new y(t,e,this,n);const l=this._stage.resourceController.scheduler;this._handles.add(l.registerTask(P.SHADOW_ACCUMULATOR,this)),this._handles.add(h((()=>i.renderView),(e=>{this._handles.remove(H.renderViewHandleKey),a(e)||this._handles.add(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),H.renderViewHandleKey)}),c))}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get accumulationTechnique(){if(a(this._accumulationTechnique)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode},t=new M;t.pass=F.Accumulate,this._accumulationTechnique=new x(e,t)}return this._accumulationTechnique}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get _canAccumulate(){return null!==this._accumulationParams.linearDepthTexture&&this._depthRange!==j&&this._opacityFromElevation>A}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if(i(t,e,g))return;const s=e.length;t.length=s,this._sampleCount=Math.min(E,s);for(let i=0;i<s;++i){const s=e[i],r=t[i]||w();f(r,s),t[i]=r}this._invalidate()}get _projInfo(){return this._accumulationParams.projInfo}get _zScale(){return this._accumulationParams.zScale}get _inverseView(){return this._accumulationParams.inverseViewMatrix}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this._canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}accumulateFixedSamples(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const e=this._cameraForcedForScreenshot?this._sampleCount:Math.min(H.previewSamples,this._sampleCount-this._progress);for(let t=0;t<e;++t)this._accumulateShadow();this._cameraForcedForScreenshot=!1}render(){this._accumulationRenderer.render()}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=o(this._accumulationRenderer),this._shadowMap=o(this._shadowMap),this._fbo=o(this._fbo),this._vao=o(this._vao),this._accumulationTechnique=n(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.previewing&&this.setPreviewing(e.previewing),void 0!==e.lightDirections&&this.setLightDirections(e.lightDirections),this._accumulationRenderer.setOptions(e)}setPreviewing(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled())}setLightDirections(e){this._lightDirections=e}setAccumulationDependencies(e,t,i,s){this._accumulationParams.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._contentCamera=s,this.notifyChange("_canAccumulate")}readAccumulatedShadow(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=K;return this._fbo.readPixels(e,t,1,1,I.RGBA,k.UNSIGNED_BYTE,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0}_stop(){this._enabled=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(N.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){const e=this._lightDirections[this._progress],t=this._cachedCamera;this._renderToShadowMap(this._shadowMap,e,t,this._depthRange),this._rctx.bindFramebuffer(this._fbo);const i=this.accumulationTechnique;this._rctx.useTechnique(i),i.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,B(this._vao,"geometry")),this._progress++}_updateCamera(e){if(e.equals(this._cachedCamera))return;const{fullWidth:t,fullHeight:i,projectionMatrix:s,viewMatrix:a,center:o}=e;this._cachedCamera.copyFrom(e),this._fbo.resize(t,i),D(s,t,i,this._projInfo,this._zScale),l(this._inverseView,a,o),m(this._inverseView,this._inverseView),this._opacityFromElevation=1-r(R,C,e.relativeElevation)}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}get test(){return{lightDirections:this._lightDirections,isDone:()=>this._isDoneAccumulating,isActive:()=>this._isActive}}};G.previewSamples=6,G.renderViewHandleKey="renderView",e([_()],G.prototype,"_progress",void 0),e([_()],G.prototype,"_sampleCount",void 0),e([_()],G.prototype,"_enabled",void 0),e([_()],G.prototype,"_depthRange",void 0),e([_()],G.prototype,"_previewing",void 0),e([_()],G.prototype,"_accumulationRenderer",void 0),e([_()],G.prototype,"_isRefining",null),e([_()],G.prototype,"_isActive",null),e([_()],G.prototype,"_canAccumulate",null),e([_()],G.prototype,"_isDoneAccumulating",null),e([_()],G.prototype,"_opacityFromElevation",null),e([_()],G.prototype,"running",null),G=H=e([u("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],G);const K=new Uint8Array(4);export{G as ShadowAccumulator};
