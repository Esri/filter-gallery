/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{clamp as t,acosClamped as s,lerp as e}from"../../../../core/mathUtils.js";import{isSome as a,disposeMaybe as i}from"../../../../core/maybe.js";import{c as r}from"../../../../chunks/mat3f64.js";import{j as h,m as o,q as c,a as n,n as m}from"../../../../chunks/mat4.js";import{c as d}from"../../../../chunks/mat4f64.js";import{s as u,m as p,g as l,o as f,a as x,f as _,k as T,n as g,i as b,c as S}from"../../../../chunks/vec2.js";import{a as M}from"../../../../chunks/vec2f64.js";import{g as w,o as C,m as E,s as j}from"../../../../chunks/vec3.js";import{c as D}from"../../../../chunks/vec3f64.js";import{s as U,t as v}from"../../../../chunks/vec4.js";import{c as z}from"../../../../chunks/vec4f64.js";import{ViewingMode as R}from"../../../ViewingMode.js";import F from"./Camera.js";import{assert as y,logWithBase as N,verify as A,rayRay2D as O}from"./Util.js";import{TextureType as P,ClearBufferBit as k,PixelFormat as L,PixelType as B,TextureWrapMode as G,TextureSamplingMode as I,TargetType as X,DepthStencilTargetType as H}from"../../../webgl/enums.js";import{FramebufferObject as q}from"../../../webgl/FramebufferObject.js";import{Texture as V}from"../../../webgl/Texture.js";import{getGpuMemoryUsage as Y}from"../../../webgl/Util.js";class W{constructor(){this.camera=new F,this.lightMat=d()}}class J{constructor(t,s,e=0){this.rctx=t,this.viewingMode=s,this._enabled=!1,this._snapshots=new Array,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let a=0;a<4;++a)this.cascades.push(new W);this.snapshotCount=e}dispose(){this._discardDepthTexture(),this._discardAllSnapshots()}set maxCascades(s){this.maxNumCascades=t(Math.floor(s),1,4)}get maxCascades(){return this.maxNumCascades}set enabled(t){this._enabled=t,t||(this._discardDepthTexture(),this._discardAllSnapshots())}get enabled(){return this._enabled}get snapshotCount(){return this._snapshots.length}set snapshotCount(t){const s=this._snapshots.length;if(t>s){const e=t-s;this._snapshots.length=t;for(let t=0;t<e;++t)this._snapshots[s+t]=null}else if(t<this.snapshotCount){const e=s-t;for(let s=0;s<e;++s)this._discardSnapshot(t+s);this._snapshots.length=t}}getSnapshot(t){return this.enabled?this._snapshots[t]:null}getCascades(){for(let t=0;t<this.numCascades;++t)mt[t]=this.cascades[t];return mt.length=this.numCascades,mt}start(t,s,e){y(this.enabled),this.textureSize=this._computeTextureSize(t.fullWidth,t.fullHeight),this._ensureDepthTexture();const{near:a,far:i}=this._clampNearFar(e);this._computeCascadeDistances(i,a),this._setupMatrices(t,s);const r=t.viewMatrix,h=t.projectionMatrix;for(let o=0;o<this.numCascades;++o)this._constructCascade(o,h,r,s);this.lastOrigin=null,this.clear()}finish(t){y(this.enabled),this.rctx.bindFramebuffer(t)}bind(t){this.enabled?(this._depthTextureUnit=t.bindTexture(this._depthTexture,"shadowMapTex"),t.setUniform1f("depthHalfPixelSz",.5/this.textureSize),t.setUniform1i("numCascades",this.numCascades),t.setUniform4f("cascadeDistances",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)):t.setUniform1f("depthHalfPixelSz",-1)}bindView(t,s){if(!this.enabled)return;const e=this.lastOrigin;if(!(e&&e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2])){this.lastOrigin=this.lastOrigin||D(),w(this.lastOrigin,s);for(let t=0;t<this.numCascades;++t){h(dt,this.cascades[t].lightMat,s);for(let s=0;s<16;++s)ut[16*t+s]=dt[s]}}t.setUniformMatrix4fv("shadowMapMatrix",ut)}takeCascadeSnapshotTo(t,s){y(this.enabled),this._ensureSnapshot(s),this._bindFbo();const e=this.rctx,a=e.bindTexture(this._snapshots[s],V.TEXTURE_UNIT_FOR_UPDATES);e.gl.copyTexSubImage2D(P.TEXTURE_2D,0,t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[2],t.camera.viewport[3]),e.bindTexture(a,V.TEXTURE_UNIT_FOR_UPDATES)}clear(){const t=this.rctx;this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(k.COLOR_BUFFER_BIT|k.DEPTH_BUFFER_BIT)}_computeTextureSize(t,s){const e=.5*Math.log(t*t+s*s)*Math.LOG2E,a=.35,i=2**Math.round(e+a);return Math.min(this.maxTextureSize,2*i)}_ensureDepthTexture(){if(null!=this._depthTexture&&this._depthTexture.descriptor.width===this.textureSize)return;this._discardDepthTexture();const t={target:P.TEXTURE_2D,pixelFormat:L.RGBA,dataType:B.UNSIGNED_BYTE,wrapMode:G.CLAMP_TO_EDGE,samplingMode:I.NEAREST,flipped:!0,width:this.textureSize,height:this.textureSize};this._depthTexture=new V(this.rctx,t),this.fbo=new q(this.rctx,{colorTarget:X.TEXTURE,depthStencilTarget:H.DEPTH_RENDER_BUFFER,width:this.textureSize,height:this.textureSize},this._depthTexture)}_ensureSnapshot(t){const s=this._snapshots[t];if(a(s)&&s.descriptor.width===this.textureSize)return;this._discardSnapshot(t);const e={target:P.TEXTURE_2D,pixelFormat:L.RGBA,dataType:B.UNSIGNED_BYTE,wrapMode:G.CLAMP_TO_EDGE,samplingMode:I.NEAREST,flipped:!0,width:this.textureSize,height:this.textureSize};this._snapshots[t]=new V(this.rctx,e)}_discardDepthTexture(){this.fbo=i(this.fbo),this._depthTexture=i(this._depthTexture)}_discardSnapshot(t){this._snapshots[t]=i(this._snapshots[t])}_discardAllSnapshots(){for(let t=0;t<this.snapshotCount;++t)this._discardSnapshot(t)}_bindFbo(){const t=this.rctx;a(this._depthTextureUnit)&&(t.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null),t.bindFramebuffer(this.fbo)}_constructCascade(t,s,e,a){const i=this.cascades[t],r=-this.cascadeDistances[t],c=-this.cascadeDistances[t+1],n=(s[10]*r+s[14])/Math.abs(s[11]*r+s[15]),m=(s[10]*c+s[14])/Math.abs(s[11]*c+s[15]);y(n<m);for(let h=0;h<8;++h){U($,h%4==0||h%4==3?-1:1,h%4==0||h%4==1?-1:1,h<4?n:m,1),v(tt[h],$,Z);for(let t=0;t<3;++t)tt[h][t]/=tt[h][3]}C(nt,tt[0]),h(K,ct,nt),i.camera.viewMatrix=K;for(let h=0;h<8;++h)E(tt[h],tt[h],i.camera.viewMatrix);w(st,tt[0]),w(et,tt[0]);for(let h=1;h<8;++h)for(let t=0;t<3;++t)st[t]=Math.min(st[t],tt[h][t]),et[t]=Math.max(et[t],tt[h][t]);st[2]-=200,et[2]+=200,i.camera.near=-et[2],i.camera.far=-st[2],this.warp?this._constructTrapezoidalProjection(e,a,i):this._constructOrthogonalProjection(i),o(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const d=this.textureSize/2;i.camera.viewport[0]=t%2==0?0:d,i.camera.viewport[1]=0===Math.floor(t/2)?0:d,i.camera.viewport[2]=d,i.camera.viewport[3]=d}_constructOrthogonalProjection(t){c(t.camera.projectionMatrix,st[0],et[0],st[1],et[1],t.camera.near,t.camera.far)}_constructTrapezoidalProjection(t,e,a){const i=1/tt[0][3],r=1/tt[4][3];y(i<r);let h=i+Math.sqrt(i*r);const o=Math.sin(s(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));h/=o,wt(tt,h,o,at,it,rt,ht,ot),vt(at,it,ht,ot,a.camera.projectionMatrix),a.camera.projectionMatrix[10]=2/(st[2]-et[2]),a.camera.projectionMatrix[14]=-(st[2]+et[2])/(st[2]-et[2])}_setupMatrices(t,s){o(Q,t.projectionMatrix,t.viewMatrix),n(Z,Q);const e=this.viewingMode===R.Global?t.eye:j(nt,0,0,1);m(ct,[0,0,0],[-s[0],-s[1],-s[2]],e)}_clampNearFar(t){let{near:s,far:e}=t;return s<2&&(s=2),e<2&&(e=2),s>=e&&(s=2,e=4),{near:s,far:e}}_computeCascadeDistances(t,s){this.numCascades=Math.min(1+Math.floor(N(t/s,4)),this.maxNumCascades);const a=(t-s)/this.numCascades,i=(t/s)**(1/this.numCascades);let r=s,h=s;for(let o=0;o<this.numCascades+1;++o)this.cascadeDistances[o]=e(r,h,this.splitSchemeLambda),r*=i,h+=a}get gpuMemoryUsage(){var t,s;return this._snapshots.reduce(((t,s)=>t+Y(s)),null!=(t=null==(s=this.fbo)?void 0:s.gpuMemoryUsage)?t:0)}get test(){const t=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(s){t.splitSchemeLambda=s},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(s){t.warp=s},get warp(){return t.warp}}}}const K=d(),Q=d(),Z=d(),$=z(),tt=[];for(let zt=0;zt<8;++zt)tt.push(z());const st=D(),et=D(),at=M(),it=M(),rt=M(),ht=M(),ot=M(),ct=d(),nt=D(),mt=[],dt=d(),ut=new Float32Array(64),pt=M(),lt=M(),ft=[M(),M(),M(),M()],xt=M(),_t=M(),Tt=M(),gt=M(),bt=M(),St=M(),Mt=M();function wt(t,s,e,a,i,r,h,o){u(pt,0,0);for(let u=0;u<4;++u)p(pt,pt,t[u]);l(pt,pt,.25),u(lt,0,0);for(let u=4;u<8;++u)p(lt,lt,t[u]);l(lt,lt,.25),f(ft[0],t[4],t[5],.5),f(ft[1],t[5],t[6],.5),f(ft[2],t[6],t[7],.5),f(ft[3],t[7],t[4],.5);let c=0,n=x(ft[0],pt);for(let u=1;u<4;++u){const t=x(ft[u],pt);t<n&&(n=t,c=u)}_(xt,ft[c],t[c+4]);const m=xt[0];let d,M;xt[0]=-xt[1],xt[1]=m,_(_t,lt,pt),T(_t,xt)<0&&g(xt,xt),f(xt,xt,_t,e),b(xt,xt),d=M=T(_(Tt,t[0],pt),xt);for(let u=1;u<8;++u){const s=T(_(Tt,t[u],pt),xt);s<d?d=s:s>M&&(M=s)}S(a,pt),l(Tt,xt,d-s),p(a,a,Tt);let w=-1,C=1,E=0,j=0;for(let u=0;u<8;++u){_(gt,t[u],a),b(gt,gt);const s=xt[0]*gt[1]-xt[1]*gt[0];s>0?s>w&&(w=s,E=u):s<C&&(C=s,j=u)}A(w>0,"leftArea"),A(C<0,"rightArea"),l(bt,xt,d),p(bt,bt,pt),l(St,xt,M),p(St,St,pt),Mt[0]=-xt[1],Mt[1]=xt[0];const D=O(a,t[j],St,p(Tt,St,Mt),1,i),U=O(a,t[E],St,Tt,1,r),v=O(a,t[E],bt,p(Tt,bt,Mt),1,h),z=O(a,t[j],bt,Tt,1,o);A(D,"rayRay"),A(U,"rayRay"),A(v,"rayRay"),A(z,"rayRay")}function Ct(t,s){return 3*s+t}const Et=M();function jt(t,s){return u(Et,t[s],t[s+3]),Et}const Dt=M(),Ut=r();function vt(t,s,e,a,i){_(Dt,e,a),l(Dt,Dt,.5),Ut[0]=Dt[0],Ut[1]=Dt[1],Ut[2]=0,Ut[3]=Dt[1],Ut[4]=-Dt[0],Ut[5]=0,Ut[6]=Dt[0]*Dt[0]+Dt[1]*Dt[1],Ut[7]=Dt[0]*Dt[1]-Dt[1]*Dt[0],Ut[8]=1,Ut[Ct(0,2)]=-T(jt(Ut,0),t),Ut[Ct(1,2)]=-T(jt(Ut,1),t);let r=T(jt(Ut,0),e)+Ut[Ct(0,2)],h=T(jt(Ut,1),e)+Ut[Ct(1,2)],o=T(jt(Ut,0),a)+Ut[Ct(0,2)],c=T(jt(Ut,1),a)+Ut[Ct(1,2)];r=-(r+o)/(h+c),Ut[Ct(0,0)]+=Ut[Ct(1,0)]*r,Ut[Ct(0,1)]+=Ut[Ct(1,1)]*r,Ut[Ct(0,2)]+=Ut[Ct(1,2)]*r,r=1/(T(jt(Ut,0),e)+Ut[Ct(0,2)]),h=1/(T(jt(Ut,1),e)+Ut[Ct(1,2)]),Ut[Ct(0,0)]*=r,Ut[Ct(0,1)]*=r,Ut[Ct(0,2)]*=r,Ut[Ct(1,0)]*=h,Ut[Ct(1,1)]*=h,Ut[Ct(1,2)]*=h,Ut[Ct(2,0)]=Ut[Ct(1,0)],Ut[Ct(2,1)]=Ut[Ct(1,1)],Ut[Ct(2,2)]=Ut[Ct(1,2)],Ut[Ct(1,2)]+=1,r=T(jt(Ut,1),s)+Ut[Ct(1,2)],h=T(jt(Ut,2),s)+Ut[Ct(2,2)],o=T(jt(Ut,1),e)+Ut[Ct(1,2)],c=T(jt(Ut,2),e)+Ut[Ct(2,2)],r=-.5*(r/h+o/c),Ut[Ct(1,0)]+=Ut[Ct(2,0)]*r,Ut[Ct(1,1)]+=Ut[Ct(2,1)]*r,Ut[Ct(1,2)]+=Ut[Ct(2,2)]*r,r=T(jt(Ut,1),s)+Ut[Ct(1,2)],h=T(jt(Ut,2),s)+Ut[Ct(2,2)],o=-h/r,Ut[Ct(1,0)]*=o,Ut[Ct(1,1)]*=o,Ut[Ct(1,2)]*=o,i[0]=Ut[0],i[1]=Ut[1],i[2]=0,i[3]=Ut[2],i[4]=Ut[3],i[5]=Ut[4],i[6]=0,i[7]=Ut[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=Ut[6],i[13]=Ut[7],i[14]=0,i[15]=Ut[8]}export{J as default};
