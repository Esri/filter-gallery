/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{releaseMaybe as t,disposeMaybe as r,isSome as i}from"../../../../core/maybe.js";import"../../../../core/Logger.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/set.js";import{subclass as s}from"../../../../core/accessorSupport/decorators/subclass.js";import{ViewingMode as a}from"../../../ViewingMode.js";import{createQuadVAO as o}from"./glUtil3D.js";import{SortedRenderGeometryRenderer as h}from"./SortedRenderGeometryRenderer.js";import{isHeatMapDensityMaterial as n}from"../materials/HeatmapDensityMaterial.js";import{HeatmapTechnique as c,HeatmapTechniqueConfiguration as m}from"../shaders/HeatmapTechnique.js";import{TargetType as p,DepthStencilTargetType as d,TextureType as l,PixelFormat as u,SizedPixelFormat as _,PixelType as g,TextureSamplingMode as R,TextureWrapMode as f,ClearBufferBit as x}from"../../../webgl/enums.js";import{FramebufferObject as y}from"../../../webgl/FramebufferObject.js";import{Texture as w}from"../../../webgl/Texture.js";import{vertexCount as T}from"../../../webgl/Util.js";let b=class extends h{constructor(){super(...arguments),this.type="draped-heatmap"}initialize(){super.initialize();const e={colorTarget:p.TEXTURE,depthStencilTarget:d.NONE,width:0,height:0},{capabilities:t}=this.rctx,{R32F:r}=t.colorBufferFloat,{textureFloatLinear:i}=t.textureFloat,s=null!=r,h={target:l.TEXTURE_2D,pixelFormat:s?u.RED:u.RGBA,internalFormat:s?_.R32F:u.RGBA,dataType:g.FLOAT,samplingMode:i?R.LINEAR:R.NEAREST,wrapMode:f.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new y(this.rctx,e,h),this._quad=o(this.rctx);const n={target:l.TEXTURE_2D,pixelFormat:u.RGBA,dataType:g.UNSIGNED_BYTE,samplingMode:R.LINEAR,wrapMode:f.CLAMP_TO_EDGE,width:1,height:1},x=new w(this.rctx,n,new Uint8ClampedArray(4));this._colorRamp=x,this._technique=new c({rctx:this.rctx,viewingMode:a.Local},new m),this._heatmapParameters={colorRamp:x,densityMap:this._densityMap.colorTexture,searchRadius:1,minDensity:0,maxDensity:100,fieldTotal:0}}destroy(){this._technique=t(this._technique),this._densityMap=r(this._densityMap),this._quad=r(this._quad),this._colorRamp=r(this._colorRamp)}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}get _heatmapDensityMaterialRenderers(){return this._sortedMaterialRenderers.filter(D)}add(e){super.add(e)}remove(e){super.remove(e)}render(e,t){const r=this._heatmapDensityMaterialRenderers,s=r.length;if(s<1)return;const a=this.rctx.getBoundFramebufferObject(),o=this.rctx.getViewport(),h=r[0].material.parameters,{pixelRatio:n}=h,c=Math.ceil(o.width*n),m=Math.ceil(o.height*n);this._densityMap.resize(c,m),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,c,m),this.rctx.clear(x.COLOR_BUFFER_BIT);let p=!1;for(let i=0;i<s;i++){const s=r[i];s.material.shouldRender(e)&&(p=p||s.materialRenderer.render(t.slot,e.pass,t))}if(this.rctx.bindFramebuffer(a),this.rctx.setViewport(o.x,o.y,o.width,o.height),!p)return;const{searchRadius:d,minDensity:l,maxDensity:u,fieldTotal:_,colorRampData:g}=h,R=this._heatmapParameters;if(R.searchRadius=d,R.fieldTotal=_,R.searchRadius=d,R.minDensity=l,R.maxDensity=u,i(g)&&g!==this._colorRampData){const{colorRamp:e}=R,t=e.descriptor.width,r=g.length/4;r!==t&&e.resize(r,1),e.setData(g),this._colorRampData=g}this.rctx.bindVAO(this._quad),this.rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this.rctx),this._technique.bindPass(R,t),this.rctx.drawArrays(this._technique.primitiveType,0,T(this._quad,"geometry"))}};function D(e){return n(e.material)}b=e([s("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],b);export{b as DrapedHeatmapRenderer};
