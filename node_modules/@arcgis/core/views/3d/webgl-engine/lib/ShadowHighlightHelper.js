/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{smoothstep as t,clamp as i}from"../../../../core/mathUtils.js";import{isNone as e,disposeMaybe as s,releaseMaybe as a}from"../../../../core/maybe.js";import{n as r,s as o,d as h}from"../../../../chunks/vec3.js";import{c}from"../../../../chunks/vec3f64.js";import{f as n}from"../../../../chunks/vec4f32.js";import{ViewingMode as m}from"../../../ViewingMode.js";import{createQuadVAO as p}from"./glUtil3D.js";import{ShadowHighlightTechnique as _}from"../shaders/ShadowHighlightTechnique.js";import{vertexCount as d}from"../../../webgl/Util.js";const u=.001953125,l=4e4,v=5e4;class y{constructor(t,i){this._rctx=t,this._viewingMode=i,this._maxOpacity=1,this._parameters={shadowColor:n(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1,opacityElevation:1,dayNightTerminator:1},this._vao=p(this._rctx)}get technique(){return e(this._technique)&&(this._technique=new _({rctx:this._rctx,viewingMode:this._viewingMode})),this._technique}render(t,i){if(!t.shadowMap.enabled||!t.linearDepthTexture||!this.isVisible)return;const e=this.technique;this._rctx.bindFramebuffer(i),this._rctx.useTechnique(e),e.bindPass(this._parameters,t),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,d(this._vao,"geometry"))}get gpuMemoryUsage(){var t,i;return null!=(t=null==(i=this._vao)?void 0:i.size)?t:0}setDefaultOptions(t){this._parameters={...this._parameters,...t},this._updateMaxOpacity()}updateParameters(e,s){this._parameters.opacityElevation=1-t(l,v,e.relativeElevation);const a=this._viewingMode===m.Global?r(g,e.center):o(g,0,0,1),c=h(a,s);this._parameters.dayNightTerminator=t(0,1,i(30*c,0,1))}dispose(){this._vao=s(this._vao),this._technique=a(this._technique)}get isVisible(){const{opacityElevation:t,dayNightTerminator:i}=this._parameters;return this._maxOpacity*t*i>=u}_updateMaxOpacity(){const t=this._parameters,i=t.shadowColor,e=Math.max(t.shadowOpacity,t.occludedShadowOpacity);this._maxOpacity=e*i[3]}}const g=c();export{y as ShadowHighlightHelper};
