/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import e from"../../../../core/Evented.js";import t from"../../../../core/Handles.js";import{isSome as s,isNone as r,destroyMaybe as i}from"../../../../core/maybe.js";import o from"../../../../core/PooledArray.js";import{UpdatePolicy as a}from"./basicInterfaces.js";import{ContentObject as c}from"./ContentObject.js";import{ContentObjectType as h}from"./ContentObjectType.js";import{DirtyEventNames as n}from"./DirtyEvents.js";import l from"./Octree.js";class d extends c{constructor(s,r=""){var i,c,n;super(),this.apiLayerUid=r,this.type=h.Layer,this.events=new e,this.isSliceable=!1,this._objects=new o,this._stageHandles=new t,this.apiLayerUid=r,this.isVisible=null==(i=null==s?void 0:s.isVisible)||i,this.isPickable=null==(c=null==s?void 0:s.isPickable)||c,this.updatePolicy=null!=(n=null==s?void 0:s.updatePolicy)?n:a.ASYNC}get objects(){return this._objects}destroy(){this.detachStage(),this._stage=null}attachStage(e){this.detachStage(),this._stage=e;for(const t of n)this._stageHandles.add(this.events.on(t,(s=>e.handleEvent(t,s))))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),s(this._octree)&&this._octree.add([e])}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),s(this._octree)&&this._octree.remove([e]))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),s(this._octree)&&this._octree.add(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),s(this._octree)&&this._octree.remove(t)}}sync(){s(this._stage)&&this.updatePolicy!==a.SYNC&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){s(this._octree)&&this._octree.update(e,t)}getSpatialQueryAccelerator(){return r(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=i(this._octree)}_createOctree(){this._octree=new l((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)}}function y(e){return s(e)&&e.type===h.Layer}export{d as WebGLLayer,y as isWebGLLayer};
