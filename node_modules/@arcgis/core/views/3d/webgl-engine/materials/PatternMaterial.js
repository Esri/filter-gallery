/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{BufferViewMat3f as e,BufferViewVec4f as t,BufferViewVec4u8 as r,BufferViewVec3f as i}from"../../../../geometry/support/buffer/BufferView.js";import{newLayout as s}from"../../support/buffer/InterleavedLayout.js";import{ShaderOutput as a}from"../core/shaderLibrary/ShaderOutputOptions.js";import{CullFaceOptions as n}from"../lib/basicInterfaces.js";import o from"../lib/GLMaterial.js";import{outputFromPass as l}from"../lib/GLMaterials.js";import{DefaultMaterialParameters as u,Material as c}from"../lib/Material.js";import{OITPolygonOffsetLimit as h}from"../lib/OrderIndependentTransparency.js";import{RenderSlot as p}from"../lib/RenderSlot.js";import{assert as f}from"../lib/Util.js";import{VertexAttribute as m}from"../lib/VertexAttribute.js";import{Style as d}from"./PatternStyle.js";import{writeBufferVec4 as g,writeColor as b,writePosition as C}from"./internal/bufferWriterUtils.js";import{DefaultBufferWriter as A}from"./internal/DefaultBufferWriter.js";import{intersectTriangleGeometry as P}from"./internal/MaterialUtil.js";import{patternVertexAttributeLocations as O,PatternTechniqueConfiguration as E,PatternTechnique as T}from"../shaders/PatternTechnique.js";class q extends c{constructor(e){super(e,R),this.supportsEdges=!0,this._vertexAttributeLocations=O,this.techniqueConfig=new E}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.style=this.parameters.style,this.techniqueConfig.patternSpacing=this.parameters.patternSpacing,this.techniqueConfig.lineWidth=this.parameters.lineWidth,this.techniqueConfig.draped=this.parameters.draped,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<h,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(e,t,r,i,s,a,n){P(e,t,i,s,a,void 0,n)}requiresSlot(e,t){if(e===p.DRAPED_MATERIAL)return!0;if(l(t)===a.Highlight)return e===p.OPAQUE_MATERIAL;return e===(this.parameters.writeDepth?p.TRANSPARENT_MATERIAL:p.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}createGLMaterial(e){return e.output===a.Color||e.output===a.Alpha||e.output===a.Highlight||e.output===a.Depth&&this.parameters.writeLinearDepth?new y(e):null}createBufferWriter(){const e=s().vec3f(m.POSITION).vec4u8(m.COLOR).vec4f(m.UVMAPSPACE);return this.parameters.draped||e.mat3f(m.BOUNDINGRECT),new S(e)}}class y extends o{updateParameters(e){return this.ensureTechnique(T,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==a.Color&&this._output!==a.Alpha||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}class S extends A{write(s,a,n,o){for(const l of this.vertexBufferLayout.fieldNames){const u=a.vertexAttributes.get(l),c=a.indices.get(l);if(u&&c)switch(l){case m.POSITION:{f(3===u.size);const e=n.getField(l,i);e&&C(c,u.data,s.transformation,e,o);break}case m.COLOR:{f(3===u.size||4===u.size);const e=n.getField(l,r);e&&b(c,u.data,u.size,e,o);break}case m.UVMAPSPACE:{f(4===u.size);const e=n.getField(l,t);e&&g(c,u.data,e,o);break}case m.BOUNDINGRECT:{f(9===u.size);const t=n.getField(l,e);t&&this.writeBoundingRect(c,u.data,s.transformation,t,o);break}}}}writeBoundingRect(e,t,r,i,s){const a=r,n=i.typedBuffer,o=i.typedBufferStride,l=e.length;s*=o;for(let u=0;u<l;++u){const r=9*e[u],i=t[r],l=t[r+1],c=t[r+2];n[s]=a[0]*i+a[4]*l+a[8]*c+a[12],n[s+1]=a[1]*i+a[5]*l+a[9]*c+a[13],n[s+2]=a[2]*i+a[6]*l+a[10]*c+a[14];for(let e=3;e<9;++e)n[s+e]=t[r+e];s+=o}}}const R={color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:n.None,sceneHasOcludees:!1,style:d.Cross,patternSpacing:10,lineWidth:1,draped:!0,...u};export{q as PatternMaterial};
