/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import t from"../../../../../core/PooledArray.js";import{h as n,d as r}from"../../../../../chunks/mat3.js";import{c as e}from"../../../../../chunks/mat3f64.js";import{c as o}from"../../../../../chunks/quat.js";import{a}from"../../../../../chunks/quatf64.js";import{d as s,v as c,q as f,b as l,s as u,e as i,g as h,t as m}from"../../../../../chunks/vec3.js";import{c as p}from"../../../../../chunks/vec3f64.js";import{signedDistance as d}from"../../../../../geometry/support/plane.js";import{projectedRadius as g,intersectPlane as j}from"../../../support/orientedBoundingBox.js";import{empty as b,within as k,union as w}from"../../lib/depthRange.js";function z(t,n){const r=b(),{eye:e,frustum:o,viewForward:a}=t;n.forAll((t=>{const n=t.obb,f=s(c(E,n.center,e),a),l=g(n,a);if(k(r,f-l)&&k(r,f+l))return;const u=R(n,o);if(-1===u)return;if(0===u)return q.far=f+l,q.near=f-l,void w(r,q);const i=S.pushNew();i.near=f-l,i.far=f+l,i.mask=u,i.object=t}));for(let f=0;f<S.length;f++){const t=S.data[f];if(k(r,t.near)&&k(r,t.far))continue;q.far=t.far,q.near=1/0;const n=M(t.object.obb,e,A,(n=>{let r=x;for(let e=0;e<P&&n.length>0;e++){if(0==(t.mask&1<<e))continue;B(o[e],n,r);const a=n;n=r,r=a}for(let t=0;t<n.length;t+=3){u(v,n.data[t+0],n.data[t+1],n.data[t+2]);const r=s(c(v,v,e),a);q.near=Math.min(q.near,r)}}));0===n&&(q.near=0),w(r,q)}return S.length=0,r}const S=new t({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),q=b(),v=p(),y=p(),A=new t({deallocator:null}),x=new t({deallocator:null});function B(t,n,r){r.length=0;const e=n.length-3;F(v,n,e);const o=d(t,v);o<=0&&(r.push(v[0]),r.push(v[1]),r.push(v[2]));let a=0,s=o;for(;a<e;a+=3){F(y,n,a);const e=d(t,y);if(s*e<0){i(v,y,v,e/(e-s)),I(r,v)}e<=0&&I(r,y),s=e,h(v,y)}if(s*o<0){F(y,n,e);i(v,y,v,o/(o-s)),I(r,v)}}function F(t,n,r){return u(t,n.data[r+0],n.data[r+1],n.data[r+2])}function I(t,n){t.push(n[0]),t.push(n[1]),t.push(n[2])}function M(t,e,a,s){o(D,t.quaternion),c(E,e,t.center),f(E,E,D);const i=8*((E[0]<-t.halfSize[0]?-1:E[0]>t.halfSize[0]?1:0)+3*(E[1]<-t.halfSize[1]?-1:E[1]>t.halfSize[1]?1:0)+9*(E[2]<-t.halfSize[2]?-1:E[2]>t.halfSize[2]?1:0)+13),h=N[i];if(0===h)return h;n(C,t.quaternion),r(C,C,t.halfSize);const p=(n,r)=>{const e=N[i+r+1];return u(n,((1&e)<<1)-1,(2&e)-1,((4&e)>>1)-1),m(n,n,C),l(n,t.center,n)};return a.length=0,I(a,p(G,0)),I(a,p(H,1)),I(a,p(E,2)),I(a,p(J,3)),s(a),1===h?h:(a.length=0,I(a,G),I(a,J),I(a,p(E,4)),I(a,p(K,5)),s(a),2===h||(a.length=0,I(a,G),I(a,K),I(a,p(E,6)),I(a,H),s(a)),h)}const N=(()=>{const t=new Int8Array(216);let n=0;const r=r=>{for(let e=0;e<r.length;e++)t[n+e]=r[e];n+=8};return r([3,0,6,2,3,1,5,4]),r([2,0,2,3,1,5,4,0]),r([3,1,0,2,3,7,5,4]),r([2,0,1,3,2,6,4,0]),r([1,0,1,3,2,0,0,0]),r([2,1,5,7,3,2,0,0]),r([3,2,0,1,3,7,6,4]),r([2,2,0,1,3,7,6,0]),r([3,3,0,1,5,7,6,2]),r([2,0,1,5,4,6,2,0]),r([1,0,1,5,4,0,0,0]),r([2,1,3,7,5,4,0,0]),r([1,0,2,6,4,0,0,0]),r([0,0,0,0,0,0,0,0]),r([1,1,3,7,5,0,0,0]),r([2,2,3,7,6,4,0,0]),r([1,2,3,7,6,0,0,0]),r([2,3,1,5,7,6,2,0]),r([3,4,0,1,5,7,6,2]),r([2,5,7,6,4,0,1,0]),r([3,5,0,1,3,7,6,4]),r([2,4,5,7,6,2,0,0]),r([1,4,5,7,6,0,0,0]),r([2,5,1,3,7,6,4,0]),r([3,6,0,2,3,7,5,4]),r([2,6,2,3,7,5,4,0]),r([3,7,6,2,3,1,5,4]),t})(),P=4;function R(t,n){let r=0;for(let e=0;e<P;e++){const o=j(t,n[e]);if(o>0)return-1;0===o&&(r|=1<<e)}return r}const C=e(),D=a(),E=p(),G=p(),H=p(),J=p(),K=p();export{z as computeDepthRange};
