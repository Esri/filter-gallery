/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isNone as r,isSome as e}from"../../../../core/maybe.js";import{j as t,a as i}from"../../../../chunks/mat4.js";import{c as o}from"../../../../chunks/mat4f64.js";import{a}from"../../../../chunks/vec2f64.js";import{m as s,n as h}from"../../../../chunks/vec3.js";import{c as n}from"../../../../chunks/vec3f64.js";import{c as m}from"../../../../chunks/vec4f64.js";import{ReloadableShaderModule as p}from"../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as l}from"../core/shaderTechnique/ShaderTechnique.js";import{Default3D as c}from"../lib/DefaultVertexAttributeLocations.js";import{Program as g}from"../lib/Program.js";import{inverseProjectionInfo as d}from"../lib/Util.js";import{S as f}from"../../../../chunks/ShadowHighlight.glsl.js";import{BlendFactor as u,PrimitiveType as T}from"../../../webgl/enums.js";import{makePipelineState as x,separateBlendingParams as w,defaultColorWriteParams as j}from"../../../webgl/renderState.js";const S=0,b=1;class v extends l{constructor(r){super(r,null,(()=>this.destroy()))}initializeProgram(r){const e=v.shader.get().build({highlightedThreshold:.99999,selfShadowThreshold:.025});return new g(r.rctx,e,c)}initializePipeline(r){return x({blending:w(u.SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA),colorWrite:j,depthTest:null,depthWrite:null})}bindPass(o,a){if(r(a.linearDepthTexture))return;this.program.bindTexture(a.linearDepthTexture,"depthMap"),this.program.bindTexture(a.highlightColorTexture,"highlightMap"),s(M,a.lighting.lightingMainDirection,a.camera.viewInverseTransposeMatrix),h(M,M),d(a.camera.projectionMatrix,a.camera.fullWidth,a.camera.fullHeight,y,U),t(D,a.camera.viewMatrix,a.camera.center),i(D,D),this.program.setUniform4fv("uColor",o.shadowColor),this.program.setUniform1f("opacity",o.shadowOpacity),this.program.setUniform1f("occludedOpacity",o.occludedShadowOpacity),this.program.setUniform1f("terminationFactor",o.opacityElevation*o.dayNightTerminator),this.program.setUniform2fv("nearFar",a.camera.nearFar),this.program.setUniformMatrix4fv("inverseViewMatrix",D),this.program.setUniform4fv("projInfo",y),this.program.setUniform2fv("zScale",U),this.program.setUniform3fv("lightingMainDirectionView",M),this.program.setUniform2f("texelSize",1/a.linearDepthTexture.descriptor.width,1/a.linearDepthTexture.descriptor.height),a.shadowMap.bind(this.program),a.shadowMap.bindView(this.program,a.camera.center);let n=a.shadowMap.getSnapshot(S);e(n)&&this.program.bindTexture(n,"highlightDepthTex"),n=a.shadowMap.getSnapshot(b),e(n)&&this.program.bindTexture(n,"defaultDepthTex")}get primitiveType(){return T.TRIANGLE_STRIP}}v.shader=new p(f,(()=>import("./ShadowHighlight.glsl.js")));const M=n(),U=a(),y=m(),D=o();export{b as DefaultSnapshotSlot,S as HighlightShadowMapSlot,v as ShadowHighlightTechnique};
