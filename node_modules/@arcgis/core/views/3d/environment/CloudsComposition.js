/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as a}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import{clamp as e}from"../../../core/mathUtils.js";import{releaseMaybe as r,disposeMaybe as s,isNone as i}from"../../../core/maybe.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as n}from"../../../core/accessorSupport/decorators/subclass.js";import{a as m,e as h}from"../../../chunks/mat4.js";import{c as p}from"../../../chunks/mat4f64.js";import{y as c,g as _,l as f,n as d,a as l,f as u}from"../../../chunks/vec3.js";import{c as I,f as F}from"../../../chunks/vec3f64.js";import{create as g,fromPoints as H,axis as O}from"../../../geometry/support/axisAngle.js";import{CloudsCompositionTechnique as x}from"./CloudsCompositionTechnique.js";import{weatherHeightLimit as E}from"./weather.js";import{createQuadVAO as D}from"../webgl-engine/lib/glUtil3D.js";import{PrimitiveType as N}from"../../webgl/enums.js";let C=class extends t{constructor(a){super(a),this._inverseProjectionMatrix=p(),this._inverseViewMatrix=p(),this._technique=new x(a),this._vao=D(a.rctx),this._setDefaultParallax(a.radius)}destroy(){this._technique=r(this._technique),this._vao=s(this._vao)}render(a,t,e){this._parameters.clouds=t;const r=a.camera;if(i(this._vao)||i(r))return;const s=a.rctx,o=s.useTechnique(this._technique);a.scenelightingData.setLightDirectionUniform(o),a.scenelightingData.setUniforms(o,!1,!1),m(this._inverseProjectionMatrix,r.projectionMatrix),m(this._inverseViewMatrix,r.viewMatrix),o.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),o.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),o.setUniform2f("cloudVariables",this._parameters.clouds.coverage,this._parameters.clouds.absorption),this._setParallaxParams(r.eye,e),a.cloudsCompositionParams=this._parameters,T(o,r,this._parameters),s.bindVAO(this._vao),o.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(N.TRIANGLE_STRIP,0,4)}get isFading(){return this._parameters.crossFade.stage!==P.FINISHED||this._parameters.fadeInOut.stage!==A.FINISHED||this._parameters.fadeIn.stage!==S.FINISHED||this._parameters.fadeInOutHeight.stage!==v.FINISHED}_setDefaultParallax(a){this._parameters={parallax:{anchorPointClouds:I(),radius:a,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:p()},parallaxNew:{anchorPointClouds:I(),radius:a,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:p()},crossFade:{stage:P.FINISHED,factor:0,distanceThresholdFactor:.3},fadeInOut:{stage:A.FINISHED,factor:0,distanceThresholdFactor:.6},fadeIn:{stage:S.FINISHED,factor:0,distanceThresholdFactor:2},fadeInOutHeight:{stage:v.FINISHED,factor:-1},cameraPositionLastFrame:I(),startTime:0,startTimeHeightFade:0,clouds:null}}_isCameraPositionFinal(a){return c(this._parameters.cameraPositionLastFrame,a)}_setFadeInStage(a){const t=this._isCameraPositionFinal(a);this._parameters.fadeIn.stage===S.FINISHED&&(this._parameters.fadeIn.factor=1,_(this._parameters.parallax.anchorPointClouds,j),this._parameters.fadeIn.stage=S.CHANGE_ANCHOR,this._parameters.crossFade.stage=P.FINISHED,this._parameters.fadeInOut.stage=A.FINISHED),this._parameters.fadeIn.stage===S.CHANGE_ANCHOR&&t&&(_(this._parameters.parallax.anchorPointClouds,j),this._parameters.fadeIn.stage=S.FADE_IN,this._parameters.startTime=performance.now()),this._parameters.fadeIn.factor>0&&this._parameters.fadeIn.stage===S.FADE_IN&&(this._parameters.fadeIn.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeIn.factor<=0&&this._parameters.fadeIn.stage===S.FADE_IN&&(this._parameters.fadeIn.stage=S.FINISHED,this._parameters.fadeIn.factor=0)}_setCrossFadingStage(){this._parameters.crossFade.stage===P.FINISHED&&(_(this._parameters.parallaxNew.anchorPointClouds,j),this._parameters.startTime=performance.now(),this._parameters.crossFade.factor=0,this._parameters.crossFade.stage=P.CROSS_FADE),this._parameters.crossFade.factor<1&&this._parameters.crossFade.stage===P.CROSS_FADE&&(this._parameters.crossFade.factor=(performance.now()-this._parameters.startTime)/500),this._parameters.crossFade.factor>=1&&this._parameters.crossFade.stage===P.CROSS_FADE&&(this._parameters.crossFade.stage=P.FINISHED,this._parameters.crossFade.factor=1,_(this._parameters.parallax.anchorPointClouds,this._parameters.parallaxNew.anchorPointClouds))}_setFadeInOutStage(a){this._parameters.fadeInOut.stage===A.FINISHED&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=0,this._parameters.fadeInOut.stage=A.FADE_OUT),this._parameters.fadeInOut.factor<1&&this._parameters.fadeInOut.stage===A.FADE_OUT&&(this._parameters.fadeInOut.factor=(performance.now()-this._parameters.startTime)/250),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===A.FADE_OUT&&(this._parameters.fadeInOut.factor=1,_(this._parameters.parallax.anchorPointClouds,j)),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===A.FADE_OUT&&this._isCameraPositionFinal(a)&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=1,this._parameters.fadeInOut.stage=A.FADE_IN,this._parameters.crossFade.stage=P.FINISHED,this._parameters.crossFade.factor=0),this._parameters.fadeInOut.factor>0&&this._parameters.fadeInOut.stage===A.FADE_IN&&(this._parameters.fadeInOut.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeInOut.factor<=0&&this._parameters.fadeInOut.stage===A.FADE_IN&&(this._parameters.fadeInOut.stage=A.FINISHED,this._parameters.fadeInOut.factor=0)}_setFadeInOutHeight(a){const t=performance.now();this._parameters.startTimeHeightFade=this._parameters.fadeInOutHeight.stage===v.FINISHED?t:this._parameters.startTimeHeightFade,a?this._parameters.fadeInOutHeight.factor+=(t-this._parameters.startTimeHeightFade)/500:this._parameters.fadeInOutHeight.factor-=(t-this._parameters.startTimeHeightFade)/500,this._parameters.startTimeHeightFade=t,this._parameters.fadeInOutHeight.factor=e(this._parameters.fadeInOutHeight.factor,0,1),this._parameters.fadeInOutHeight.stage=v.HEIGHT_FADE}_setParallaxParams(a,t){this._parameters.fadeInOutHeight.factor<0&&(this._parameters.fadeInOutHeight.factor=f(a)-this._parameters.parallax.radius>E?1:0),d(j,a),l(j,j,this._parameters.parallax.radius),0===this._parameters.parallax.anchorPointClouds[0]&&0===this._parameters.parallax.anchorPointClouds[1]&&0===this._parameters.parallax.anchorPointClouds[2]&&_(this._parameters.parallax.anchorPointClouds,j);const e=f(u(M,this._parameters.parallax.anchorPointClouds,j));let r=!0;e>this._parameters.fadeIn.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeIn.stage!==S.FINISHED?this._setFadeInStage(a):e>this._parameters.fadeInOut.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeInOut.stage!==A.FINISHED?this._setFadeInOutStage(a):e>this._parameters.crossFade.distanceThresholdFactor*this._parameters.parallax.cloudsHeight&&!t||this._parameters.crossFade.stage!==P.FINISHED?this._setCrossFadingStage():r=!1;const s=f(a),i=s-this._parameters.parallax.radius;(i>1.7*E||i<-E)&&this._parameters.fadeInOutHeight.factor<1?this._parameters.fadeInOutHeight.factor=1:(i>E||i<-.35*E)&&this._parameters.fadeInOutHeight.factor<1?this._setFadeInOutHeight(!0):i<E&&i>-.35*E&&this._parameters.fadeInOutHeight.factor>0?this._setFadeInOutHeight(!1):this._parameters.fadeInOutHeight.stage=v.FINISHED,this._parameters.parallax.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(s*s-this._parameters.parallax.radius*this._parameters.parallax.radius,0))/s,H(w,this._parameters.parallax.anchorPointClouds,U),this._parameters.parallax.transform=p(),h(this._parameters.parallax.transform,this._parameters.parallax.transform,U[3],O(U)),r&&(H(w,this._parameters.parallaxNew.anchorPointClouds,U),this._parameters.parallaxNew.transform=p(),h(this._parameters.parallaxNew.transform,this._parameters.parallaxNew.transform,U[3],O(U))),_(this._parameters.cameraPositionLastFrame,a)}};var S,A,P,v;function T(a,t,r){a.bindTexture(r.clouds.cubeMap.colorTexture,"cubeMap"),a.setUniform1f("cloudsHeight",r.parallax.cloudsHeight),a.setUniformMatrix4fv("rotationMatrixClouds",r.parallax.transform),a.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",r.parallaxNew.transform),a.setUniform3fv("anchorPosition",r.parallax.anchorPointClouds),a.setUniform3fv("anchorPositionCrossFade",r.parallaxNew.anchorPointClouds),r.fadeInOut.stage!==A.FINISHED?a.setUniform1f("totalFadeInOut",r.fadeInOutHeight.factor+Math.max(e(r.fadeInOut.factor,0,1))):a.setUniform1f("totalFadeInOut",r.fadeInOutHeight.factor+Math.max(e(r.fadeIn.factor,0,1))),a.setUniform1f("radiusCurvatureCorrectionFactor",r.parallax.radiusCurvatureCorrectionFactor),a.setUniform1i("crossFade",r.crossFade.stage),a.setUniform1f("crossFadeAnchorFactor",e(r.crossFade.factor,0,1)),a.setUniform1f("radius",r.parallax.radius),a.setUniform3fv("cameraPosition",t.eye)}a([o({constructOnly:!0})],C.prototype,"rctx",void 0),a([o({constructOnly:!0})],C.prototype,"viewingMode",void 0),a([o({constructOnly:!0})],C.prototype,"radius",void 0),C=a([n("esri.views.3d.environment.CloudsComposition")],C),function(a){a[a.FINISHED=0]="FINISHED",a[a.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",a[a.FADE_IN=2]="FADE_IN"}(S||(S={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.FADE_OUT=1]="FADE_OUT",a[a.FADE_IN=2]="FADE_IN"}(A||(A={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.CROSS_FADE=1]="CROSS_FADE"}(P||(P={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.HEIGHT_FADE=1]="HEIGHT_FADE"}(v||(v={}));const w=F(0,0,1),U=g(),j=I(),M=I();export{C as CloudsComposition,T as bindCloudsComposition};
