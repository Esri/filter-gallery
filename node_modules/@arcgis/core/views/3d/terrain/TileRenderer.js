/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{nextHighestPowerOfTwo as e}from"../../../core/mathUtils.js";import{disposeMaybe as t,releaseMaybe as r,isNone as i,isSome as s}from"../../../core/maybe.js";import{s as o,c as a}from"../../../chunks/vec2.js";import{Z as n}from"../../../chunks/vec2f64.js";import{f as u}from"../../../chunks/vec3f64.js";import{f as l}from"../../../chunks/vec4f64.js";import{isBaseLayer as c}from"../../../layers/support/layerUtils.js";import{RasterColorizerStretchType as h}from"../../2d/engine/imagery/enums.js";import{VectorTileRendererHelper3D as _}from"../../2d/engine/vectorTiles/VectorTileRendererHelper3D.js";import{ImageWithType as f}from"../support/StreamDataLoader.js";import{BlendLayersTechniqueConfiguration as d,BlendLayersTechnique as p}from"./BlendLayersTechnique.js";import{TextureUpdate as T}from"./interfaces.js";import{LayerClass as m}from"./LayerClass.js";import"../../../core/arrayUtils.js";import"../../../geometry/support/aaBoundingBox.js";import"../support/buffer/glUtil.js";import"./PatchGeometryFactory.js";import{ActivationTime as y}from"./TextureFader.js";import"../../../core/HeapSort.js";import"../webgl-engine/lib/DefaultVertexAttributeLocations.js";import"../../webgl/BufferObject.js";import"../../webgl/VertexArrayObject.js";import{RasterColorizerTechniqueConfiguration as x,RasterColorizerTechnique as b}from"./RasterColorizerTechnique.js";import{isVectorTileLayerView as g,isVectorTileRenderInfo as I,isImageryTileRenderInfo as w,isRasterTileRenderInfo as R,isTextureTileRenderInfo as L}from"./terrainUtils.js";import{TextureReference as E}from"./TextureReference.js";import D from"./TileTexture.js";import{TileUpdate as A}from"./TileUpdate.js";import{FBOPool as P}from"./support/FBOPool.js";import{BlendMode as j}from"../webgl-engine/core/shaderLibrary/output/BlendOptions.js";import{Pos2Tex as q}from"../webgl-engine/lib/DefaultVertexBufferLayouts.js";import{createQuadVAO as O,createColorTexture as k,createEmptyTexture as C}from"../webgl-engine/lib/glUtil3D.js";import{ClearBufferBit as U,TextureSamplingMode as B,PrimitiveType as F,TextureType as M,PixelFormat as N,PixelType as S,TextureWrapMode as z}from"../../webgl/enums.js";import{Texture as v}from"../../webgl/Texture.js";import{vertexCount as G}from"../../webgl/Util.js";class V{constructor(e,t,r){this._rctx=e,this.tileSize=t,this._techniqueRepository=r,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new _,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=O(this._rctx,q),this._blackTex=new D(k(this._rctx,[0,0,0,1])),this._fboPool=new P(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=t(this._vaoQuad),this._backgroundTexture=r(this._backgroundTexture),this._blackTex=r(this._blackTex),this._blendLayersTechnique=r(this._blendLayersTechnique),this._applyOpacityTechnique=r(this._applyOpacityTechnique),this._vectorTileHelper=t(this._vectorTileHelper)}get blendLayersTechnique(){if(i(this._blendLayersTechnique)){const e=new d;e.mode=j.OneMinusSourceAlpha,this._blendLayersTechnique=this._techniqueRepository.acquire(p,e)}return this._blendLayersTechnique}get applyOpacityTechnique(){if(i(this._applyOpacityTechnique)){const e=new d;e.mode=j.SourceAlpha,this._applyOpacityTechnique=this._techniqueRepository.acquire(p,e)}return this._applyOpacityTechnique}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){const r=e.layerInfo[m.MAP];for(const s of r)s.pendingUpdates&=~(A.TEXTURE_NOFADING&A.TEXTURE_FADING);if(!e.renderData)return;const i=e.surface,o=i.baseOpacity;let a=0,n=0,u=this.tileSize,l=!1;const h=i.view.pixelRatio;let _=r.length,f=0;for(;f<r.length&&!l;f++){const t=i.layerViewByIndex(f,m.MAP),s=t.fullOpacity;if(X[f]=s,c(t.layer)&&_>=r.length&&(_=f),0===s)continue;++n;const d=Q(e,f,W);d&&(g(t)?u=Math.max(u,this.tileSize*h):1===o&&1===s&&(t.isOpaque||this._dataToTexture(d)&&d.sourceLayerInfo.data.descriptor.isOpaque)&&(l=!0),++a)}this._cleanupFBOPool(h,r.length),u=H(u);const d=u/this.tileSize,p=f-1;0!==a?1===a&&(l||this._backgroundIsGrid||s(this._backgroundColor))&&this._useLayerTexture(e,p,_,X[p])||this._composeMapLayers(e,t,p,_,l,X,u,d):this._useBackgroundTexture(e,n)}_useBackgroundTexture(e,t){let r=y.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(r=y.Delayed),this._backgroundTexture&&i(e.renderData.textureReference)&&(r=y.Immediate),e.renderData.setTextureReference(s(this._backgroundTexture)?new E(this._backgroundTexture,T.FADING,Y,e.surface.baseOpacity,1,1,!1):null,r)}_useLayerTexture(e,t,r,i){const s=t<r,o=s?1:e.surface.baseOpacity,a=s?e.surface.baseOpacity:1,n=Q(e,t,W);return!!this._dataToTexture(n)&&(e.renderData.setTextureReference(new E(n.sourceLayerInfo.data,T.FADING,n,o,i,a,!0)),!0)}_composeMapLayers(e,t,r,i,o,a,u,l){const c=this._rctx,h=this._fboPool.acquire(u);c.bindFramebuffer(h),c.setViewport(0,0,u,u),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(U.COLOR_BUFFER_BIT|U.DEPTH_BUFFER_BIT);let _=!1;!o&&s(this._backgroundTexture)&&this._drawRasterData(this.blendLayersTechnique,this._backgroundTexture.texture,1,n);const f=e.surface.baseOpacity;let d=!1,p=B.LINEAR_MIPMAP_LINEAR;for(let s=r;s>=0;s--){const t=Q(e,s,W);t&&(s<i&&f<1&&!d&&(this._drawRasterData(this.applyOpacityTechnique,this._blackTex.texture,1,n,f),d=!0),0!==a[s]&&(I(t)?_=this._drawVectorData(this.blendLayersTechnique,t,l,a[s],u,h,_):w(t)?(this._drawImageryTileData(t,a[s]),this._hasNearestInterpolation(t)&&(p=B.NEAREST)):this._dataToTexture(t)&&this._drawRasterData(this.blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,a[s])))}const T=e.renderData.ensureTexture(u,(()=>this._buildTexture(u,p))),m=c.bindTexture(T.texture,v.TEXTURE_UNIT_FOR_UPDATES),y=T.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,y.pixelFormat,0,0,y.width,y.height,0),T.generateMipmap(),c.bindTexture(m,v.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(null),this._fboPool.release(h);const x=d?1:f;e.renderData.setTextureReference(new E(T,t,Y,x,1,1,!1))}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(F.TRIANGLE_STRIP,0,G(this._vaoQuad,"geometry"))}_drawRasterData(e,t,r,s,o=1){if(i(t))return;const a=this._rctx.useTechnique(e);a.bindTexture(t,"tex"),a.setUniform1f("scale",r),a.setUniform2f("offset",s[0],s[1]),a.setUniform1f("opacity",o),this._drawQuad(a)}_hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}_drawImageryTileData(e,t=1){const r=e.sourceLayerInfo.data;if(!r.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,m.MAP).ensureSymbolizerParameters(r);const i=this._getRasterColorizerTechnique(r),s=this._rctx,o=s.useTechnique(i);if(!r.bind(s))return;r.opacity=t,r.scale=e.scale,r.offset=e.offset;const{names:a,textures:n}=r.getTextures();a.forEach(((e,t)=>o.bindTexture(n[t],e))),i.bindPass(r.getUniforms()),this._drawQuad(o),s.bindVAO()}_getRasterColorizerTechnique(e){const t=e.symbolizerParameters,r=["stretch","lut","hillshade"].indexOf(t.type);return i(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new x,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=!!t.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?h.Noop:h.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(b,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,t,r,i,o,a,n){const u=this._rctx,l=t.sourceLayerInfo.data,c=t.tile.surface.layerViewByIndex(t.layerIndex,m.MAP);let h;return e.bindPipelineState(u),i<1?(h=this._fboPool.acquire(o),u.bindFramebuffer(h),u.setClearColor(1,1,1,0),u.clearSafe(U.COLOR_BUFFER_BIT|U.DEPTH_BUFFER_BIT)):n&&u.clearSafe(U.DEPTH_BUFFER_BIT),this._vectorTileHelper.render(u,t.sourceLod,l,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!s(h)||(u.bindFramebuffer(a),this._drawRasterData(e,h.colorTexture,1,[0,0],i),this._fboPool.release(h),n)}_dataToTexture(e){return R(e)&&this._rasterDataToTexture(e),L(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}setBackground(e,t){r(this._backgroundTexture),this._backgroundIsGrid=t,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new D(k(this._rctx,l(e[0]||0,e[1]||0,e[2]||0,1))),this._backgroundColor=u(e[0]||0,e[1]||0,e[2]||0))}_buildTexture(e,t=B.LINEAR_MIPMAP_LINEAR){if(i(e))return null;const r={target:M.TEXTURE_2D,pixelFormat:N.RGBA,dataType:S.UNSIGNED_BYTE,wrapMode:z.CLAMP_TO_EDGE,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},s=this._rctx;let o;if("number"==typeof e)r.width=r.height=e,o=new D(new v(s,r));else if(e instanceof f)r.isOpaque=e.isOpaque,o=new D(new v(s,r,e.image)),e.release();else try{o=new D(new v(s,r,e))}catch(n){o=new D(C(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const a=s.bindTexture(o.texture,v.TEXTURE_UNIT_FOR_UPDATES);return o.generateMipmap(),s.bindTexture(a,v.TEXTURE_UNIT_FOR_UPDATES),o}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)}get test(){return{backgroundTexture:this._backgroundTexture}}}function H(t){const r=e(t),i=r*r,s=t*t;if(i===s)return t;const o=r/2;return i-s<s-o*o?r:o}function Q(e,t,r){r.layerIndex=t;const i=e.layerInfo[m.MAP][t];if(i.data)return o(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=i,r;const s=i.upsampleInfo;if(s){const e=s.tile.layerInfo[m.MAP][t];return r.tile=s.tile,a(r.offset,s.offset),r.scale=s.scale,r.sourceLod=s.tile.lij,r.sourceLayerInfo=e,r}return null}const X=new Array,W={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},Y={offset:[0,0],scale:1};export{V as TileRenderer};
