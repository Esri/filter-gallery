/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{nextHighestPowerOfTwo as e}from"../../../core/mathUtils.js";import{create as t,offset as r,copy as s}from"../../../geometry/support/aaBoundingRect.js";import{RenderTargetType as i,OverlayIndex as a}from"./interfaces.js";import{ValidationState as n}from"../webgl-engine/lib/basicInterfaces.js";import{fromValues as o}from"../webgl-engine/lib/LocalOriginFactory.js";var h;!function(e){e[e.None=0]="None",e[e.ColorAndWater=1]="ColorAndWater",e[e.Highlight=2]="Highlight",e[e.Occluded=3]="Occluded"}(h||(h={}));class g{constructor(e,r){this.index=e,this.renderTargets=r,this.extent=t(),this.resolution=0,this.renderLocalOrigin=o(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new c,this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(r.renderTargets.length).fill(!1)}getValidTarget(e){return this.validTargets[e]?this.renderTargets.getTarget(e):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const t=e===h.ColorAndWater?this.renderTargets.getTarget(i.Color):e===h.Highlight?this.renderTargets.getTarget(i.Highlight):this.renderTargets.getTarget(i.Occluded);return t?t.getTexture():null}getNormalTexture(e){const t=e===h.ColorAndWater?this.renderTargets.getTarget(i.Water):null;return t?t.getTexture():null}draw(e,t){const r=this.computeRenderTargetValidityBitfield(),s=this.needsColorWithoutRasterImage;for(const a of this.renderTargets.renderTargets)a.type===i.ColorNoRasterImage&&!1===s?this.validTargets[a.type]=!1:this.validTargets[a.type]=e.drawTarget(this,a,t);return r^this.computeRenderTargetValidityBitfield()?n.CHANGED:n.UNCHANGED}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[i.Color]|+e[i.ColorNoRasterImage]<<1|+e[i.Highlight]<<2|+e[i.Water]<<3|+e[i.Occluded]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this.extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];r(this.extent,e.range,0,t)}if(this.extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];r(this.extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,s(this.canvasGeometries.extents[0],this.extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}applyViewport(e){e.setViewport(this.index===a.INNER?0:this.resolution,0,this.resolution,this.resolution)}}function l(t,r,s){return Math.min(e(Math.max(t,r)+256),s)}class c{constructor(){this.extents=[t(),t(),t()],this.numViews=0}}export{g as Overlay,h as OverlaySource,l as computeOverlayResolution};
