/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{clamp as t}from"../../../core/mathUtils.js";import{isNone as a}from"../../../core/maybe.js";import{bilerp as s}from"../support/mathUtils.js";import{ELEVATION_NODATA_VALUE as i}from"./TerrainConst.js";class o{constructor(t,a,s){this.type="elevation",this.samplerData=null,this.level=t[0],this.i=t[1],this.j=t[2],this.extent=a;const i=s.noDataValue,o=s.values;let e=1/0,l=-1/0,h=!0,r=!1;for(let n=0;n<o.length;n++){const t=o[n];t!==i?(e=t<e?t:e,l=t>l?t:l,h=!1):r=!0}h&&(e=0,l=0),l=l>-3e38?l:0,this.samplerData={pixelData:s.values,width:s.width,height:s.height,noDataValue:i,safeWidth:.99999999*(s.width-1),dx:(s.width-1)/(a[2]-a[0]),dy:(s.width-1)/(a[3]-a[1]),x0:a[0],y1:a[3]},this.bounds=[e,l],this.hasNoDataValues=r}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(t,a,o,e){e.min=1/0,e.max=-1/0,e.hasNoDataValues=!1;const l=t-this.level;if(l<=0)return e;const h=2**l;if(!(Math.floor(a/h)===this.i&&Math.floor(o/h)===this.j))return e;let r=1/0,n=-1/0;const f=this.samplerData.width,m=this.samplerData.pixelData,u=.5*i;let c=(f-1)/h,p=(o-this.j*h)*c,d=(a-this.i*h)*c;if(c<1){const t=Math.floor(p),a=Math.floor(d),i=t+a*f,o=m[i],l=m[i+1],h=m[i+f],r=m[i+f+1];if(o+l+h+r<u){const i=p-t,n=d-a,f=s(o,l,h,r,i,n),m=s(o,l,h,r,i+c,n),u=s(o,l,h,r,i,n+c),x=s(o,l,h,r,i+c,n+c);return e.min=Math.min(f,m,u,x),e.max=Math.max(f,m,u,x),e}p=t,d=a,c=1}else p=Math.floor(p),d=Math.floor(d),c=Math.ceil(c);for(let s=p;s<=p+c;s++)for(let t=d;t<=d+c;t++){const a=m[s+t*f];a<u?(r=Math.min(r,a),n=Math.max(n,a)):e.hasNoDataValues=!0}return e.min=r,e.max=n,e}}function e(s,o,e){if(a(e))return null;for(const a of e){if(!a)continue;const e=a.safeWidth;let l=t(a.dy*(a.y1-o),0,e),h=t(a.dx*(s-a.x0),0,e);const r=Math.floor(l),n=Math.floor(h),f=a.width,m=r*f+n,u=a.pixelData,c=u[m],p=u[m+1],d=m+f,x=u[d],M=u[d+1];if(c+x+p+M<.5*i){l-=r,h-=n;const t=c+(p-c)*h;return t+(x+(M-x)*h-t)*l}}return null}export{o as ElevationData,e as sampleElevation};
