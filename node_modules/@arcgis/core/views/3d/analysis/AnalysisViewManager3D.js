/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import s from"../../../core/Accessor.js";import t from"../../../core/Collection.js";import i from"../../../core/Error.js";import{HandleOwnerMixin as a}from"../../../core/HandleOwner.js";import n from"../../../core/Logger.js";import{isNone as r,isSome as o,removeMaybe as l,destroyMaybe as c,abortMaybe as d}from"../../../core/maybe.js";import{createTask as h,isAborted as u,createAbortError as w}from"../../../core/promiseUtils.js";import{schedule as m}from"../../../core/scheduling.js";import{property as y}from"../../../core/accessorSupport/decorators/property.js";import{subclass as _}from"../../../core/accessorSupport/decorators/subclass.js";const p=n.getLogger("esri.views.3d.analysis.AnalysisViewManager3D"),A="analyses-owner-handles";var V,f;!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(V||(V={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(f||(f={}));let v=class extends(a(s)){constructor(e){super(e),this._allAnalysisViews=new t,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._analysisModules={"area-measurement":{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this.detach()}attach(){this.handles.add(this._connectOwner(this.view),A)}detach(){this.handles.remove(A),this._update(),this._creatingViewCount=0}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((e=>e.updating))}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}whenAnalysisView(e){const s=this._items.get(e);if(r(s)||s.state.list===f.REMOVED){const s=new i("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return Promise.reject(s)}return s.createAnalysisViewTask.promise}_connectOwner(e){return this._connectAnalysesCollection(e.analyses)}_connectAnalysesCollection(e){for(const i of e)this._addAnalysis(i);const s=e.on("after-add",(e=>this._addAnalysis(e.item))),t=e.on("after-remove",(e=>this._removeAnalysis(e.item)));return{remove:()=>{s.remove(),t.remove();for(const s of e)this._removeAnalysis(s)}}}_addAnalysis(e){const s=this._items.get(e);if(null==s){const s={state:{view:V.PENDING,list:f.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,s),s.createAnalysisViewTask=h((e=>this._createAnalysisViewPromise(s,e)))}else s.state.list=f.ADDED}_removeAnalysis(e){const s=this._items.get(e);null!=s?(s.state.list=f.REMOVED,this._scheduleUpdate()):p.error("Trying to remove analysis which was not added")}_scheduleUpdate(){o(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=m((()=>this._update())))}_update(){this._scheduledUpdateHandle=l(this._scheduledUpdateHandle),this._items.forEach((e=>{if(e.state.list===f.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case V.PENDING:e.createAnalysisViewTask=d(e.createAnalysisViewTask);break;case V.CREATED:o(e.view)&&(this._allAnalysisViews.remove(e.view),e.view=c(e.view),e.createAnalysisViewTask=null)}}))}async _createAnalysisViewPromise(e,s){const t=e.analysis,i=t.type,a=this._analysisModules[i];if(this._creatingViewCount+=1,r(a.module))try{a.module=await this._loadAnalysisModule(i)}catch(o){throw this._creatingViewCount-=1,o}if(u(s))throw this._creatingViewCount-=1,w("AnalysisView creation aborted");const n=new a.module.default({analysis:t,view:this.view});try{await n.when()}catch(o){throw this._creatingViewCount-=1,o}if(u(s))throw this._creatingViewCount-=1,n.destroy(),w("AnalysisView creation aborted");return e.view=n,e.state.view=V.CREATED,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_loadAnalysisModule(e){switch(e){case"area-measurement":return import("./AreaMeasurementAnalysisView3D.js");case"direct-line-measurement":return import("./DirectLineMeasurementAnalysisView3D.js");case"line-of-sight":return import("./LineOfSightAnalysisView3D.js");case"slice":return import("./SliceAnalysisView3D.js");default:return null}}};e([y()],v.prototype,"updating",null),e([y({constructOnly:!0})],v.prototype,"view",void 0),e([y()],v.prototype,"_allAnalysisViews",void 0),e([y()],v.prototype,"_creatingViewCount",void 0),v=e([_("esri.views.3d.analysis.AnalysisViewManager3D")],v);const D=v;export{D as default};
