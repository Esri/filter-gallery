/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../intl.js";import t from"../../../../core/Accessor.js";import i from"../../../../core/Handles.js";import{nextHighestPowerOfTen as s,deg2rad as n}from"../../../../core/mathUtils.js";import{isNone as a,destroyMaybe as r,isSome as o}from"../../../../core/maybe.js";import{formatDecimal as l,formatImperialLength as c,formatImperialVerticalLength as d,formatMetricLength as h,formatMetricVerticalLength as u}from"../../../../core/quantityFormatUtils.js";import{toUnit as m}from"../../../../core/quantityUtils.js";import{watch as g,syncAndInitial as p}from"../../../../core/reactiveUtils.js";import{createRenderScreenPointArray3 as _,createRenderScreenPointArray as v}from"../../../../core/screenUtils.js";import{preferredImperialLengthUnit as b,convertUnit as L}from"../../../../core/unitUtils.js";import{whenOnce as w}from"../../../../core/watchUtils.js";import{property as y}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as S}from"../../../../core/accessorSupport/decorators/subclass.js";import{k as f}from"../../../../chunks/vec2.js";import{a as P,b as A}from"../../../../chunks/vec3.js";import{c as E}from"../../../../chunks/vec3f64.js";import{f as j}from"../../../../chunks/vec4f32.js";import{MeasurementMode as V}from"../interfaces.js";import{VisualElementOrientation as z,ViewMode as D}from"./interfaces.js";import{screenSpaceTangent as M}from"../support/viewUtils.js";import{LabelVisualElement as O,mirrorPosition as G}from"../../interactive/visualElements/LabelVisualElement.js";import{LineVisualElement as C}from"../../interactive/visualElements/LineVisualElement.js";import{MeasurementArrowVisualElement as x}from"../../interactive/visualElements/MeasurementArrowVisualElement.js";import{RightAngleQuadVisualElement as T}from"../../interactive/visualElements/RightAngleQuadVisualElement.js";import{GeodesicSegment as H,EuclideanSegment as R}from"../../interactive/visualElements/support/Segment.js";import{RenderOccludedFlag as k}from"../../webgl-engine/lib/Material.js";import{createStipplePatternSimple as U}from"../../webgl-engine/materials/lineStippleUtils.js";import{onLocaleChange as F}from"../../../../intl/locale.js";import{fetchMessageBundle as W}from"../../../../intl/messages.js";var Q;!function(e){e[e.Pending=0]="Pending",e[e.Ready=1]="Ready",e[e.Destroyed=2]="Destroyed"}(Q||(Q={}));let q=class extends t{constructor(e){super(e),this._params={...I},this._handles=new i,this._segmentVisualElement=null,this._triangleVisualElement=null,this._rightAngleQuad=null,this._projectedGeodesicLine=null,this._geodesicStartHint=null,this._geodesicEndHint=null,this._segmentLabel=null,this._verticalLabel=null,this._horizontalLabel=null,this._startPosition=E(),this._endPosition=E(),this._cornerPosition=E(),this._startPositionAtSeaLevel=E(),this._endPositionAtSeaLevel=E(),this._state=Q.Pending,this._triangleOrientationOverride=null,this.messages=null,this.loadingMessages=!0,this.visualElementOrientation=z.Auto,this.triangleCollapseRatioThreshold=.03}get ready(){return this._state===Q.Ready}get visible(){return this.analysisView.visible}get viewMode(){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=this.analysisView;if(a(e)||a(t)||e.equals(t))return D.None;const i=this.analysisView.result;if(a(i))return D.Direct;if("geodesic"===i.mode)return this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition)?D.ProjectedGeodesic:D.Direct;const{verticalDistance:s,horizontalDistance:n}=i,r=s.value,o=n.value;return Math.min(r/o,o/r)<this.triangleCollapseRatioThreshold?D.Direct:D.Triangle}get actualVisualizedMeasurement(){if(a(this.analysisView.result))switch(this.analysisView.measurementMode){case V.Auto:case V.Euclidean:default:return"euclidean";case V.Geodesic:return"geodesic"}return this.analysisView.result.mode}get allowVisualElementsOrientationChange(){return a(this._triangleOrientationOverride)}set allowVisualElementsOrientationChange(e){a(this._triangleOrientationOverride)!==e&&(a(this._triangleOrientationOverride)?this._triangleOrientationOverride=this._actualVisualElementsOrientation:this._triangleOrientationOverride=null)}get labels(){const e="geodesic"===this.actualVisualizedMeasurement;return{direct:this._segmentLabel,horizontal:e?this._segmentLabel:this._horizontalLabel,vertical:this._verticalLabel}}get testData(){var e;return{labels:this.labels,stripeLength:null==(e=this._segmentVisualElement)?void 0:e.stripeLength}}initialize(){this._handles.add(w(this.view,"ready",(()=>this._initialize()),!0))}_initialize(){switch(this._state){case Q.Ready:throw new Error("invalid state");case Q.Destroyed:return}const e=this._params,t={attached:!0,view:this.view};this._segmentVisualElement=new x({...t,geometry:null,renderOccluded:k.OccludeAndTransparent}),this._triangleVisualElement=new C({...t,width:e.triangleLineWidth,color:e.triangleColor,renderOccluded:k.OccludeAndTransparent}),this._rightAngleQuad=new T({...t,color:N,renderOccluded:k.OccludeAndTransparent});const i={...t,polygonOffset:!0,renderOccluded:k.OccludeAndTransparent};this._projectedGeodesicLine=new C({...i,width:e.geodesicProjectionLineWidth,color:e.geodesicProjectionLineColor,stipplePattern:U(e.guideStippleLengthPixels)}),this._geodesicStartHint=new C({...i,width:e.guideLineWidth,color:e.geodesicProjectionLineColor,stipplePattern:U(e.guideStippleLengthPixels)}),this._geodesicEndHint=new C({...i,width:e.guideLineWidth,color:e.geodesicProjectionLineColor,stipplePattern:U(e.guideStippleLengthPixels)}),this._segmentLabel=new O({...t,fontSize:e.direcLabelFontSize}),this._verticalLabel=new O({...t,fontSize:e.verticalLabelFontSize}),this._horizontalLabel=new O({...t,fontSize:e.horizontalLabelFontSize}),this._handles.add([g((()=>{const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=this.analysisView,i=this.view;return{view:i,camera:i.state.camera,viewMode:this.viewMode,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,orientation:this._actualVisualElementsOrientation,visualizedMeasurement:this.actualVisualizedMeasurement,stripeLength:this._measurementArrowStripeLength}}),(e=>this._updateGeometryAndViewMode(e)),p),g((()=>({visible:this.visible,viewMode:this.viewMode})),(e=>this._updateVisualElementVisibility(e)),p),g((()=>({text:this._labelsText,visualizedMeasurement:this.actualVisualizedMeasurement})),(e=>this._updateLabelText(e)),p),g((()=>({visible:this.visible,viewMode:this.viewMode,state:this._state})),(e=>this._updateLabelVisibility(e)),p),g((()=>this._measurementArrowStripeLength),(e=>this._updateSegmentStripeLength(e)),p),F((async()=>this._updateMessageBundle()))]),this._state=Q.Ready,this._updateMessageBundle()}destroy(){this._state!==Q.Destroyed&&(this._handles=r(this._handles),this._segmentVisualElement=r(this._segmentVisualElement),this._triangleVisualElement=r(this._triangleVisualElement),this._rightAngleQuad=r(this._rightAngleQuad),this._projectedGeodesicLine=r(this._projectedGeodesicLine),this._geodesicStartHint=r(this._geodesicStartHint),this._geodesicEndHint=r(this._geodesicEndHint),this._segmentLabel=r(this._segmentLabel),this._verticalLabel=r(this._verticalLabel),this._horizontalLabel=r(this._horizontalLabel),this.set("view",null),this._state=Q.Destroyed)}async whenReady(){await w(this,"ready")}_updateVisualElementVisibility({visible:e,viewMode:t}){if(this._segmentVisualElement.visible=!1,this._triangleVisualElement.visible=!1,this._rightAngleQuad.visible=!1,this._projectedGeodesicLine.visible=!1,this._geodesicStartHint.visible=!1,this._geodesicEndHint.visible=!1,e)switch(t){case D.None:break;case D.Direct:this._segmentVisualElement.visible=!0;break;case D.Triangle:this._segmentVisualElement.visible=!0,this._triangleVisualElement.visible=!0,this._rightAngleQuad.visible=!0;break;case D.ProjectedGeodesic:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}}_updateGeometryAndViewMode({view:e,camera:t,viewMode:i,elevationAlignedStartPoint:s,elevationAlignedEndPoint:n,orientation:r,visualizedMeasurement:o,stripeLength:l}){const c=e.renderCoordsHelper;if(a(s)||a(n)||s.equals(n))return;let d=this._startPosition,h=this._endPosition;c.toRenderCoords(s,d),c.toRenderCoords(n,h);const u=r===z.AboveSegment?1:-1,m=u*(c.getAltitude(h)-c.getAltitude(d));m<0&&(d=this._endPosition,h=this._startPosition);const g="geodesic"===o?new H(this._startPosition,this._endPosition,c.spatialReference):new R(this._startPosition,this._endPosition);switch(this._segmentVisualElement.geometry=g,this._updateSegmentStripeLength(l),i){case D.Direct:this._updateSegment(g,r);break;case D.Triangle:this._updateSegmentAndTriangle({view:e,camera:t,segment:g,orientation:r,startPosition:d,endPosition:h,deltaSign:u,altitudeDelta:m});break;case D.ProjectedGeodesic:this._updateSegmentAndProjection({view:e,orientation:r,startPosition:d,endPosition:h})}}_updateSegment(e,t){this._segmentLabel.anchor=t===z.AboveSegment?"top":"bottom",this._segmentLabel.geometry={type:"segment",segment:e,sampleLocation:"center"}}_updateSegmentAndTriangle({view:{renderCoordsHelper:e},camera:t,segment:i,orientation:s,startPosition:n,endPosition:a,deltaSign:r,altitudeDelta:o}){const l=this._cornerPosition;e.worldUpAtPosition(n,l),P(l,l,r*Math.abs(o)),A(l,l,n),this._triangleVisualElement.geometry=[[[n[0],n[1],n[2]],[l[0],l[1],l[2]],[a[0],a[1],a[2]]]],this._rightAngleQuad.geometry={previous:n,center:l,next:a};const c=new R(n,l),d=new R(l,a),h=B(n,a,l,s,t);this._segmentLabel.anchor=h.segment,this._segmentLabel.geometry={type:"segment",segment:i,sampleLocation:"center"},this._verticalLabel.geometry={type:"segment",segment:c,sampleLocation:"center"},this._verticalLabel.anchor=h.vertical,this._horizontalLabel.geometry={type:"segment",segment:d,sampleLocation:"center"},this._horizontalLabel.anchor=h.horizontal}_updateSegmentAndProjection({view:{renderCoordsHelper:e},orientation:t,startPosition:i,endPosition:s}){e.setAltitude(this._startPositionAtSeaLevel,0,i),e.setAltitude(this._endPositionAtSeaLevel,0,s);const n=new H(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,e.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(n),this._geodesicStartHint.setGeometryFromSegment(new R(this._startPositionAtSeaLevel,i)),this._geodesicEndHint.setGeometryFromSegment(new R(this._endPositionAtSeaLevel,s)),this._segmentLabel.geometry={type:"segment",segment:n,sampleLocation:"center"},this._segmentLabel.anchor=t===z.AboveSegment?"top":"bottom"}_updateLabelText({text:e,visualizedMeasurement:t}){o(e)?(this._segmentLabel.text="euclidean"===t?e.euclideanDistance:e.geodesicDistance,this._horizontalLabel.text=e.horizontalDistance,this._verticalLabel.text=e.verticalDistance):(this._segmentLabel.text=null,this._horizontalLabel.text=null,this._verticalLabel.text=null),this.notifyChange("labels")}_updateLabelVisibility({state:e,visible:t,viewMode:i}){if(e!==Q.Ready)return;const s=this._segmentLabel,n=this._horizontalLabel,a=this._verticalLabel;if(s.visible=!1,n.visible=!1,a.visible=!1,t)switch(i){case D.Direct:s.visible=!0;break;case D.Triangle:s.visible=!0,n.visible=!0,a.visible=!0;break;case D.ProjectedGeodesic:s.visible=!0;case D.None:}}get _labelsText(){if(this._state!==Q.Ready)return null;const e=this.messages,t=this.analysisView.result;if(a(t)||a(e))return null;const{directDistance:i,horizontalDistance:s,verticalDistance:n,geodesicDistance:r}=t,o=this.analysisView.unit,m=e=>({euclideanDistance:"",geodesicDistance:"",horizontalDistance:"",verticalDistance:"",...e});switch(o){case"metric":return m({euclideanDistance:i&&h(e,i),geodesicDistance:r&&h(e,r),horizontalDistance:s&&h(e,s),verticalDistance:n&&u(e,n)});case"imperial":return m({euclideanDistance:i&&c(e,i),geodesicDistance:r&&c(e,r),horizontalDistance:s&&c(e,s),verticalDistance:n&&d(e,n)});default:return m({euclideanDistance:i&&l(e,i,o),geodesicDistance:r&&l(e,r,o),horizontalDistance:s&&l(e,s,o),verticalDistance:n&&l(e,n,o)})}}_updateSegmentStripeLength(e){const t=this._segmentVisualElement;o(e)?(t.stripeLength=e,t.stripesEnabled=!0):t.stripesEnabled=!1}get _actualVisualElementsOrientation(){if(o(this._triangleOrientationOverride))return this._triangleOrientationOverride;const e=this.visualElementOrientation;return e===z.Auto?this.view.state.camera.aboveGround?z.AboveSegment:z.BelowSegment:e}_requiresGeodesicGuideAt(e){const t=this.view;if(null==t||!t.state)return!1;const i=t.state.camera,s=t.renderCoordsHelper,n=i.computeScreenPixelSizeAt(e);return s.getAltitude(e)/n>=10}get _measurementArrowStripeLength(){const{result:e,unit:t}=this.analysisView;if(a(e))return null;let i=null;const n=e.directDistance;switch(t){case"metric":i=n&&m(n,"meters");break;case"imperial":i=n&&m(n,b(n.value,n.unit));break;default:i=n&&m(n,t)}if(a(i))return null;return s(i.value/30)*L(1,i.unit,"meters")}_updateMessageBundle(){this.loadingMessages=!0,W("esri/core/t9n/Units").then((e=>{this.messages=e})).finally((()=>{this.loadingMessages=!1}))}};function B(e,t,i,s,n){const a=K,r=X;n.projectToRenderScreen(i,a),n.projectToRenderScreen(t,r);const o={segment:"bottom",horizontal:"top",vertical:a[0]<r[0]?"left":"right"};{const s=Y,a=Z;if(M(e,i,s,n),M(e,t,a,n),f(s,a)>=J){const e=Math.sign(s[1])===Math.sign(a[1]);o.segment=e?G(o.vertical):o.vertical}else{const e=$;M(i,t,e,n),f(e,a)>=J&&(o.segment=Math.sign(e[0])===Math.sign(a[0])?G(o.horizontal):o.horizontal)}}if(s===z.BelowSegment){const e=e=>"top"===e?"bottom":"top";o.segment=e(o.segment),o.horizontal=e(o.horizontal),o.vertical=e(o.vertical)}return o}e([y()],q.prototype,"_state",void 0),e([y()],q.prototype,"_triangleOrientationOverride",void 0),e([y()],q.prototype,"messages",void 0),e([y()],q.prototype,"view",void 0),e([y()],q.prototype,"analysis",void 0),e([y()],q.prototype,"analysisView",void 0),e([y()],q.prototype,"ready",null),e([y()],q.prototype,"loadingMessages",void 0),e([y()],q.prototype,"visible",null),e([y()],q.prototype,"viewMode",null),e([y()],q.prototype,"actualVisualizedMeasurement",null),e([y()],q.prototype,"visualElementOrientation",void 0),e([y()],q.prototype,"triangleCollapseRatioThreshold",void 0),e([y()],q.prototype,"allowVisualElementsOrientationChange",null),e([y()],q.prototype,"labels",null),e([y()],q.prototype,"testData",null),e([y()],q.prototype,"_labelsText",null),e([y()],q.prototype,"_actualVisualElementsOrientation",null),e([y()],q.prototype,"_measurementArrowStripeLength",null),q=e([S("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementVisualization")],q);const N=j(1,.5,0,.75),I={laserLineGlowColor:[1,.5,0],laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:[1,1,1],laserLineInnerWidth:.75,laserLineGlobalAlpha:.75,laserLineEnabled:!0,handleColor:[1,.5,0],handleOpacity:.5,handleRadius:5,triangleColor:N,triangleLineWidth:3,triangleCornerSize:32,triangleSubdivisions:128,arrowWidth:16,arrowOutlineColor:[1,.5,0,1],arrowOutlineWidth:.2,arrowStripeEvenColor:[1,1,1,1],arrowStripeOddColor:[1,.5,0,1],arrowStripeLength:16,arrowSubdivisions:128,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:N,guideLineWidth:2,guideLineColor:N,guideStippleLengthPixels:6,labelDistance:25,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12},J=Math.cos(n(12)),K=_(),X=_(),Y=v(),Z=v(),$=v();export{q as DirectLineMeasurementVisualization,Q as State};
