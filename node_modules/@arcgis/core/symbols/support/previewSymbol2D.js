/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import e from"../../Color.js";import t from"../../core/Error.js";import{pt2px as l,px2pt as a}from"../../core/screenUtils.js";import{getFill as n,getStroke as o,getPatternUrlWithColor as i}from"./gfxUtils.js";import{SymbolSizeDefaults as s,shapes as c,adjustColorBrightness as u}from"./previewUtils.js";import{renderSymbol as r}from"./renderUtils.js";const m="picture-fill",h="picture-marker",p="simple-fill",d="simple-line",f="simple-marker",v="text",y="Aa",w=s.size,g=s.maxSize,b=s.maxOutlineSize,M=s.lineWidth,x=document.createElement("canvas");function k(e,t){const l=x.getContext("2d"),a=[];return t&&(t.weight&&a.push(t.weight),t.size&&a.push(t.size+"px"),t.family&&a.push(t.family)),l.font=a.join(" "),l.measureText(e).width}const L=7.2/2.54,z=72/2.54;function j(e){if(0===e.length)return 0;if(e.length>2){const t=a(1),l=parseFloat(e);switch(e.slice(-2)){case"px":return l;case"pt":return l*t;case"in":return 72*l*t;case"pc":return 12*l*t;case"mm":return l*L*t;case"cm":return l*z*t}}return parseFloat(e)}function C(e){const t=null==e?void 0:e.size;return{width:null!=t&&"object"==typeof t&&"width"in t?l(t.width):null,height:null!=t&&"object"==typeof t&&"height"in t?l(t.height):null}}function S(a,s){var x,L;const z="number"==typeof(null==s?void 0:s.size)?null==s?void 0:s.size:null,S=null!=z?l(z):null,F=null!=(null==s?void 0:s.maxSize)?l(s.maxSize):null,E=null!=(null==s?void 0:s.opacity)?s.opacity:null,P=null!=(null==s?void 0:s.rotation)?s.rotation:"angle"in a?a.angle:null,U=n(a);let Z=o(a);if(U&&!Z){const t="type"in U?null:new e(U);"#ffffff"===(t?t.toHex():null)&&(Z={color:"#bdc3c7",width:.75})}const q={shape:null,fill:null,stroke:Z,offset:[0,0]};null!=(x=Z)&&x.width&&(Z.width=Math.min(Z.width,b));const H=(null==(L=Z)?void 0:L.width)||0;let T=null!=(null==s?void 0:s.size)&&(null==(null==s?void 0:s.scale)||(null==s?void 0:s.scale)),V=0,A=0,D=!1;switch(a.type){case f:{const e=a.style,t=Math.min(null!=S?S:l(a.size),F||g);switch(V=t,A=t,e){case"circle":q.shape={type:"circle",cx:0,cy:0,r:.5*t},T||(V+=H,A+=H);break;case"cross":q.shape={type:"path",path:[{command:"M",values:[0,.5*A]},{command:"L",values:[V,.5*A]},{command:"M",values:[.5*V,0]},{command:"L",values:[.5*V,A]}]};break;case"diamond":q.shape={type:"path",path:[{command:"M",values:[0,.5*A]},{command:"L",values:[.5*V,0]},{command:"L",values:[V,.5*A]},{command:"L",values:[.5*V,A]},{command:"Z",values:[]}]},T||(V+=H,A+=H);break;case"square":q.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[V,0]},{command:"L",values:[V,A]},{command:"L",values:[0,A]},{command:"Z",values:[]}]},T||(V+=H,A+=H),P&&(D=!0);break;case"triangle":q.shape={type:"path",path:[{command:"M",values:[.5*V,0]},{command:"L",values:[V,A]},{command:"L",values:[0,A]},{command:"Z",values:[]}]},T||(V+=H,A+=H),P&&(D=!0);break;case"x":q.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[V,A]},{command:"M",values:[V,0]},{command:"L",values:[0,A]}]},P&&(D=!0);break;case"path":q.shape={type:"path",path:a.path||""},T||(V+=H,A+=H),P&&(D=!0),T=!0}break}case d:{var O;const{width:e,height:t}=C(s),l=null!=t?t:Math.min(null!=S?S:H,F||b),a=null!=e?e:M;Z.width=l,V=a,A=l;const n=(null==q||null==(O=q.stroke)?void 0:O.cap)||"butt",o="round"===n;T=!0,q.stroke.cap="butt"===n?"square":n,q.shape={type:"path",path:[{command:"M",values:[o?l/2:0,A/2]},{command:"L",values:[o?V-l/2:V,A/2]}]};break}case m:case p:{const e="object"==typeof(null==s?void 0:s.symbolConfig)&&(null==s?void 0:s.symbolConfig.isSquareFill),{width:t,height:l}=C(s);V=e&&null!=t?t:null!=S?S:w,A=e&&null!=l?l:V,T||(V+=H,A+=H),T=!0,q.shape=e?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[V,0]},{command:"L",values:[V,A]},{command:"L",values:[0,A]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:c.fill[0];break}case h:{let e=l(a.width),t=l(a.height);const n=null!=S?S:Math.max(e,t),o=e/t;e=o<=1?Math.ceil(n*o):n,t=o<=1?n:Math.ceil(n/o),V=Math.min(e,F||g),A=Math.min(t,F||g),q.shape={type:"image",x:-Math.round(V/2),y:-Math.round(A/2),width:V,height:A,src:a.url||""},P&&(D=!0);break}case v:{const e=a,t=e.text||y,n=e.font,o=Math.min(null!=S?S:l(n.size),F||g),i=k(t,{weight:n.weight,size:o,family:n.family}),s=/[\uE600-\uE6FF]/.test(t);V=s?o:i,A=o;let c=.25*j((n?o:0).toString());s&&(c+=5),q.shape={type:"text",text:t,x:0,y:c,align:"middle",decoration:n&&n.decoration,rotated:e.rotated,kerning:e.kerning},q.font=n&&{size:o,style:n.style,decoration:n.decoration,weight:n.weight,family:n.family};break}}if(!q.shape)return Promise.reject(new t("symbolPreview: renderPreviewHTML2D","symbol not supported."));const R=U,W=a.color;let B=null;return R&&"pattern"===R.type&&W&&a.type!==m?B=i(R.src,W.toCss(!0)).then((e=>(R.src=e,q.fill=R,q))):(q.fill=U,B=Promise.resolve(q)),B.then((e=>{const t=[[e]];if("object"==typeof(null==s?void 0:s.symbolConfig)&&null!=s&&s.symbolConfig.applyColorModulation){const l=.6*V;t.unshift([{...e,offset:[-l,0],fill:u(U,-.3)}]),t.push([{...e,offset:[l,0],fill:u(U,.3)}]),V+=2*l,T=!1}return r(t,[V,A],{node:s&&s.node,scale:T,opacity:E,rotation:P,useRotationSize:D,effectView:null==s?void 0:s.effectView})}))}export{S as previewSymbol2D};
