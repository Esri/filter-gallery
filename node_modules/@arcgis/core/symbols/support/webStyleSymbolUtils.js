/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{isSymbol3D as t}from"../../symbols.js";import{isDevEnvironment as e,adjustStaticAGOUrl as r}from"../../core/devEnvironmentUtils.js";import o from"../../core/Error.js";import{urlToObject as l,removeFile as n}from"../../core/urlUtils.js";import s from"../../portal/Portal.js";import{f as m}from"../../chunks/persistableUrlUtils.js";import{fromJSON as i}from"./jsonUtils.js";import a from"./StyleOrigin.js";import{requestJSON as u,makeCIMSymbolRef as p,fetchStyle as y,symbolUrlFromStyleItem as f,Style2DUrlTemplate as c}from"./styleUtils.js";import{Thumbnail as b}from"./Thumbnail.js";function g(t,e,r,l){return t.name?t.styleName&&"Esri2DPointSymbolsStyle"===t.styleName?j(t,e,l):y(t,e,l).then((o=>h(o,t.name,e,r,l))):Promise.reject(new o("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference"))}function h(y,c,g,h,j){const d=y.data,U={portal:g&&g.portal||s.getDefault(),url:l(y.baseUrl),origin:"portal-item"},N=d.items.find((t=>t.name===c));if(!N){const t=`The symbol name '${c}' could not be found`;return Promise.reject(new o("symbolstyleutils:symbol-name-not-found",t,{symbolName:c}))}let w=m(f(N,h),U),P=N.thumbnail&&N.thumbnail.href;const S=N.thumbnail&&N.thumbnail.imageData;e()&&(w=r(w),P=r(P));const D={portal:g.portal,url:l(n(w)),origin:"portal-item"};return u(w,j).then((e=>{const r="cimRef"===h?p(e.data):e.data,o=i(r,D);if(o&&t(o)){if(P){const t=m(P,U);o.thumbnail=new b({url:t})}else S&&(o.thumbnail=new b({url:`data:image/png;base64,${S}`}));y.styleUrl?o.styleOrigin=new a({portal:g.portal,styleUrl:y.styleUrl,name:c}):y.styleName&&(o.styleOrigin=new a({portal:g.portal,styleName:y.styleName,name:c}))}return o}))}function j(t,e,r){const o=c.replace(/\{SymbolName\}/gi,t.name);return u(o,r).then((t=>{const r=p(t.data);return i(r,{portal:e.portal,url:l(n(o)),origin:"portal-item"})}))}export{h as fetchSymbolFromStyle,g as resolveWebStyleSymbol};
