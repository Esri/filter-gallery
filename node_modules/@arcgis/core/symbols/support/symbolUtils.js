/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import"../../core/has.js";import{isSome as e,isNone as t,unwrap as l}from"../../core/maybe.js";import{loadArcade as i}from"../../support/arcadeOnDemand.js";import{SymbolSizeDefaults as r}from"./previewUtils.js";import{getCSSFilterFromEffectList as a,applyColorToSymbol as o,applySizesToSymbol as s,applyRotationToSymbol as n,getColorFromSymbol as c,applyOpacityToColor as u}from"./utils.js";let y=null;function p(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function f(e,t,l){const{backgroundColor:i,outline:a,dotSize:o}=e,s=l&&l.swatchSize||r.size,n=.8,c=Math.round(s*s/o**2*n),u=window.devicePixelRatio,f=document.createElement("canvas"),h=s*u;f.width=h,f.height=h,f.style.width=f.width/u+"px",f.style.height=f.height/u+"px";const b=f.getContext("2d");if(i&&(b.fillStyle=i.toCss(!0),b.fillRect(0,0,h,h),b.fill()),b.fillStyle=t.toCss(!0),y&&y.length/2===c)for(let r=0;r<2*c;r+=2){const e=y[r],t=y[r+1];b.fillRect(e,t,o*u,o*u),b.fill()}else{y=[];for(let e=0;e<2*c;e+=2){const e=p(0,h),t=p(0,h);y.push(e,t),b.fillRect(e,t,o*u,o*u),b.fill()}}a&&(a.color&&(b.strokeStyle=a.color.toCss(!0)),b.lineWidth=a.width,b.strokeRect(0,0,h,h));const d=new Image(s,s);return d.src=f.toDataURL(),d}function h(e,t={}){const l=24,i=75,r="horizontal"===t.align,a=r?i:l,o=r?l:i,{width:s=a,height:n=o,gradient:c=!0}=t,u=window.devicePixelRatio,y=s*u,p=n*u,f=document.createElement("canvas");f.width=y,f.height=p,f.style.width=`${s}px`,f.style.height=`${n}px`;const h=f.getContext("2d"),d=r?y:0,m=r?0:p;if(c){const t=h.createLinearGradient(0,0,d,m),l=e.length,i=1===l?0:1/(l-1);e.forEach(((e,l)=>t.addColorStop(l*i,e.toString()))),h.fillStyle=t,h.fillRect(0,0,y,p)}else{const t=r?y/e.length:y,l=r?p:p/e.length;let i=0,a=0;for(const o of e)h.fillStyle=o.toString(),h.fillRect(i,a,t,l),i=r?i+t:0,a=r?0:a+l}const g=document.createElement("div");return g.style.width=`${s}px`,g.style.height=`${n}px`,b(g,null==t?void 0:t.effectList),g.appendChild(f),g}function b(e,t){if(!t)return;e.style.filter=a(t);const l=t.effects;if(l)for(const i of l)if("drop-shadow"===(null==i?void 0:i.type)){i.offsetX<0?e.style.marginLeft=`${Math.abs(i.offsetX)}px`:e.style.marginRight=`${i.offsetX}px`;break}}async function d(e,t){switch(e.type){case"web-style":{const{previewWebStyleSymbol:l}=await import("./previewWebStyleSymbol.js");return l(e,d,t)}case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":{const{previewSymbol3D:l}=await import("./previewSymbol3D.js");return l(e,t)}case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":{const{previewSymbol2D:l}=await import("./previewSymbol2D.js");return l(e,t)}case"cim":{const{previewCIMSymbol:l}=await import("./previewCIMSymbol.js");return l(e,t)}default:return}}function m(e){return e&&"opacity"in e?e.opacity*m(e.parent):1}async function g(r,a){var c,u;if(!r)return;const y=r.sourceLayer,p=null!=(c=e(a)&&null!=(u=a.useSourceLayer)&&u?y:r.layer)?c:y,f=m(p);if(e(r.symbol)&&(!e(a)||!0!==a.ignoreGraphicSymbol)){const t="web-style"===r.symbol.type?await r.symbol.fetchSymbol(e(a)?a.abortOptions:null):r.symbol.clone();return o(t,null,f),t}const h=e(a)&&a.renderer||p&&"renderer"in p&&p.renderer;let b=h&&"getSymbolAsync"in h?await h.getSymbolAsync(r,a):null;if(!b)return;if(b="web-style"===b.type?await b.fetchSymbol(e(a)?a.abortOptions:null):b.clone(),!("visualVariables"in h)||!h.visualVariables||!h.visualVariables.length)return o(b,null,f),b;if("arcadeRequiredForVisualVariables"in h&&h.arcadeRequiredForVisualVariables&&(t(a)||t(a.arcade))){const e={...l(a)};e.arcade=await i(),a=e}const d=await import("../../renderers/visualVariables/support/visualVariableUtils.js"),g=[],w=[],v=[],S=[];for(const e of h.visualVariables)switch(e.type){case"color":g.push(e);break;case"opacity":w.push(e);break;case"rotation":S.push(e);break;case"size":e.target||v.push(e)}const V=!!g.length&&g[g.length-1],x=V?d.getColor(V,r,a):null,R=!!w.length&&w[w.length-1];let C=R?d.getOpacity(R,r,a):null;if(null!=f&&(C=null!=C?C*f:f),o(b,x,C),v.length){const e=d.getAllSizes(v,r,a);await s(b,e)}for(const e of S)n(b,d.getRotationAngle(e,r,a),e.axis);return b}async function w(r,a){var o;if(!r)return;const s=m(r.layer||r.sourceLayer);if(e(r.symbol)&&(!e(a)||!0!==a.ignoreGraphicSymbol)){const t="web-style"===r.symbol.type?await r.symbol.fetchSymbol(e(a)?a.abortOptions:null):r.symbol.clone();return c(t,s)}const n=e(a)&&a.renderer||r.get("layer.renderer")||r.get("sourceLayer.renderer");let y=await n.getSymbolAsync(r,a);if(!y)return;y="web-style"===y.type?await y.fetchSymbol(e(a)?a.abortOptions:null):y.clone();const p=c(y,s);if(!("visualVariables"in n)||"visualVariables"in n&&!n.visualVariables||"visualVariables"in n&&(null==(o=n.visualVariables)||!o.length))return p;if(n.arcadeRequiredForVisualVariables&&(t(a)||t(a.arcade))){const e={...l(a)};e.arcade=await i(),a=e}const f=await import("../../renderers/visualVariables/support/visualVariableUtils.js"),h=[],b=[];for(const e of n.visualVariables)switch(e.type){case"color":h.push(e);break;case"opacity":b.push(e)}const d=h.length>0?h[h.length-1]:null,g=d?f.getColor(d,r,a):p,w=b.length>0?b[b.length-1]:null;let v=w?f.getOpacity(w,r,a):null;return null!=s&&(v=null!=v?v*s:s),g?u(g,v):null}export{w as getDisplayedColor,g as getDisplayedSymbol,h as renderColorRampPreviewHTML,f as renderDotDensityPreviewHTML,d as renderPreviewHTML};
