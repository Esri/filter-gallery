/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import t from"../../Color.js";import e from"../../core/has.js";import{c as i}from"../../chunks/mat2df32.js";import{m as r,t as o,c as n,s,r as l}from"../../chunks/mat2d.js";import"../../widgets/support/widgetUtils.js";import"../../core/Logger.js";import{tsx as a}from"../../widgets/support/jsxFactory.js";const h="http://www.w3.org/2000/svg";let c=0,f=0;const d=e("android"),u=e("chrome")||d&&d>=4?"auto":"optimizeLegibility",y={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7,z:0},p=/([A-DF-Za-df-z])|([-+]?\d*[.]?\d+(?:[eE][-+]?\d+)?)/g;let g={},x={};const m={solid:"none",shortdash:[4,1],shortdot:[1,1],shortdashdot:[4,1,1,1],shortdashdotdot:[4,1,1,1,1,1],dot:[1,3],dash:[4,3],longdash:[8,3],dashdot:[4,3,1,3],longdashdot:[8,3,1,3],longdashdotdot:[8,3,1,3,1,3]},w=Math.PI;let k=1;function b(t,e){const i=t*(w/180);return Math.abs(e*Math.sin(i))+Math.abs(e*Math.cos(i))}function v(t){return t.map((t=>`${t.command} ${t.values.join(" ")}`)).join(" ").trim()}function j(t,e,i,r){if(t){if("circle"===t.type)return a("circle",{fill:e,"fill-rule":"evenodd",stroke:i.color,"stroke-width":i.width,"stroke-linecap":i.cap,"stroke-linejoin":i.join,"stroke-dasharray":i.dashArray,"stroke-miterlimit":"4",cx:t.cx,cy:t.cy,r:t.r});if("ellipse"===t.type)return a("ellipse",{fill:e,"fill-rule":"evenodd",stroke:i.color,"stroke-width":i.width,"stroke-linecap":i.cap,"stroke-linejoin":i.join,"stroke-dasharray":i.dashArray,"stroke-miterlimit":"4",cx:t.cx,cy:t.cy,rx:t.rx,ry:t.ry});if("rect"===t.type)return a("rect",{fill:e,"fill-rule":"evenodd",stroke:i.color,"stroke-width":i.width,"stroke-linecap":i.cap,"stroke-linejoin":i.join,"stroke-dasharray":i.dashArray,"stroke-miterlimit":"4",x:t.x,y:t.y,width:t.width,height:t.height});if("image"===t.type)return a("image",{href:t.src,x:t.x,y:t.y,width:t.width,height:t.height,preserveAspectRatio:"none"});if("path"===t.type){const r="string"!=typeof t.path?v(t.path):t.path;return a("path",{fill:e,"fill-rule":"evenodd",stroke:i.color,"stroke-width":i.width,"stroke-linecap":i.cap,"stroke-linejoin":i.join,"stroke-dasharray":i.dashArray,"stroke-miterlimit":"4",d:r})}if("text"===t.type)return a("text",{fill:e,"fill-rule":"evenodd",stroke:i.color,"stroke-width":i.width,"stroke-linecap":i.cap,"stroke-linejoin":i.join,"stroke-dasharray":i.dashArray,"stroke-miterlimit":"4","text-anchor":r.align,"text-decoration":r.decoration,kerning:r.kerning,rotate:r.rotate,"text-rendering":u,"font-style":r.font.style,"font-variant":r.font.variant,"font-weight":r.font.weight,"font-size":r.font.size,"font-family":r.font.family,x:t.x,y:t.y},t.text)}return null}function M(e){const i={fill:"none",pattern:null,linearGradient:null};if(e)if("type"in e&&"pattern"===e.type){const t="patternId-"+ ++c;i.fill=`url(#${t})`,i.pattern={id:t,x:e.x,y:e.y,width:e.width,height:e.height,image:{x:0,y:0,width:e.width,height:e.height,href:e.src}}}else if("type"in e&&"linear"===e.type){const r="linearGradientId-"+ ++f;i.fill=`url(#${r})`,i.linearGradient={id:r,x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2,stops:e.colors.map((e=>({offset:e.offset,color:e.color&&new t(e.color).toString()})))}}else if(e){const r=new t(e);i.fill=r.toString()}return i}function A(e){const i={color:"none",width:1,cap:"butt",join:"4",dashArray:"none"};if(e&&(null!=e.width&&(i.width=e.width),e.cap&&(i.cap=e.cap),e.join&&(i.join=e.join.toString()),e.color&&(i.color=new t(e.color).toString()),e.style)){let t=null;if(e.style in m&&(t=m[e.style]),Array.isArray(t)){t=t.slice(0);for(let i=0;i<t.length;++i)t[i]*=e.width;if("butt"!==e.cap){for(let i=0;i<t.length;i+=2)t[i]-=e.width,t[i]<1&&(t[i]=1);for(let i=1;i<t.length;i+=2)t[i]+=e.width}t=t.join(",")}i.dashArray=t}return i}function N(t,e){const i={align:null,decoration:null,kerning:null,rotate:null,font:{style:null,variant:null,weight:null,size:null,family:null}};return t&&(i.align=t.align,i.decoration=t.decoration,i.kerning=t.kerning?"auto":"0",i.rotate=t.rotated?"90":"0",i.font.style=e.style||"normal",i.font.variant=e.variant||"normal",i.font.weight=e.weight||"normal",i.font.size=e.size&&e.size.toString()||"10pt",i.font.family=e.family||"serif"),i}function G(t){const{pattern:e,linearGradient:i}=t;if(e)return a("pattern",{id:e.id,patternUnits:"userSpaceOnUse",x:e.x,y:e.y,width:e.width,height:e.height},a("image",{x:e.image.x,y:e.image.y,width:e.image.width,height:e.image.height,href:e.image.href}));if(i){const t=i.stops.map(((t,e)=>a("stop",{key:`${e}-stop`,offset:t.offset,"stop-color":t.color})));return a("linearGradient",{id:i.id,gradientUnits:"userSpaceOnUse",x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2},t)}return null}function S(t,e,i){return o(t,n(t),[e,i])}function $(t,e,i,r,o){return s(t,n(t),[e,i]),t[4]=t[4]*e-r*e+r,t[5]=t[5]*i-o*i+o,t}function I(t,e,i,r){const o=e%360*Math.PI/180;l(t,n(t),o);const s=Math.cos(o),a=Math.sin(o),h=t[4],c=t[5];return t[4]=h*s-c*a+r*a-i*s+i,t[5]=c*s+h*a-i*a-r*s+r,t}function z(t,e){g&&"left"in g?(g.left>t&&(g.left=t),g.right<t&&(g.right=t),g.top>e&&(g.top=e),g.bottom<e&&(g.bottom=e)):g={left:t,bottom:e,right:t,top:e}}function B(t){const e=t.args,i=e.length;let r;switch(t.action){case"M":case"L":case"C":case"S":case"Q":case"T":for(r=0;r<i;r+=2)z(e[r],e[r+1]);x.x=e[i-2],x.y=e[i-1];break;case"H":for(r=0;r<i;++r)z(e[r],x.y);x.x=e[i-1];break;case"V":for(r=0;r<i;++r)z(x.x,e[r]);x.y=e[i-1];break;case"m":{let t=0;"x"in x||(z(x.x=e[0],x.y=e[1]),t=2);for(r=t;r<i;r+=2)z(x.x+=e[r],x.y+=e[r+1]);break}case"l":case"t":for(r=0;r<i;r+=2)z(x.x+=e[r],x.y+=e[r+1]);break;case"h":for(r=0;r<i;++r)z(x.x+=e[r],x.y);break;case"v":for(r=0;r<i;++r)z(x.x,x.y+=e[r]);break;case"c":for(r=0;r<i;r+=6)z(x.x+e[r],x.y+e[r+1]),z(x.x+e[r+2],x.y+e[r+3]),z(x.x+=e[r+4],x.y+=e[r+5]);break;case"s":case"q":for(r=0;r<i;r+=4)z(x.x+e[r],x.y+e[r+1]),z(x.x+=e[r+2],x.y+=e[r+3]);break;case"A":for(r=0;r<i;r+=7)z(e[r+5],e[r+6]);x.x=e[i-2],x.y=e[i-1];break;case"a":for(r=0;r<i;r+=7)z(x.x+=e[r+5],x.y+=e[r+6])}}function F(t,e,i){const r=y[t.toLowerCase()];let o;"number"==typeof r&&(r?e.length>=r&&(o={action:t,args:e.slice(0,e.length-e.length%r)},i.push(o),B(o)):(o={action:t,args:[]},i.push(o),B(o)))}function U(t){const e=("string"!=typeof t.path?v(t.path):t.path).match(p),i=[];if(g={},x={},!e)return null;let r="",o=[];const n=e.length;for(let l=0;l<n;++l){const t=e[l],n=parseFloat(t);isNaN(n)?(r&&F(r,o,i),o=[],r=t):o.push(n)}F(r,o,i);const s={x:0,y:0,width:0,height:0};return g&&"left"in g&&(s.x=g.left,s.y=g.top,s.width=g.right-g.left,s.height=g.bottom-g.top),s}function T(t){const e={x:0,y:0,width:0,height:0};if("circle"===t.type)e.x=t.cx-t.r,e.y=t.cy-t.r,e.width=2*t.r,e.height=2*t.r;else if("ellipse"===t.type)e.x=t.cx-t.rx,e.y=t.cy-t.ry,e.width=2*t.rx,e.height=2*t.ry;else if("image"===t.type||"rect"===t.type)e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height;else if("path"===t.type){const i=U(t);e.x=i.x,e.y=i.y,e.width=i.width,e.height=i.height}return e}function E(t){const e={x:0,y:0,width:0,height:0};let i=null,r=Number.NEGATIVE_INFINITY,o=Number.NEGATIVE_INFINITY;for(const n of t)i?(i.x=Math.min(i.x,n.x),i.y=Math.min(i.y,n.y),r=Math.max(r,n.x+n.width),o=Math.max(o,n.y+n.height)):(i=e,i.x=n.x,i.y=n.y,r=n.x+n.width,o=n.y+n.height);return i&&(i.width=r-i.x,i.height=o-i.y),i}function V(t,e,o,n,s,l,a,h,c){let f=(a&&l?b(l,e):e)/2,d=(a&&l?b(l,o):o)/2;if(c){const t=c[0],e=c[1];f=(a&&l?b(l,t):t)/2,d=(a&&l?b(l,e):e)/2}const u=t.width+n,y=t.height+n,p=i(),g=i();let x=!1;if(s&&0!==u&&0!==y){const t=e!==o?e/o:u/y,i=e>o?e:o;let n=1,s=1;isNaN(i)||(t>1?(n=i/u,s=i/t/y):(s=i/y,n=i*t/u)),r(g,g,$(p,n,s,f,d)),x=!0}const m=t.x+(u-n)/2,w=t.y+(y-n)/2;if(r(g,g,S(p,f-m,d-w)),!x&&(u>e||y>o)){const t=u/e>y/o,i=(t?e:o)/(t?u:y);r(g,g,$(p,i,i,m,w))}return l&&r(g,g,I(p,l,m,w)),h&&r(g,g,S(p,h[0],h[1])),`matrix(${g[0]},${g[1]},${g[2]},${g[3]},${g[4]},${g[5]})`}function C(t,e,i){const r=null==t?void 0:t.effects.find((t=>"bloom"===t.type));if(!r)return null;const{strength:o,radius:n}=r,s=o>0?n:0,l=(o+s)*e,h=4*o+1;return a("filter",{id:`bloom${i}`,x:"-100%",y:"-100%",width:"300%",height:"300%",filterUnits:"userSpaceOnUse"},a("feMorphology",{operator:"dilate",radius:(o+.5*s)*(5**(e/100)*(.4+e/100)),in:"SourceGraphic",result:"dilate"}),a("feGaussianBlur",{in:"dilate",stdDeviation:l/25,result:"blur"}),a("feGaussianBlur",{in:"blur",stdDeviation:l/50,result:"intensityBlur"}),a("feComponentTransfer",{in:"SourceGraphic",result:"intensityBrightness"},a("feFuncR",{type:"linear",slope:h}),a("feFuncG",{type:"linear",slope:h}),a("feFuncB",{type:"linear",slope:h})),a("feMerge",null,a("feMergeNode",{in:"intensityBlur"}),a("feMergeNode",{in:"intensityBrightness"}),a("feGaussianBlur",{stdDeviation:o/10})))}function D(t,e,i,r){const o=[],n=[],s=++k,l=C(null==r?void 0:r.effectView,e,s);let c=null;if(l){var f;const t=null==r||null==(f=r.effectView)?void 0:f.effects.find((t=>"bloom"===t.type)),o=(t.strength?t.strength+t.radius/2:0)/3,n=e+e*o,s=i+i*o;c=[Math.max(n,10),Math.max(s,10)]}for(const h of t){const t=[],s=[];let l=0,f=0,d=0;for(const e of h){const{shape:i,fill:r,stroke:n,font:a,offset:h}=e;l+=n&&n.width||0;const c=M(r),u=A(n),y="text"===i.type?N(i,a):null;o.push(G(c)),t.push(j(i,c.fill,u,y)),s.push(T(i)),h&&(f+=h[0],d+=h[1])}const u=V(E(s),e,i,l,null==r?void 0:r.scale,null==r?void 0:r.rotation,null==r?void 0:r.useRotationSize,[f,d],c);n.push(a("g",{transform:u},t))}null!=r&&r.useRotationSize&&null!=r&&r.rotation&&(e=b(null==r?void 0:r.rotation,e),i=b(null==r?void 0:r.rotation,i)),l&&(e=c[0],i=c[1]);return a("svg",{xmlns:h,width:e,height:i,style:"display: block;"},l,a("defs",null,o),l?a("g",{filter:`url(#bloom${s})`},n):n)}export{E as computeBBox,M as generateFillAttributes,A as generateStrokeAttributes,N as generateTextAttributes,T as getBoundingBox,V as getTransformMatrix,G as renderDef,D as renderSVG,j as renderShape};
