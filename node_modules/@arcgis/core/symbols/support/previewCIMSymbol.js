/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{px2pt as e}from"../../core/screenUtils.js";import{CIMSymbolRasterizer as t}from"../cim/CIMSymbolRasterizer.js";import{getCIMSymbolSize as l,scaleCIMSymbolTo as i}from"./cimSymbolUtils.js";import{SymbolSizeDefaults as a}from"./previewUtils.js";import{renderSymbol as o}from"./renderUtils.js";const n=new t(null,!0),s=a.maxSize;async function r(t,a={}){const{size:r,maxSize:c,node:m,opacity:f}=a,p=a.cimOptions||a,{feature:u,fieldMap:y,geometryType:h,style:d}=p,g=l(t),w="number"==typeof r?r:null,b=Math.min(null!=w?w:g,null!=c?c:e(s));b!==g&&(t=t.clone(),i(t,b,{preserveOutlineWidth:!0}));let M=3;t&&t.data&&t.data.symbol&&"CIMPointSymbol"!==t.data.symbol.type&&(M=1);const S=await n.rasterizeCIMSymbolAsync(t,u,y,h,{scaleFactor:M,style:d}),j=document.createElement("canvas");j.width=S.imageData.width,j.height=S.imageData.height;j.getContext("2d").putImageData(S.imageData,0,0);let v=j.width/M,x=j.height/M;if(null!=r&&(null==(null==a?void 0:a.scale)||(null==a?void 0:a.scale))){const e=v/x;v=e<=1?Math.ceil(b*e):b,x=e<=1?b:Math.ceil(b/e)}const z=new Image(v,x);z.src=j.toDataURL(),null!=f&&(z.style.opacity=`${f}`);let C=z;if(null!=a.effectView){const e={shape:{type:"image",x:0,y:0,width:v,height:x,src:z.src},fill:null,stroke:null,offset:[0,0]};C=o([[e]],[v,x],{effectView:a.effectView})}return m&&m.appendChild(C),C}export{r as previewCIMSymbol};
