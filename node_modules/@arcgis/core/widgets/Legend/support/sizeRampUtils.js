/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import e from"../../../Color.js";import{isSymbol3D as l}from"../../../symbols.js";import{round as t,numDigits as n,percentChange as o}from"../../../renderers/support/numberUtils.js";import{applyCIMSymbolColor as i}from"../../../symbols/support/cimSymbolUtils.js";import{isVolumetricSymbol as s,getSymbolOutlineSize as r}from"../../../symbols/support/utils.js";import{createStopLabel as a,getSymbolForFlowRenderer as u}from"./utils.js";import{isDarkTheme as c}from"../../support/widgetThemeUtils.js";const m=30,f=12,p=[255,255,255],y=[200,200,200],b=[128,128,128],d=20,h=5;function v(e){return"esri.symbols.SimpleMarkerSymbol"===e.declaredClass}function g(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}function w(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}function S(e){return"esri.symbols.TextSymbol"===e.declaredClass}function z(e,l){const t=e.length-1;return e.map(((e,n)=>a(e,n,t,l)))}async function x(e,l,n,o,i,a){var u,c;const m=l.legendOptions,f=m&&m.customValues,p=await k(e,n),y=!!p,b=!!f,d=null!=l.minSize&&null!=l.maxSize,h=l.stops&&l.stops.length>1,v=!!l.target;if(!y||!b&&!(d||h&&!v))return;const g=s(p);let w=null,S=null,x=null;S=g&&!h?t([l.minDataValue,l.maxDataValue]):f||await O(l,p,o,i);const L=null==e?void 0:e.authoringInfo,C="univariate-color-size"===(null==L?void 0:L.type),I=C&&"above-and-below"===(null==L?void 0:L.univariateTheme);if(!S&&h&&(S=l.stops.map((e=>e.value)),w=l.stops.some((e=>!!e.label)),"flow"===e.type&&(S=t(S)),w&&(x=l.stops.map((e=>e.label)))),g&&(null==(u=S)?void 0:u.length)>2&&!I&&(S=[S[0],S[S.length-1]]),!S)return null;C&&5!==(null==(c=S)?void 0:c.length)&&(S=U({minSize:S[0],maxSize:S[S.length-1]}));const D=g?V(e,S):null,M=r(p),q=w?null:z(S,a);return(await Promise.all(S.map((async(t,n)=>{const s=g?D[n]:await T(l,p,t,o,i);return{value:t,symbol:E(I&&"class-breaks"===e.type?j(e,n):p,s),label:w?x[n]:q[n],size:s,outlineSize:M}})))).reverse()}function V(e,l){const t=null==e?void 0:e.authoringInfo,n="univariate-color-size"===(null==t?void 0:t.type);let o=[f,m];if(n){const e=l[0],t=l[l.length-1],n=f,i=m;o=l.map((l=>n+(l-e)/(t-e)*(i-n)))}return n&&"below"===(null==t?void 0:t.univariateTheme)&&o.reverse(),o}function j(e,l){const t=e.classBreakInfos,n=t.length,o=n<2||!(l>=2)?t[0].symbol.clone():t[n-1].symbol.clone();return e.visualVariables.some((e=>"color"===e.type))&&(o.type.indexOf("3d")>-1?C(o):I(o)),o}async function k(e,l){if("flow"===e.type)return u(e,l);let t=null,n=null;if("simple"===e.type)t=e.symbol;else if("class-breaks"===e.type){const l=e.classBreakInfos;t=l&&l[0]&&l[0].symbol,n=l.length>1}else if("unique-value"===e.type){const l=e.uniqueValueInfos;t=l&&l[0]&&l[0].symbol,n=l.length>1}return!t||L(t)?null:(t=t.clone(),(l||n)&&(t.type.indexOf("3d")>-1?C(t):I(t)),t)}function L(e){if(e){if(l(e)){return!!e.symbolLayers&&e.symbolLayers.some((e=>e&&"fill"===e.type))}return-1!==e.type.indexOf("fill")}return!1}function C(e){"line-3d"===e.type?e.symbolLayers.forEach((e=>{e.material={color:b}})):e.symbolLayers.forEach((e=>{"icon"!==e.type||e.resource&&e.resource.href?e.material={color:y}:(e.material={color:p},e.outline={color:b,size:1.5})}))}function I(l){const t=c();if("cim"===l.type)i(l,new e(y));else if(-1!==l.type.indexOf("line"))l.color=b;else if(l.color=t?b:p,"simple-marker"===l.type)if(l.outline){var n,o;"#ffffff"===(null==(n=l.outline)||null==(o=n.color)?void 0:o.toHex())&&(l.outline.color=b)}else l.outline={color:b,width:1.5}}async function O(e,l,n,o){const i=(await import("../../../renderers/visualVariables/support/visualVariableUtils.js")).getSizeRangeAtScale(e,n,o),s=i&&U(i);if(!i&&!s)return;let r=s.map((l=>D(l,e,i)));r=t(r);for(let t=1;t<r.length-1;t++){const i=await M(e,l,r[t],r[t-1],n,o);i&&(r[t]=i[0],s[t]=i[1])}return r}function U(e){const l=e.minSize,t=e.maxSize,n=h,o=(t-l)/(n-1),i=[];for(let s=0;s<n;s++)i.push(l+o*s);return i}function D(e,l,t){const n=t.minSize,o=t.maxSize,i=l.minDataValue,s=l.maxDataValue;let r=null;if(e<=n)r=i;else if(e>=o)r=s;else{r=(e-n)/(o-n)*(s-i)+i}return r}async function M(e,l,i,s,r,a){const u=await T(e,l,i,r,a),c=await T(e,l,s,r,a),m=n(i),f=m.fractional,p=d;let y=m.integer,b=null,h=null;i>0&&i<1&&(b=10**f,y=n(i*=b).integer);for(let n=y-1;n>=0;n--){const s=10**n;let m=Math.floor(i/s)*s,f=Math.ceil(i/s)*s;null!=b&&(m/=b,f/=b);let y=(m+f)/2;[,y]=t([m,y,f],{indexes:[1]});const d=await T(e,l,m,r,a),v=await T(e,l,f,r,a),g=await T(e,l,y,r,a),w=o(u,d,c,null),S=o(u,v,c,null),z=o(u,g,c,null);let x=w.previous<=p,V=S.previous<=p;if(x&&V&&(w.previous<=S.previous?(x=!0,V=!1):(V=!0,x=!1)),x?h=[m,d]:V?h=[f,v]:z.previous<=p&&(h=[y,g]),h)break}return h}async function T(e,l,t,n,o){const{getSize:i}=await import("../../../renderers/visualVariables/support/visualVariableUtils.js");return i(e,t,{scale:n,view:o,shape:"simple-marker"===l.type?l.style:null})}function E(e,t){const n=e.clone();if(l(n))s(n)||n.symbolLayers.forEach((e=>{"fill"!==e.type&&(e.size=t)}));else if(v(n))n.size=t;else if(g(n)){const e=n.width,l=n.height;n.height=t,n.width=t*(e/l)}else w(n)?n.width=t:S(n)&&n.font&&(n.font.size=t);return n}export{m as REAL_WORLD_MAX_SIZE,f as REAL_WORLD_MIN_SIZE,x as getRampStops};
