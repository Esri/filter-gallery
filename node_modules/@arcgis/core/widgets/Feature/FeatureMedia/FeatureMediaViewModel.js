/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import e from"../../../core/Accessor.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import{cast as o}from"../../../core/accessorSupport/decorators/cast.js";import{subclass as r}from"../../../core/accessorSupport/decorators/subclass.js";import a from"../../../popup/FieldInfo.js";import s from"../../../popup/content/support/ChartMediaInfoValueSeries.js";import{substituteFieldsInLinksAndAttributes as l,fixTokens as n,substituteAttributes as d,getFixedFieldNames as p,getFixedFieldName as u,isRelatedField as f,formatValueToFieldInfo as c,getFieldInfo as m,getFieldInfoLabel as h}from"../support/featureUtils.js";import{getRelatedFieldInfo as y}from"../support/relatedFeatureUtils.js";const v={chartAnimation:!0};let I=class extends e{constructor(t){super(t),this.abilities={...v},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(t){return{...v,...t}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,i=(t+e)%e;this.activeMediaInfoIndex=i}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,i=e+t;this._setContentElementMedia(i)}_formatMediaInfos(){const{attributes:t,mediaInfos:e,formattedAttributes:i,expressionAttributes:o,fieldInfoMap:r,layer:a}=this;return null==e?void 0:e.map((e=>{const s=null==e?void 0:e.clone();if(!s)return null;if(s.title=l({attributes:t,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:s.title}),s.caption=l({attributes:t,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:s.caption}),s.altText=l({attributes:t,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:s.altText}),"image"===s.type){const{value:t}=s;return this._setImageValue({value:t,formattedAttributes:i,layer:a}),s.value.sourceURL?s:void 0}if("pie-chart"===s.type||"line-chart"===s.type||"column-chart"===s.type||"bar-chart"===s.type){const{value:e}=s;return this._setChartValue({value:e,chartType:s.type,attributes:t,formattedAttributes:i,layer:a}),s}return null})).filter(Boolean)}_setImageValue(t){const{fieldInfoMap:e}=this,{value:i,formattedAttributes:o,layer:r}=t,{linkURL:a,sourceURL:s}=i;if(s){const t=n(s,r);i.sourceURL=d({formattedAttributes:o,template:t,fieldInfoMap:e})}if(a){const t=n(a,r);i.linkURL=d({formattedAttributes:o,template:t,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:i,formattedAttributes:o,chartType:r,layer:a}=t,{popupTemplate:s,relatedInfos:l}=this,{fields:n,normalizeField:d}=e;e.fields=p(n,a),d&&(e.normalizeField=u(d,a));if(!n.some((t=>!!(null!=o[t]||f(t)&&l.size))))return;const c=null==s?void 0:s.fieldInfos;n.forEach((t=>{if(f(t))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:c,fieldName:t,formattedAttributes:o,chartType:r,value:e})]);const a=this._getChartOption({value:e,attributes:i,chartType:r,formattedAttributes:o,fieldName:t,fieldInfos:c});e.series.push(a)}))}_getRelatedChartInfos(t){var e;const{fieldInfos:i,fieldName:o,formattedAttributes:r,chartType:a,value:s}=t,l=[],n=y(o),{layerId:d,fieldName:p}=n,u=null==(e=this.relatedInfos)?void 0:e.get(d.toString());if(!u)return l;const{relatedFeatures:f,relation:c}=u;if(!c||!f)return l;const{cardinality:m}=c;f.forEach((t=>{const{attributes:e}=t;e&&Object.keys(e).forEach((t=>{t===p&&l.push(this._getChartOption({value:s,attributes:e,formattedAttributes:r,fieldName:o,chartType:a,relatedFieldName:t,fieldInfos:i}))}))}));return"one-to-many"===m||"many-to-many"===m?l:[l[0]]}_getTooltip({label:t,value:e,chartType:i}){return"pie-chart"===i?t:`${t}: ${e}`}_getChartOption(t){var e;const{value:i,attributes:o,formattedAttributes:r,fieldName:l,relatedFieldName:n,fieldInfos:d,chartType:p}=t,{layer:v}=this,{normalizeField:I,tooltipField:b}=i,M=I?f(I)?o[y(I).fieldName]:o[I]:null,A=n&&void 0!==o[n]?o[n]:void 0!==o[l]?o[l]:r[l],g=void 0===A?null:A&&M?A/M:A,_=new s({value:g});if(f(l)){const t=y(l),e=y(b),i=e?e.fieldName:null,r=c(g,{fieldInfos:d,fieldName:n,layer:v,preventPlacesFormatting:!!M}),a=t?t.label||t.fieldName:n,s=i&&void 0!==o[i]?o[i]:a;return _.tooltip=this._getTooltip({label:s,value:r,chartType:p}),_}const x=m(d,l),T=u(l,v),C=b&&void 0!==r[b]?r[b]:h(x||new a({fieldName:T}),null==(e=this.popupTemplate)?void 0:e.expressionInfos),F=r[T];return _.tooltip=this._getTooltip({label:C,value:F,chartType:p}),_}};t([i()],I.prototype,"abilities",void 0),t([o("abilities")],I.prototype,"castAbilities",null),t([i()],I.prototype,"activeMediaInfoIndex",void 0),t([i({readOnly:!0})],I.prototype,"activeMediaInfo",null),t([i()],I.prototype,"attributes",void 0),t([i()],I.prototype,"description",void 0),t([i()],I.prototype,"fieldInfoMap",void 0),t([i()],I.prototype,"formattedAttributes",void 0),t([i()],I.prototype,"expressionAttributes",void 0),t([i({readOnly:!0})],I.prototype,"formattedMediaInfos",null),t([i()],I.prototype,"layer",void 0),t([i({readOnly:!0})],I.prototype,"formattedMediaInfoCount",null),t([i()],I.prototype,"mediaInfos",void 0),t([i()],I.prototype,"popupTemplate",void 0),t([i()],I.prototype,"relatedInfos",void 0),t([i()],I.prototype,"title",void 0),I=t([r("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],I);const b=I;export{b as default};
