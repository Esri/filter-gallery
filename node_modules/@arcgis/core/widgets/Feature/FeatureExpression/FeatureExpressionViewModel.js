/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../Graphic.js";import{x as o}from"../../../chunks/languageUtils.js";import r from"../../../core/Accessor.js";import{HandleOwnerMixin as n}from"../../../core/HandleOwner.js";import{throttle as s}from"../../../core/throttle.js";import{init as i}from"../../../core/watchUtils.js";import{property as l}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as p}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import a from"../../../popup/content/FieldsContent.js";import c from"../../../popup/content/MediaContent.js";import m from"../../../popup/content/TextContent.js";import d from"../../../popup/ElementExpressionInfo.js";import u from"../FeatureContent/FeatureContentViewModel.js";import h from"../FeatureFields/FeatureFieldsViewModel.js";import f from"../FeatureMedia/FeatureMediaViewModel.js";import{loadArcadeUtils as _,createCompiledExpression as v}from"../support/arcadeFeatureUtils.js";const y=1;let w=class extends(n(r)){constructor(e){super(e),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:e}=this;e&&e.abort(),this._abortController=null},this._createVM=()=>{var e,t;const o=null==(e=this.contentElement)?void 0:e.type;null==(t=this.contentElementViewModel)||t.destroy();const r="fields"===o?new h:"media"===o?new f:"text"===o?new u:null;this._set("contentElementViewModel",r)},this._compile=async()=>{this._cancelQuery();const e=new AbortController;this._abortController=e,await this._compileExpression(),this._abortController===e&&(this._abortController=null)},this._compileThrottled=s(this._compile,y,this),this._compileExpression=async()=>{const{expressionInfo:e,graphic:t,interceptor:r,spatialReference:n,map:s,view:i,_abortController:l}=this;if(!(e&&t&&n&&s))return void this._set("contentElement",null);const p=await _();if(l!==this._abortController)return;const d=await v({arcadeUtils:p,expressionInfo:e,graphic:t,interceptor:r,map:s,spatialReference:n,view:i});if(!d||"esri.arcade.Dictionary"!==d.declaredClass)return void this._set("contentElement",null);const u=await o(d,l.signal),h=null==u?void 0:u.type,f="media"===h?c.fromJSON(u):"text"===h?m.fromJSON(u):"fields"===h?a.fromJSON(u):null;this._set("contentElement",f)},this.handles.add([i(this,["expressionInfo","graphic","map","spatialReference","view"],this._compileThrottled),i(this,"contentElement",this._createVM)])}destroy(){var e;this._cancelQuery(),null==(e=this.contentElementViewModel)||e.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){var e;return(null==(e=this.view)?void 0:e.spatialReference)||null}set spatialReference(e){void 0!==e?this._override("spatialReference",e):this._clearOverride("spatialReference")}get state(){const{_abortController:e,contentElement:t,contentElementViewModel:o}=this;return e?"loading":t||o?"ready":"disabled"}get map(){var e;return(null==(e=this.view)?void 0:e.map)||null}set map(e){void 0!==e?this._override("map",e):this._clearOverride("map")}};e([l()],w.prototype,"_abortController",void 0),e([l({type:d})],w.prototype,"expressionInfo",void 0),e([l({type:t})],w.prototype,"graphic",void 0),e([l({readOnly:!0})],w.prototype,"contentElement",void 0),e([l({readOnly:!0})],w.prototype,"contentElementViewModel",void 0),e([l()],w.prototype,"interceptor",void 0),e([l()],w.prototype,"spatialReference",null),e([l({readOnly:!0})],w.prototype,"state",null),e([l()],w.prototype,"map",null),e([l()],w.prototype,"view",void 0),w=e([p("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],w);const j=w;export{j as default};
