/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import"../../../intl.js";import e from"../../../core/Logger.js";import{isNone as t,isSome as r}from"../../../core/maybe.js";import{replace as n}from"../../../core/string.js";import{formatDate as i,convertDateFormatToIntlOptions as o}from"../../../intl/date.js";import{formatNumber as a,convertNumberFormatToIntlOptions as u}from"../../../intl/number.js";import{featureHasFields as l}from"../../../layers/support/fieldUtils.js";import s from"../../../popup/support/FieldInfoFormat.js";import{loadArcade as f}from"../../../support/arcadeOnDemand.js";const c="esri.widgets.Feature.support.featureUtils",d=e.getLogger(c),p=/href=(""|'')/gi,m=/(\{([^\{\r\n]+)\})/g,y=/\'/g,g=/^\s*expression\//i,h=/(\n)/gi,b=/[\u00A0-\u9999<>\&]/gim,F=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,I=/^(?:mailto:|tel:)/,w="relationships/",N=o("short-date-short-time");function x(e){if(!t(e))return e.get("sourceLayer")||e.get("layer")}async function E(e,t){return"function"==typeof e?e.call(null,t):e}function v(e=""){if(e)return!I.test(e.trim().toLowerCase())}function j(e){return!!e&&g.test(e)}function T(e,t){if(!j(t)||!e)return null;const r=t.replace(g,"").toLowerCase();let n;return e.some((e=>e.name.toLowerCase()===r&&(n=e,!0))),n}function C(e,t){const r=T(t,null==e?void 0:e.fieldName);return r?r.title||null:e?e.label||e.fieldName:null}function q(e,t){const r=t.get(e.toLowerCase());return`{${r&&r.fieldName||e}}`}function D(e){return e.replace(p,"")}function R(e,t){const r=M(t,e);return r?r.name:e}function L(e,t){return e&&e.map((e=>R(e,t)))}function M(e,t){return e&&"function"==typeof e.getField?e.getField(t):null}function U(e){return`${e}`.trim()}function $({attributes:e,globalAttributes:t,layer:r,text:n,expressionAttributes:i,fieldInfoMap:o}){return n?A({formattedAttributes:t,template:P(n,{...t,...i,...e},r),fieldInfoMap:o}):""}function A({formattedAttributes:e,template:t,fieldInfoMap:r}){return U(D(n(n(t,(e=>q(e,r))),e)))}function O(e,t,r=!1){const n=t[e];if("string"==typeof n){const i="%27",o=(r?encodeURIComponent(n):n).replace(y,i);t[e]=o}}function S(e,t=!1){const r={...e};return Object.keys(r).forEach((e=>O(e,r,t))),r}function G(e,t,r){const i=(t=U(t))&&"{"!==t[0];return n(e,S(r,i))}function k(e,t){return e.replace(m,((e,r,n)=>{const i=M(t,n);return i?`{${i.name}}`:r}))}function P(e,t,r){const n=k(e,r);return n?n.replace(F,((e,r,n)=>G(e,r||n,t))):n}function _(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}function z(e){return"feature"===(null==e?void 0:e.type)}function H(e){return"map-image"===(null==e?void 0:e.type)}function Q(e){return!(null==e||!e.layer)}function Z(e,t){const r=t.fieldInfos,n=t.fieldName,i=B(r,n),o=null==i?void 0:i.clone(),l=t.preventPlacesFormatting,f=t.layer,c=M(f,n);if(o&&"date"===(null==c?void 0:c.type)){const e=o.format||new s;e.dateFormat=e.dateFormat||"short-date-short-time",e.dateTimeFormatOptions=z(f)&&f.datesInUnknownTimezone||Q(f)&&H(f.layer)&&f.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null,o.format=e}const d=o&&o.format;return"string"==typeof(e=_(e,d))||null==e||null==d?ee(e):l?a(e,{...u(d),minimumFractionDigits:0,maximumFractionDigits:20}):d.format(e)}function B(e,t){if(!e||!e.length||!t)return;const r=t.toLowerCase();let n;return e.some((e=>!(!e.fieldName||e.fieldName.toLowerCase()!==r)&&(n=e,!0))),n}function J({fieldName:e,graphic:t,layer:r}){if(ae(e))return null;if(!r||"function"!=typeof r.getFeatureType)return null;const{typeIdField:n}=r;if(!n||e!==n)return null;const i=r.getFeatureType(t);return i?i.name:null}function K({fieldName:e,value:t,graphic:r,layer:n}){if(ae(e))return null;if(!n||"function"!=typeof n.getFieldDomain)return null;const i=n.getFieldDomain(e,{feature:r});return i&&"coded-value"===i.type?i.getName(t):null}function V(e,t){const{creatorField:r,creationDateField:n,editorField:o,editDateField:a}=e;if(!t)return;const u=t[a];if("number"==typeof u){const e=t[o];return{type:"edit",date:i(u,N),user:e}}const l=t[n];if("number"==typeof l){const e=t[r];return{type:"create",date:i(l,N),user:e}}return null}function W(e,t){const r=new Map;return e&&e.forEach((e=>{const n=R(e.fieldName,t);e.fieldName=n,r.set(n.toLowerCase(),e)})),r}function X(e){const t=[];if(!e)return t;const{fieldInfos:r,content:n}=e;return r&&t.push(...r),n&&Array.isArray(n)?(n.forEach((e=>{if("fields"===e.type){const r=e&&e.fieldInfos;r&&t.push(...r)}})),t):t}function Y(e){return e.replace(b,(e=>`&#${e.charCodeAt(0)};`))}function ee(e){return"string"==typeof e?e.replace(h,'<br class="esri-text-new-line" />'):e}function te(e){const{value:t,fieldName:r,fieldInfos:n,fieldInfoMap:o,layer:a,graphic:u}=e;if(null==t)return"";const l=K({fieldName:r,value:t,graphic:u,layer:a});if(l)return l;const s=J({fieldName:r,graphic:u,layer:a});if(s)return s;if(o.get(r.toLowerCase()))return Z(t,{fieldInfos:n,fieldName:r,layer:a});const f=a&&a.fieldsIndex;return f&&f.isDateField(r)?i(t,N):ee(t)}function re({fieldInfos:e,attributes:t,layer:r,graphic:n,fieldInfoMap:i,relatedInfos:o}){const a={};return null==o||o.forEach((e=>se(a,e))),Object.keys(t).forEach((o=>{const u=t[o];a[o]=te({fieldName:o,fieldInfos:e,fieldInfoMap:i,layer:r,value:u,graphic:n})})),a}async function ne(e,t){var r,n;const{layer:i,graphic:o,outFields:a,objectIds:u,returnGeometry:l,spatialReference:s}=e,f=u[0];if("number"!=typeof f&&"string"!=typeof f){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:i,graphic:o,objectId:f,requiredFields:a};return d.warn(e,t),null}if(null==(r=i.capabilities)||null==(n=r.operations)||!n.supportsQuery){const e="The specified layer cannot be queried. The following fields will not be available.",t={layer:i,graphic:o,requiredFields:a,returnGeometry:l};return d.warn(e,t),null}const c=i.createQuery();c.objectIds=u,c.outFields=null!=a&&a.length?a:[i.objectIdField],c.returnGeometry=!!l,c.returnZ=!!l,c.returnM=!!l,c.outSpatialReference=s;return(await i.queryFeatures(c,t)).features[0]}async function ie(e){var t;if(null==(t=e.expressionInfos)||!t.length)return!1;const r=await f(),{arcadeUtils:{hasGeometryFunctions:n}}=r;return n(e)}async function oe({graphic:e,popupTemplate:t,layer:r,spatialReference:n},i){if(!r||!t)return;if("function"==typeof r.load&&await r.load(i),!e.attributes)return;const o=e.attributes[r.objectIdField];if(null==o)return;const a=[o],u=await t.getRequiredFields(r.fieldsIndex),s=l(u,e),f=s?[]:u,c=t.returnGeometry||await ie(t);if(s&&!c)return;const d=await ne({layer:r,graphic:e,outFields:f,objectIds:a,returnGeometry:c,spatialReference:n},i);d&&(d.geometry&&(e.geometry=d.geometry),d.attributes&&(e.attributes={...e.attributes,...d.attributes}))}function ae(e=""){return!!e&&-1!==e.indexOf(w)}function ue(e){return e?`${w}${e.layerId}/${e.fieldName}`:""}function le({attributes:e,graphic:t,relatedInfo:r}){e&&t&&r&&Object.keys(t.attributes).forEach((n=>{const i=ue({layerId:r.relation.id.toString(),fieldName:n});e[i]=t.attributes[n]}))}function se(e,t){e&&t&&(t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach((r=>le({attributes:e,graphic:r,relatedInfo:t}))),t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach((r=>le({attributes:e,graphic:r,relatedInfo:t}))))}const fe=e=>{if(!e)return!1;const t=e.toUpperCase();return t.indexOf("CURRENT_TIMESTAMP")>-1||t.indexOf("CURRENT_DATE")>-1||t.indexOf("CURRENT_TIME")>-1},ce=({layer:e,method:t,query:n,definitionExpression:i})=>{var o,a;if(null==(o=e.capabilities)||null==(a=o.query)||!a.supportsCacheHint||"attachments"===t)return;const u=r(n.where)&&n.where,l=r(n.geometry)&&n.geometry;fe(i)||fe(u)||"extent"===(null==l?void 0:l.type)||"tile"===n.resultType||(n.cacheHint=!0)},de=({query:e,layer:t,method:r})=>{ce({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},pe=({queryPayload:e,layer:t,method:r})=>{ce({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})};export{ee as applyTextFormattingHTML,W as createfieldInfoMap,k as fixTokens,re as formatAttributes,V as formatEditInfo,Z as formatValueToFieldInfo,X as getAllFieldInfos,B as getFieldInfo,C as getFieldInfoLabel,R as getFixedFieldName,L as getFixedFieldNames,x as getSourceLayer,E as graphicCallback,Y as htmlEntities,j as isExpressionField,ae as isRelatedField,de as preLayerQueryCallback,pe as preRequestCallback,oe as queryUpdatedFeature,v as shouldOpenInNewTab,A as substituteAttributes,$ as substituteFieldsInLinksAndAttributes};
