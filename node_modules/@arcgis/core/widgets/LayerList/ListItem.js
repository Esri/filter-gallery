/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Accessor.js";import i from"../../core/Collection.js";import{HandleOwnerMixin as r}from"../../core/HandleOwner.js";import{IdentifiableMixin as s}from"../../core/Identifiable.js";import{init as o,watch as l}from"../../core/watchUtils.js";import{aliasOf as a}from"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/arrayUtils.js";import"../../core/has.js";import{cast as n}from"../../core/accessorSupport/decorators/cast.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import{subclass as h}from"../../core/accessorSupport/decorators/subclass.js";import d from"../../support/actions/ActionBase.js";import c from"../../support/actions/ActionButton.js";import y from"../../support/actions/ActionSlider.js";import u from"../../support/actions/ActionToggle.js";import m from"./ListItemPanel.js";import{isLayerOutsideScaleRange as v,findLayerVisibilityMode as w,findLayerListMode as f,canDisplayLayer as g,getNormalizedChildLayerProperty as _}from"./support/layerListUtils.js";var b;const j=i.ofType({key:"type",defaultKeyValue:"button",base:d,typeMap:{button:c,toggle:u,slider:y}}),S=i.ofType(j),L="layer",O="child-list-mode",C="hide",P="esri.widgets.LayerList.ListItem";let A=b=class extends(s(r(t))){constructor(e){super(e),this.actionsSections=new S,this.actionsOpen=!1,this.children=new(i.ofType(b)),this.childrenSortable=!0,this.error=null,this.layer=null,this.layerView=null,this.open=!1,this.panel=null,this.parent=null,this.sortable=!0,this.view=null,this.visible=null}initialize(){this.handles.add([o(this,"layer",(e=>this._watchLayerProperties(e))),o(this,"view",(e=>this._updateChildren(e))),o(this,"panel",(e=>this._setListItemOnPanel(e))),o(this,["layer","view"],(()=>this._getLayerView()))])}destroy(){this.view=null}get incompatible(){const{layerView:e}=this;return!(!e||!("spatialReferenceSupported"in e))&&!e.spatialReferenceSupported}castPanel(e){return this.get("panel.open")&&!e.hasOwnProperty("open")&&(e.open=!0),e?new m(e):null}get title(){const e=this.get("layer.layer");return(!e||e&&this.get("layer.layer.loaded"))&&this.get("layer.title")||this.get("layer.attributes.title")||""}set title(e){void 0!==e?this._override("title",e):this._clearOverride("title")}get updating(){const e=this.layerView;return e?e.updating:this._isLayerUpdating(this.layer)}get visibleAtCurrentScale(){return!v(this.layer,this.get("view.scale"))}get visibilityMode(){return w(this.layer)}clone(){return new b({actionsSections:this.actionsSections.clone(),actionsOpen:this.actionsOpen,children:this.children.clone(),layer:this.layer,open:this.open,panel:this.panel,title:this.title,view:this.view,visible:this.visible})}_setListItemOnPanel(e){e&&(e.listItem=this)}_updateChildren(e){const t=this.children;t&&t.forEach((t=>t.view=e))}_addChildren(e){if(this.handles.remove(O),this.children.removeAll(),!e)return;e.forEach((t=>{this.handles.add(l(t,"listMode",(()=>this._addChildren(e))),O)}));const t=e.filter((e=>f(e)!==C));this.children.addMany(this._makeChildren(t))}_watchSublayerChanges(e){e&&this.handles.add(e.on("change",(()=>{this._addChildren(e)})),L)}_initializeChildLayers(e){this._addChildren(e),this._watchSublayerChanges(e)}_makeChildren(e){return e.map((e=>g(e)?new b({layer:e,parent:this,view:this.view}):null)).reverse()}_watchLayerProperties(e){if(!this.handles)return;if(this.handles.remove(L),this.handles.remove(O),!e)return;this.handles.add(l(e,"listMode",(()=>this._watchLayerProperties(e))),L);if("hide-children"===f(e))return void this.children.removeAll();const t=_(e);t&&this.handles.add(o(e,t,(()=>{e.hasOwnProperty(t)&&this._initializeChildLayers(e[t])})),L)}async _getLayerView(){const{layer:e,view:t}=this;if(e&&t)try{const i=await t.whenLayerView(e);if(i.layer!==this.layer)return;this._set("layerView",i)}catch{}}_isLayerUpdating(e){return e&&"loading"===e.loadStatus}};e([p({type:S})],A.prototype,"actionsSections",void 0),e([p()],A.prototype,"actionsOpen",void 0),e([p({type:i})],A.prototype,"children",void 0),e([p()],A.prototype,"childrenSortable",void 0),e([a("layer.loadError?")],A.prototype,"error",void 0),e([p({readOnly:!0})],A.prototype,"incompatible",null),e([p()],A.prototype,"layer",void 0),e([p({readOnly:!0})],A.prototype,"layerView",void 0),e([p()],A.prototype,"open",void 0),e([p({type:m})],A.prototype,"panel",void 0),e([n("panel")],A.prototype,"castPanel",null),e([p()],A.prototype,"parent",void 0),e([p()],A.prototype,"sortable",void 0),e([p()],A.prototype,"title",null),e([p({readOnly:!0})],A.prototype,"updating",null),e([p({value:null})],A.prototype,"view",void 0),e([a("layer.visible")],A.prototype,"visible",void 0),e([p({readOnly:!0})],A.prototype,"visibleAtCurrentScale",null),e([p({readOnly:!0})],A.prototype,"visibilityMode",null),A=b=e([h(P)],A);const V=A;export{V as default};
