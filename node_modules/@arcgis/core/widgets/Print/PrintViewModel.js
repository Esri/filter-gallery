/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../intl.js";import t from"../../request.js";import r from"../../core/Collection.js";import{deprecatedProperty as o}from"../../core/deprecate.js";import s from"../../core/Error.js";import i from"../../core/Handles.js";import{clone as a}from"../../core/lang.js";import l from"../../core/Loadable.js";import n from"../../core/Logger.js";import{unwrap as p}from"../../core/maybe.js";import{property as m}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import{subclass as c}from"../../core/accessorSupport/decorators/subclass.js";import u from"../../portal/Portal.js";import{execute as d}from"../../rest/geoprocessor/execute.js";import"../../rest/geoprocessor/GPOptions.js";import"../../core/has.js";import"../../geometry/support/normalizeUtils.js";import"../../layers/support/Field.js";import"../../layers/support/MapImage.js";import"../../core/urlUtils.js";import"../../core/unitUtils.js";import"../../rest/support/DataFile.js";import"../../rest/support/FeatureSet.js";import"../../rest/support/LinearUnit.js";import"../../rest/support/ParameterValue.js";import"../../rest/support/RasterData.js";import"../../rest/support/JobInfo.js";import{execute as f}from"../../rest/print.js";import{fromJSON as h}from"../../rest/support/fileFormat.js";import{fromJSON as y}from"../../rest/support/layoutTemplate.js";import v from"../../rest/support/PrintParameters.js";import T from"../../rest/support/PrintTemplate.js";import w from"./CustomTemplate.js";import{formatDate as x,convertDateFormatToIntlOptions as j}from"../../intl/date.js";const g=6e4,E=r.ofType(w);function O(e){e.layoutOptions||(e.layoutOptions={}),e.layoutOptions.customTextElements||(e.layoutOptions.customTextElements=[]);const t="date";if(!e.layoutOptions.customTextElements.find((e=>t in e))){const{customTextElements:t}=e.layoutOptions;t.push({date:x(Date.now(),j("short-date"))})}}let S=class extends l{constructor(e){super(e),this._handles=new i,this.allowedFormats="all",this.allowedLayouts="all",this.defaultTemplates=new E,this.extraParameters=null,this.includeDefaultTemplates=!0,this.effectivePrintServiceUrl=null,this.error=null,this.portal=u.getDefault(),this.printServiceUrl=null,this.templatesInfo=null,this.updateDelay=1e3,this.view=null,this.templateCustomTextElements=null,this.print=this.print.bind(this)}destroy(){this._handles.destroy(),this._handles=null,this.view=null}get effectiveTemplateCustomTextElements(){if(!this._serviceTemplateCustomTextElements)return{};const e=a(this._serviceTemplateCustomTextElements);return this.templateCustomTextElements&&Object.keys(this.templateCustomTextElements).forEach((t=>{const r=e[t];if(r){const e=this.templateCustomTextElements[t];r.forEach((t=>{const[r]=Object.entries(t)[0];e.find((e=>{const[o,s]=Object.entries(e)[0];r===o&&(t[r]=s)}))}))}})),Object.freeze(e)}get state(){return"loading"===this.loadStatus?"initializing":this.error||"failed"===this.loadStatus?"error":this.get("view.ready")&&"loaded"===this.loadStatus?"ready":"disabled"}set scaleEnabled(e){o(n.getLogger(this.declaredClass),"scaleEnabled",{version:"4.22"}),this.set("scaleEnabled",e)}async load(e){return this.addResolvingPromise(this._loadResources(e).catch((e=>this.error=e))),this}async print(e){const{view:t,extraParameters:r,updateDelay:o}=this;if(!t)throw new s("print:view-required","view is not set");O(e);const i=new v({view:t,template:e,extraParameters:r,updateDelay:o});try{return await f(this.effectivePrintServiceUrl,i)}catch(a){throw new s("print:export-error","An error occurred while exporting the web map.",{error:a})}}toPrintTemplate({attributionEnabled:e,author:t,copyright:r,customTextElements:o,dpi:s,forceFeatureAttributes:i,format:a,height:l,layout:n,legendEnabled:p,title:m,scale:c,scaleEnabled:u,width:d}){const f=new T({attributionVisible:e,layoutOptions:{authorText:t||"",copyrightText:r||"",customTextElements:o,titleText:m||""},forceFeatureAttributes:i,format:a,layout:n,scalePreserved:u,outScale:c});return d&&(f.exportOptions.width=d),l&&(f.exportOptions.height=l),s&&(f.exportOptions.dpi=s),p||(f.layoutOptions.legendLayers=[]),f}async _loadResources(e){let t=[];const{printServiceUrl:r}=this;if(!r){var o;if(this.destroyed)return;const{portal:r}=this;try{await r.load(e)}catch(a){throw new s("print:could-not-load-portal","Cannot load print resource information from portal",{url:this.effectivePrintServiceUrl})}const l=null==(o=r.helperServices)?void 0:o.printTask;var i;if(l)this._set("effectivePrintServiceUrl",l.url),t=(null!=(i=null==l?void 0:l.templates)?i:[]).map((e=>w.fromJSON(e)))}t.length>0&&this.defaultTemplates.addMany(t);if(-1===this.effectivePrintServiceUrl.toLowerCase().split("/").indexOf("gpserver"))throw new s("print:invalid-print-service-url","Can't fetch print templates information from provided URL",{url:this.effectivePrintServiceUrl});this._serviceTemplateCustomTextElements=await this._getTemplateToCustomTextElements(e),await this._loadServiceDescription(e)}async _loadServiceDescription(e){const t=await this._getPrintTemplatesFromService(e);this._set("templatesInfo",t)}async _getTemplateToCustomTextElements(e){const t={};try{const r=this.effectivePrintServiceUrl.replace(/(\/GPServer\/).+/i,"$1Get%20Layout%20Templates%20Info"),{results:[o]}=await d(r,null,null,p(e));o.value.forEach((({layoutTemplate:e,layoutOptions:{customTextElements:r}})=>t[y(e)]=r))}catch(r){}return Object.freeze(t)}async _getPrintTemplatesFromService(e){return t(this.effectivePrintServiceUrl,{...e,query:{f:"json"},timeout:g}).then((e=>{const t=e&&e.data,r=t&&t.parameters;let o=null,s=null;r.forEach((e=>{let t,r=e.choiceList&&e.choiceList.slice();r&&r.length&&e.defaultValue&&(t=r.indexOf(e.defaultValue)),t>-1&&(r.splice(t,1),r.unshift(e.defaultValue));const i=(e,t)=>{const r="all"===t?e:e.filter((e=>t.indexOf(e)>-1));return 0===r.length?e:r};if("Format"===e.name){const t=i(r.map(h),this.allowedFormats),s=h(e.defaultValue);o={defaultValue:t.includes(s)?s:t[0],choiceList:t}}else if("Layout_Template"===e.name){let t,o;r=r.filter((e=>"map_only"!==e.toLowerCase())),r.some(((e,r)=>{const o=e.toLowerCase();return o.indexOf("letter")>-1&&o.indexOf("landscape")>-1?(t=r,!0):o.indexOf("a4")>-1&&o.indexOf("landscape")>-1&&(t=r,!1)})),t&&(o=r[t],r.splice(t,1),r.unshift(o));const a=i(r.map(y),this.allowedLayouts),l=y(e.defaultValue);s={defaultValue:a.includes(l)?l:a[0],choiceList:a}}})),this.error=null;return{format:o,layout:s}})).catch((e=>{throw new s("print:unavailable-service-info","Can't fetch templates info from service",{error:e})}))}};e([m()],S.prototype,"_serviceTemplateCustomTextElements",void 0),e([m()],S.prototype,"allowedFormats",void 0),e([m()],S.prototype,"allowedLayouts",void 0),e([m({type:E})],S.prototype,"defaultTemplates",void 0),e([m()],S.prototype,"extraParameters",void 0),e([m()],S.prototype,"includeDefaultTemplates",void 0),e([m({aliasOf:{source:"printServiceUrl",overridable:!0},readOnly:!0})],S.prototype,"effectivePrintServiceUrl",void 0),e([m()],S.prototype,"effectiveTemplateCustomTextElements",null),e([m()],S.prototype,"error",void 0),e([m({type:u})],S.prototype,"portal",void 0),e([m()],S.prototype,"printServiceUrl",void 0),e([m({readOnly:!0})],S.prototype,"state",null),e([m()],S.prototype,"scaleEnabled",null),e([m({readOnly:!0})],S.prototype,"templatesInfo",void 0),e([m()],S.prototype,"updateDelay",void 0),e([m()],S.prototype,"view",void 0),e([m()],S.prototype,"templateCustomTextElements",void 0),S=e([c("esri.widgets.Print.PrintViewModel")],S);const b=S;export{b as default};
