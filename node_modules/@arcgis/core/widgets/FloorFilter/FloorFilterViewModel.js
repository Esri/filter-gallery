/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import i from"../../core/Collection.js";import t from"../../core/Error.js";import{HandleOwner as l}from"../../core/HandleOwner.js";import{isSome as s}from"../../core/maybe.js";import{createTask as r}from"../../core/promiseUtils.js";import{Milliseconds as o}from"../../core/time.js";import{init as n,watch as a}from"../../core/watchUtils.js";import{property as u}from"../../core/accessorSupport/decorators/property.js";import"../../core/arrayUtils.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import{subclass as d}from"../../core/accessorSupport/decorators/subclass.js";import h from"../../webdoc/Widgets.js";import c from"../../webdoc/widgets/FloorFilter.js";import{GoToMixin as f}from"../support/GoTo.js";function v(e){return"esri.WebMap"===e.declaredClass}function p(e){return"esri.WebScene"===e.declaredClass}let y=class extends(f(l)){constructor(e){super(e),this.filterMenuOpen=!1,this.filterMenuType="site",this.filterMode="base-floors",this.levelsExpanded=!0,this.searchTerm=null,this.view=null,this._updateFloorFilterTask=null}initialize(){this.handles.add([n(this,"view.map",(e=>{s(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null),this._updateFloorFilterTask=r((()=>this._updateFloorFilterFromMap(e).then((()=>{this._setInitialViewState()}))))})),n(this,"view",((e,i)=>{this._unregisterWidget(i),this._registerWidget(e),this._watchSearchResults(e)}),!0),a(this,"view.widthBreakpoint",(e=>{this._viewWidthBreakpoint=e})),a(this,"view.heightBreakpoint",(e=>{this._viewHeightBreakpoint=e}))])}destroy(){this._unregisterWidget(this.view),this.view=null,s(this._updateFloorFilterTask)&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)}set enabled(e){this._callOverride("enabled",e)}set facility(e){if(e&&this._isOverridden("facility")){const i=this.getFacility(e);this.hasMultipleSites&&(this.site=(null==i?void 0:i.siteId)||void 0)}this._callOverride("facility",e)}set filterFeatures(e){this._callOverride("filterFeatures",e)}set filterLayers(e){this._callOverride("filterLayers",e)}get hasFacilities(){var e,i,t,l;return(null==(e=this.filterLayers)?void 0:e.facilityLayer)&&(null==(i=this.filterFeatures)||null==(t=i.facilities)||null==(l=t.facilitiesInfo)?void 0:l.length)>0}get hasLevels(){var e,i,t,l;return(null==(e=this.filterLayers)?void 0:e.levelLayer)&&(null==(i=this.filterFeatures)||null==(t=i.levels)||null==(l=t.levelsInfo)?void 0:l.length)>0}get hasMultipleSites(){var e,i,t,l;return(null==(e=this.filterLayers)?void 0:e.siteLayer)&&(null==(i=this.filterFeatures)||null==(t=i.sites)||null==(l=t.sitesInfo)?void 0:l.length)>1}get isNormalMode(){let e=!0;const i=this._viewWidthBreakpoint,t=this._viewHeightBreakpoint;return"small"!==i&&"xsmall"!==i&&"xsmall"!==t||(e=!1),e}set level(e){if(!e)return this._callOverride("level",e),this.facility=void 0,this.site=void 0,void this.setFloors(null);let i=null,t=null;const l=null==e?void 0:e.split("--");var s;(null==l?void 0:l.length)>1&&"all"===l[0]?(t=l[1],i={id:e,facilityId:t,shortName:null,longName:null,levelNumber:null,verticalOrder:null}):(i=this.getLevel(e),t=null==(s=i)?void 0:s.facilityId);if(this.level!==e||this.isNormalMode||this.levelsExpanded){if(i&&this.hasFacilities&&this.hasLevels){var r;if(this.facility=t,this.hasMultipleSites)this.site=null==(r=this.getFacility(t))?void 0:r.siteId;this.setFloors(i)}else this._isOverridden("level")&&(this.facility=void 0,this.site=void 0,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null));this._callOverride("level",e)}else{const e=this.getFacilityLevels(t);(null==e?void 0:e.length)>1&&(this.levelsExpanded=!0)}}set longNames(e){this._callOverride("longNames",e)}set minimized(e){this._callOverride("minimized",e)}set pinnedLevels(e){this._callOverride("pinnedLevels",e)}set site(e){this._callOverride("site",e)}get state(){return this.view&&this.filterFeatures&&this.hasFacilities&&this.hasLevels?"ready":this.view&&!this.filterFeatures?"loading":"disabled"}filterFacilities(e){let i=e;this.searchTerm&&(i=e.filter((e=>{const{name:i}=e;return i.toLowerCase().includes(this.searchTerm.toLowerCase())}))),this.site&&(i=i.filter((e=>e.siteId===this.site)));return i.sort(((e,i)=>{const t=e.name,l=i.name;return t>l?1:t===l?0:-1}))}filterSites(e){let i=e;this.searchTerm&&(i=e.filter((e=>{const{name:i}=e;return i.toLowerCase().includes(this.searchTerm.toLowerCase())})));return i.sort(((e,i)=>{const t=e.name,l=i.name;return t>l?1:t===l?0:-1}))}getBaseLevel(e){var i,t;const l=null==(i=this.filterFeatures)||null==(t=i.levels)?void 0:t.levelsInfo;let s=null;if(e){const{id:i}=e;l&&l.length>0&&l.forEach((e=>{0===e.verticalOrder&&e.facilityId===i&&(s=e)}))}return s}getFacility(e){var i,t,l,s;return null!=(i=null==(t=this.filterFeatures)||null==(l=t.facilities)||null==(s=l.facilitiesInfo)?void 0:s.find((i=>i.id===e)))?i:null}getFacilityLevels(e){var i,t;if(!e||null==(i=this.filterFeatures)||null==(t=i.levels)||!t.levelsInfo)return[];return this.filterFeatures.levels.levelsInfo.filter((i=>i.facilityId===e)).sort(((e,i)=>{const t=e.verticalOrder,l=i.verticalOrder;return t>l?-1:t===l?0:1}))}getLevel(e){var i,t,l,s;return null!=(i=null==(t=this.filterFeatures)||null==(l=t.levels)||null==(s=l.levelsInfo)?void 0:s.find((i=>i.id===e)))?i:null}getSite(e){var i,t,l,s;return null!=(i=null==(t=this.filterFeatures)||null==(l=t.sites)||null==(s=l.sitesInfo)?void 0:s.find((i=>i.id===e)))?i:null}goTo(e){const{view:i}=this;if(!i||!e)return;const{geometry:t}=e;if(t&&t.extent){const e={duration:o(1e3),easing:"out-back"},i={target:t.extent,options:e};this.callGoTo(i)}}setFloors(e){var t,l,s;null==(t=this.view)||null==(l=t.map)||null==(s=l.allLayers)||s.forEach((e=>{"feature"===e.type&&this._computeViewAllModeFloors(e)})),this.view.floors=new i(this._computeFloors(e))}updateWebDocument(e){if(v(e)){var i,t,l;const s=new c({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,pinnedLevels:this.pinnedLevels,site:null!=(i=this.site)?i:null,facility:null!=(t=this.facility)?t:null,level:null!=(l=this.level)?l:null});e.widgets?e.widgets.floorFilter=s:e.widgets=new h({floorFilter:s})}}_computeFloors(e){if("single-floor"===this.filterMode)this._computeSingleFloor(e);else if("base-floors"===this.filterMode)return"3d"===this.view.type?this._computeBaseFloors3D(e):this._computeBaseFloors(e);return this._computeEmptyFloors()}_computeSingleFloor(e){if(!e)return this._computeEmptyFloors();const i=[];if("all"===(null==e?void 0:e.id)){this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&i.push(e.id)}))}else e&&i.push(e.id);return i}_computeBaseFloors(e){var i,t;const l=null==(i=this.filterFeatures)||null==(t=i.levels)?void 0:t.levelsInfo;if(!l||!l.length)return this._computeEmptyFloors();const s=[];if("all"===(null==e?void 0:e.id)){this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&s.push(e.id)}))}else e&&s.push(e.id);const r=null==e?void 0:e.facilityId;return l.forEach((e=>{const{id:i,facilityId:t,verticalOrder:l}=e;(r||0!==l||s.includes(i))&&(t===r||0!==l||s.includes(i))||s.push(i)})),s}_computeBaseFloors3D(e){var i,t;const l=null==(i=this.filterFeatures)||null==(t=i.levels)?void 0:t.levelsInfo;if(!l||!l.length)return this._computeEmptyFloors();const s=[],r=null==e?void 0:e.id.split("--");if((null==r?void 0:r.length)>1&&"all"===r[0]){this.getFacilityLevels(e.facilityId).forEach((e=>{e.id&&s.push(e.id)}))}else e&&s.push(e.id);const o=null==e?void 0:e.facilityId;return l.forEach((e=>{const{id:i,facilityId:t}=e;(o||s.includes(i))&&(t===o||s.includes(i))||s.push(i)})),s}_computeEmptyFloors(){return[]}async _setFilterLayers(){const{view:e}=this;if(!this._isOverridden("filterLayers")){if(!v(e.map)&&!p(e.map))throw new t("Map must be a webmap or webscene");{var i;const t=e.map,v=null==t?void 0:t.allLayers;if((null==v||null==(i=v.items)?void 0:i.length)>0){var l,s,r,o,n,a,u,d,h,c,f,y;const e={siteLayer:null,facilityLayer:null,levelLayer:null},i=null==(l=t.floorInfo)||null==(s=l.siteLayer)?void 0:s.layerId,p=null==(r=t.floorInfo)||null==(o=r.facilityLayer)?void 0:o.layerId,I=null==(n=t.floorInfo)||null==(a=n.levelLayer)?void 0:a.layerId,b=(null==(u=t.floorInfo)||null==(d=u.siteLayer)?void 0:d.sublayerId)||(null==(h=t.floorInfo)||null==(c=h.facilityLayer)?void 0:c.sublayerId)||(null==(f=t.floorInfo)||null==(y=f.levelLayer)?void 0:y.sublayerId);if(!p||!I)return;const O=v.items.filter((e=>"feature"===e.type||"scene"===e.type)),M=v.items.filter((e=>"map-image"===e.type));if((null==M?void 0:M.length)>0&&b){var m,F,g,L,_,w;await Promise.all(M.map((e=>e.load())));const l=null==(m=t.floorInfo)||null==(F=m.siteLayer)?void 0:F.sublayerId,s=null==(g=t.floorInfo)||null==(L=g.facilityLayer)?void 0:L.sublayerId,r=null==(_=t.floorInfo)||null==(w=_.levelLayer)?void 0:w.sublayerId;M.forEach((t=>{const o=t.id,n=null==t?void 0:t.allSublayers,a=null==n?void 0:n.items;(o===i||o===p||o===I)&&(null==a?void 0:a.length)>0&&n.items.forEach((t=>{const n=t.id;o===i&&n===l?e.siteLayer=t:n===s?e.facilityLayer=t:n===r&&(e.levelLayer=t)}))}))}(null==O?void 0:O.length)>0&&O.forEach((t=>{const l=t.id;l===i?e.siteLayer=t:l===p?e.facilityLayer=t:l===I&&(e.levelLayer=t)})),this.filterLayers=e}}}}async _getFilterFeatures(){if(this._isOverridden("filterFeatures"))return Promise.resolve(this.filterFeatures);const e={sites:null,facilities:null,levels:null},i=await this._getSites();e.sites=i;const t=await this._getFacilities();e.facilities=t;const l=await this._getLevels();return e.levels=l,e}async _getSites(){var e,i;const{filterLayers:t,view:l}=this,s=l.map,{siteLayer:r}=t,o={sitesInfo:[]};if(!r||null==s||null==(e=s.floorInfo)||!e.siteLayer)return o;const n=r.createQuery();n.returnGeometry=!0,n.outFields=["*"],n.returnZ=!0,"type"in r&&"scene"===r.type&&(n.multipatchOption="xyFootprint");const{siteIdField:a,nameField:u}=s.floorInfo.siteLayer,d=await r.queryFeatures(n);if((null==d||null==(i=d.features)?void 0:i.length)>0){d.features.forEach((e=>{const i=e.attributes,t=e.geometry,l=i[a],s=i[u];l&&s&&o.sitesInfo.push({id:l,name:s,geometry:t})}))}return o}async _getFacilities(){var e,i;const{filterLayers:t,view:l}=this,s=l.map,{facilityLayer:r}=t,o={facilitiesInfo:[]};if(!r||null==s||null==(e=s.floorInfo)||!e.facilityLayer)return o;const n=r.createQuery();n.returnGeometry=!0,n.outFields=["*"],n.returnZ=!0,"type"in r&&"scene"===r.type&&(n.multipatchOption="xyFootprint");const{facilityIdField:a,siteIdField:u,nameField:d}=s.floorInfo.facilityLayer,h=await r.queryFeatures(n);if((null==h||null==(i=h.features)?void 0:i.length)>0){h.features.forEach((e=>{const i=e.attributes,t=e.geometry,l=i[a],s=i[u],r=i[d];l&&r&&o.facilitiesInfo.push({id:l,siteId:s,name:r,geometry:t})}))}return o}async _getLevels(){var e,i;const{filterLayers:t,view:l}=this,s=l.map,{levelLayer:r}=t,o={levelsInfo:[]};if(!r||null==s||null==(e=s.floorInfo)||!e.levelLayer)return o;const n=r.createQuery();n.returnGeometry=!0,n.outFields=["*"],n.returnZ=!0;const{levelIdField:a,facilityIdField:u,longNameField:d,shortNameField:h,levelNumberField:c,verticalOrderField:f}=s.floorInfo.levelLayer,v=await r.queryFeatures(n);if((null==v||null==(i=v.features)?void 0:i.length)>0){v.features.forEach((e=>{const i=e.attributes,t=i[a],l=i[u],s=i[d],r=i[h],n=i[c],v=i[f];t&&l&&s&&r&&"number"==typeof n&&"number"==typeof v&&o.levelsInfo.push({id:t,facilityId:l,longName:s,shortName:r,levelNumber:n,verticalOrder:v})}))}return o}_registerWidget(e){(null==e?void 0:e.persistableViewModels.some((e=>e===this)))||null==e||e.persistableViewModels.add(this)}_unregisterWidget(e){null==e||e.persistableViewModels.remove(this)}_watchSearchResults(e){null==e||e.on("select-result-floor",(e=>{const i=this.getLevel(e);i&&this.level!==e&&(this.level=e,this.setFloors(i))}))}async _setInitialViewState(){if(this.view)try{await this.view.when(),await this._setFilterLayers();const e=await this._getFilterFeatures();if(!e)return;if(this.filterFeatures=e,!this.hasFacilities||!this.hasLevels)return void console.error("Facilities and Levels are required for the Floor Filter widget");if(this.hasMultipleSites||(this.filterMenuType="facility"),this.facility&&this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),i=this.getLevel(this.level);this.site||(this.site=e.siteId||void 0),this.setFloors(i),this.goTo(e)}else if(this.facility&&!this.level){this.filterMenuType="facility";const e=this.getFacility(this.facility),i=this.getBaseLevel(e);this.site||(this.site=e.siteId||void 0),this.level=(null==i?void 0:i.id)||void 0,this.setFloors(i),this.goTo(e)}else if(!this.facility&&this.level){this.filterMenuType="facility";const e=this.getLevel(this.level),i=this.getFacility(null==e?void 0:e.facilityId);this.facility=(null==i?void 0:i.id)||void 0,this.site||(this.site=(null==i?void 0:i.siteId)||void 0),this.setFloors(e),this.goTo(i)}else if(!this.site||this.facility||this.level)this.setFloors(null);else{this.filterMenuType="site";const e=this.getSite(this.site);this.setFloors(null),this.goTo(e)}}catch(e){console.error("Couldn't retrieve sites, facilities, and levels",e)}}_callOverride(e,i){this._override(e,i)}async _updateFloorFilterFromMap(e){var i;if(!e||!v(e))return;const t=null==e||null==(i=e.widgets)?void 0:i.floorFilter;t&&(this._isOverridden("enabled")||(this.enabled=t.enabled),this._isOverridden("longNames")||(this.longNames=t.longNames),this._isOverridden("minimized")||(this.minimized=t.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=t.pinnedLevels),this._isOverridden("site")||(this.site=t.site),this._isOverridden("facility")||(this.facility=t.facility),this._isOverridden("level")||(this.level=t.level))}_computeViewAllModeFloors(e){var t;const{filterFeatures:l}=this;if(null!=(t=e.floorInfo)&&t.viewAllMode&&this.hasLevels&&this.hasFacilities&&"base-floors"===this.filterMode){const{level:t,facility:s}=this,r=[];l.levels.levelsInfo.forEach((e=>{const{id:i,facilityId:l}=e;s&&l===s?t&&i===t&&r.push(i):r.push(i)})),e.floorInfo.viewAllLevelIds=new i(r)}}};e([u({value:!1})],y.prototype,"enabled",null),e([u({value:void 0})],y.prototype,"facility",null),e([u({value:null})],y.prototype,"filterFeatures",null),e([u({value:null})],y.prototype,"filterLayers",null),e([u()],y.prototype,"filterMenuOpen",void 0),e([u()],y.prototype,"filterMenuType",void 0),e([u()],y.prototype,"filterMode",void 0),e([u()],y.prototype,"hasFacilities",null),e([u()],y.prototype,"hasLevels",null),e([u()],y.prototype,"hasMultipleSites",null),e([u({readOnly:!0})],y.prototype,"isNormalMode",null),e([u({value:void 0})],y.prototype,"level",null),e([u({value:!1})],y.prototype,"longNames",null),e([u()],y.prototype,"levelsExpanded",void 0),e([u({value:!1})],y.prototype,"minimized",null),e([u({value:!1})],y.prototype,"pinnedLevels",null),e([u()],y.prototype,"searchTerm",void 0),e([u({value:void 0})],y.prototype,"site",null),e([u({readOnly:!0})],y.prototype,"state",null),e([u()],y.prototype,"view",void 0),e([u()],y.prototype,"_viewHeightBreakpoint",void 0),e([u()],y.prototype,"_viewWidthBreakpoint",void 0),e([u()],y.prototype,"updateWebDocument",null),y=e([d("esri/widgets/FloorFilter/FloorFilterViewModel")],y);const m=y;export{m as default};
