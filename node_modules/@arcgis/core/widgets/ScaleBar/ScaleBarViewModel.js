/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../geometry.js";import t from"../../core/Accessor.js";import{isNone as r}from"../../core/maybe.js";import{createScreenPoint as o}from"../../core/screenUtils.js";import{property as s}from"../../core/accessorSupport/decorators/property.js";import"../../core/arrayUtils.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import{isSupported as n,geodesicLengths as a}from"../../geometry/support/geodesicUtils.js";import{straightLineDensify as c}from"../../geometry/support/normalizeUtils.js";import{getInfo as m}from"../../geometry/support/spatialReferenceUtils.js";import{webMercatorToGeographic as l}from"../../geometry/support/webMercatorUtils.js";import p from"../../geometry/support/WKIDUnitConversion.js";import u from"../../geometry/SpatialReference.js";import d from"../../geometry/Polyline.js";import f from"../../geometry/Point.js";function g(e){const{wkid:t}=e;if(null!=p[t])return p.values[p[t]];const{wkt:r}=e,o=r.lastIndexOf(",")+1,s=r.lastIndexOf("]]");return parseFloat(r.substring(o,s))}function h(e,t){return e&&e.indexOf(t)>-1}function w(e,t){const{x:r,y:o}="decimal-degrees"===e?l(t,!0):t;return[r,o]}function y({state:{paddedViewState:e},spatialReference:t,width:r}){return t.isWrappable&&e.worldScreenWidth<r}let S=class extends t{constructor(e){super(e),this.scaleComputedFrom=o(),this.view=null}get state(){return this.get("view.ready")&&"2d"===this.get("view.type")?"ready":"disabled"}getScaleBarProperties(e,t){if("disabled"===this.state||isNaN(e)||!t)return null;const o=this._getDistanceInKm(this.view,this.scaleComputedFrom);if(r(o))return null;if("metric"===t)return this._getScaleBarProps(e,o,"metric");const s=o/1.609;return this._getScaleBarProps(e,s,"non-metric")}_getLocationUnit(){const e=this.get("view.spatialReference"),{isWebMercator:t,wkid:r,wkt:o}=e;return t||h(o,"WGS_1984_Web_Mercator")?"decimal-degrees":null!=p[r]||h(o,"PROJCS")?"linear-unit":"unknown"}_getDistanceInKm(e,t){const{state:r,spatialReference:o}=e,s=this._getLocationUnit();if("linear-unit"===s){const e=1e3;return r.extent.width*g(o)/e}const[i,m]=this._getScaleMeasuringPoints(e,t),l="decimal-degrees"===s||o.isGeographic&&!n(o)?u.WGS84:o,p=new d({paths:[[w(s,i),w(s,m)]],spatialReference:l}),f=c(p,10);let h;try{[h]=a([f],"kilometers")}catch{return null}return h}_getScaleMeasuringPoints(e,t){const{width:r,height:s,position:i,spatialReference:n}=e;if(y(e)){const{valid:e}=m(n);return[new f(e[0],0,n),new f(e[1],0,n)]}let a=t.y-i[1];a>s?a=s:a<0&&(a=0);const c=o(0,a),l=o(r,a);return[e.toMap(c),e.toMap(l)]}_getScaleBarProps(e,t,r){const{view:o}=this;let s=e*t/(y(o)?o.state.paddedViewState.worldScreenWidth:o.width),i="metric"===r?"km":"mi";if(s<.1)if("mi"===i){s*=5280,i="ft"}else if("km"===i){s*=1e3,i="m"}let n=0;for(;s>=1;)s/=10,n++;const a=this._getConstraints(s);if(!a)return null;const{min:c,max:m}=a,l=m/s>=s/c?c:m;return{length:e*(l/s),value:10**n*l,unit:i}}_getConstraints(e){return e>.5?{min:.5,max:1}:e>.3?{min:.3,max:.5}:e>.2?{min:.2,max:.3}:e>.15?{min:.15,max:.2}:e>=.1?{min:.15,max:.1}:void 0}};e([s()],S.prototype,"scaleComputedFrom",void 0),e([s({readOnly:!0})],S.prototype,"state",null),e([s()],S.prototype,"view",void 0),S=e([i("esri.widgets.Scalebar.ScaleBarViewModel")],S);const j=S;export{j as default};
