/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{property as t}from"../../core/accessorSupport/decorators/property.js";import"../../core/arrayUtils.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import{convertDateFormatToIntlOptions as i,formatDate as l}from"../../intl/date.js";import{convertNumberFormatToIntlOptions as o,formatNumber as a}from"../../intl/number.js";import r from"../../layers/support/CodedValueDomain.js";import{isNumericField as u,isStringField as s}from"../../layers/support/fieldUtils.js";import d from"../FeatureForm/InputField.js";import c from"./Grid/EditorColumn.js";import p from"../support/DatePicker.js";import m from"../support/TimePicker.js";import{renderingSanitizer as h}from"../support/widgetUtils.js";const f={cancelEdit:"Escape"},v={headerContent:"esri-field-column__header-content",input:"esri-field-column__cell-input",inputContainer:"esri-field-column__cell__input-container",dateInputContainer:"esri-field-column__cell__date-input-container",dateInputWrapper:"esri-field-column__cell__date-input-wrapper",button:"esri-field-column__button",saveIcon:"esri-icon-save",trashIcon:"esri-icon-trash",locked:"esri-icon-locked"},g=i("short-date-short-time"),y=i("short-date"),b=o({digitSeparator:!0,places:null});function _(e){return"feature"===(null==e?void 0:e.type)}let F=class extends c{constructor(e){super(e),this._inputField=null,this.alias=null,this.cellValueFormatFunction=({rowData:e,value:t})=>{if(this.formatFunction){const{config:e,field:n}=this;return this.formatFunction({config:e,field:n,value:h.sanitize(t)})}if(null===t)return"&nbsp;";const{config:n,field:r,type:s}=this,{item:{feature:d}}=e,c=this._getDomainForFeature(d);if(c)return this._getComputedDomain(t,c);if("date"===s){var p;const e=null!=n&&null!=(p=n.format)&&p.dateFormat?i(n.format.dateFormat):!1===(null==n?void 0:n.includeTime)?y:g,o=_(this.layer)&&this.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null;return t?l(t,{...e,...o}):null}if(u(r)){const e=null!=n&&n.format?o(n.format):b;return a(parseFloat(t),e)}return h.sanitize(t)},this.cellValueValidatorFunction=({oldValue:e,value:t})=>e!==t,this.config=null,this.defaultValue=null,this.description=null,this.editingEnabled=!1,this.field=null,this.formatFunction=null,this.headerRenderFunction=e=>{const{root:t}=e,{editable:n,editingEnabled:i,headerMenuEnabled:l,sortable:o}=this;if(this.removeCellContent(t),t.classList.add(v.headerContent),i&&!n&&t.appendChild(this.createLockedElement()),o)this.headerSorterRenderFunction(e);else{const{header:e,path:n}=this,i=document.createElement("div");i.innerHTML=e||n,t.appendChild(i)}l&&this.headerMenuRenderFunction(e)},this.inputRenderFunction=({root:e,column:t,rowData:n})=>{var i,l;if(null!=(i=this.activeEditInfo)&&i.updating)return;if(!this.editable)return;const o=this.getCellValue(t,n),a=this.createInputElement({root:e,column:t,rowData:n,value:o});if(this._set("activeEditInfo",{column:t,input:a,root:e,rowData:n,updating:!0,oldValue:o}),"date"===this.type)return void this._renderDateEditors(o,e,a);const r=this.createInputContainer();r.appendChild(a),this.removeCellContent(e),e.appendChild(r),a.focus(),a instanceof HTMLInputElement&&a.select(),null==(l=this.grid)||l.notifyResize()},this.layer=null,this.menuConfig=null,this.name=null,this.nullable=!0,this.parseInputValueFunction=({input:e})=>{const t=this._inputField,n=e.value,{required:i,type:l}=t;return i||""!==n?"number"===l||"date"===l?parseFloat(n):n:null},this.type=null,this.updateRowItemFunction=({rowData:e,column:t,value:n})=>{e.item.feature.attributes[t.path]=n}}get editable(){var e,t,n;return this.editingEnabled?this.config?!1!==this.config.editable&&(null==(t=this.field)?void 0:t.editable):null==(n=this.field)?void 0:n.editable:!!this.config&&(!0===this.config.editable&&(null==(e=this.field)?void 0:e.editable))}get header(){var e;return(null==(e=this.config)?void 0:e.label)||this.alias||this.path||null}get hidden(){const{config:e}=this;return!1===(null==e?void 0:e.visible)||this._get("hidden")||!1}set hidden(e){this._set("hidden",e)}get loadingMessage(){var e;return(null==(e=this.messages)?void 0:e.loading)||"..."}get maxLength(){var e,t;const n=null==(e=this.field)?void 0:e.length,i=null==(t=this.config)?void 0:t.maxLength;return!isNaN(i)&&i>=-1&&(-1===n||i<=n)?i:n}get path(){var e;return(null==(e=this.field)?void 0:e.name)||null}get required(){const e=this.get("field.nullable"),t=this.get("config.required");return this.editable&&(!e||!0===t)}get sortable(){var e;return!1!==(null==(e=this.config)?void 0:e.sortable)}createInputElement({rowData:e,value:t}){const{item:n}=e;if(!n||!n.feature)return null;this._inputField=this._setUpInputField(n.feature,t);const{field:i,maxLength:l,required:o}=this,{domain:a}=this._inputField;let r=null;"coded-value"===(null==a?void 0:a.type)?(r=this._createSelectElement(t,a.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),this._inputField),r.onchange=()=>{r.onblur=null,d()}):(r=document.createElement("input"),r.type=u(i)?"number":"text",l>-1&&(r.maxLength=l)),r.classList.add(v.input),r.value=t,r.required=o;let s=!1;r.onkeydown=e=>{s=e.key===f.cancelEdit},r.onblur=()=>{r.onblur=null,d()};const d=()=>{s?this.cancel():this.submit(),this._inputField=null};return r}createInputContainer(){const e=document.createElement("div");return e.classList.add(v.inputContainer),e}createLockedElement(){const e=document.createElement("div");return e.classList.add(v.locked),e}getCellValue({path:e},{item:t}){var n,i,l;return null!=(n=null==t||null==(i=t.feature)||null==(l=i.attributes)?void 0:l[e])?n:null}_renderDateEditors(e,t,n){var i;const{config:l,messagesCommon:o}=this,a=e?new Date(e):new Date(Date.now()),r=new p({dateInputEnabled:!0,value:a}),u=new m({value:a});n.value=a.getTime().toString();let s=!e;const d=()=>{s=!0;const e=this._getCombinedDateTime(r.value,u.value);n.value=e.getTime().toString()},c=()=>{s?this.submit():this.cancel()},h=()=>{n.value=null,this.submit()};r.watch("value",(()=>d())),u.watch("value",(()=>d()));const f=document.createElement("div"),g=document.createElement("div");r.container=f,u.container=g;const y=document.createElement("button");y.classList.add(v.button,v.saveIcon),y.onclick=()=>c(),y.title=null==o?void 0:o.save;const b=document.createElement("button");b.classList.add(v.button,v.trashIcon),b.onclick=()=>h(),b.title=null==o?void 0:o.clear;const _=document.createElement("div");_.classList.add(v.dateInputWrapper),_.appendChild(f),!1!==l.includeTime&&_.appendChild(g);const F=document.createElement("div");F.classList.add(v.dateInputContainer),F.appendChild(_),F.appendChild(y),F.appendChild(b),r.when((()=>{var e;return null==(e=this.grid)?void 0:e.notifyResize()})),u.when((()=>{var e;return null==(e=this.grid)?void 0:e.notifyResize()})),this.removeCellContent(t),t.appendChild(F),null==(i=this.grid)||i.notifyResize()}_createSelectElement(e,t,n){let i=!1;const l=t.map((t=>{t.value===e&&(i=!0);const n=document.createElement("option");return n.text=t.name,n.value=t.value,n}));if(null!=e&&""!==e&&!i){const t=document.createElement("option");t.text=e,t.value=e,l.unshift(t)}if(!n.required&&null==n.value){const e=document.createElement("option");e.value="",l.unshift(e)}const o=document.createElement("select");return l.forEach((e=>o.add(e))),o.value=e,o}_setUpInputField(e,t){const{config:n,field:i,layer:l}=this,o=new d({config:n,feature:e,field:i,layer:l,group:null,messages:null});return o.set("value",t),o}_isDomainCompatible(e){const{field:t}=this;if(e&&"coded-value"===e.type){const n=typeof e.codedValues[0].code;if("string"===n&&s(t)||"number"===n&&u(t))return!0}return!(!e||"range"!==e.type||!u(t))}_getDomainForFeature(e){const{layer:t,name:n}=this;if("wfs"===t.type||"geojson"===t.type)return null;const{typeIdField:i}=t,l=i===n,o=this.get("field.domain");if(l&&!o)return new r({name:"__internal-type-based-coded-value-domain__",codedValues:t.types.map((({id:e,name:t})=>({code:e,name:t})))});const a=i&&t.getFieldDomain(n,{feature:e})||o,u=this.get("config.domain");return this._isDomainCompatible(u)?u:a}_getComputedDomain(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){const n=t.codedValues.filter((t=>t.hasOwnProperty("code")&&t.code===e));return n&&n.length?n[0].name:e}return null}_getCombinedDateTime(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())}};e([t({readOnly:!0,aliasOf:"field.alias"})],F.prototype,"alias",void 0),e([t()],F.prototype,"cellValueFormatFunction",void 0),e([t()],F.prototype,"cellValueValidatorFunction",void 0),e([t()],F.prototype,"config",void 0),e([t({readOnly:!0,aliasOf:"field.defaultValue"})],F.prototype,"defaultValue",void 0),e([t({readOnly:!0,aliasOf:"field.description"})],F.prototype,"description",void 0),e([t({readOnly:!0})],F.prototype,"editable",null),e([t()],F.prototype,"editingEnabled",void 0),e([t()],F.prototype,"field",void 0),e([t()],F.prototype,"formatFunction",void 0),e([t({readOnly:!0})],F.prototype,"header",null),e([t()],F.prototype,"hidden",null),e([t()],F.prototype,"headerRenderFunction",void 0),e([t()],F.prototype,"inputRenderFunction",void 0),e([t()],F.prototype,"layer",void 0),e([t({readOnly:!0})],F.prototype,"loadingMessage",null),e([t()],F.prototype,"maxLength",null),e([t({readOnly:!0,aliasOf:"config.menuConfig"})],F.prototype,"menuConfig",void 0),e([t({readOnly:!0,aliasOf:"field.name"})],F.prototype,"name",void 0),e([t({readOnly:!0,aliasOf:"field.nullable"})],F.prototype,"nullable",void 0),e([t()],F.prototype,"parseInputValueFunction",void 0),e([t({readOnly:!0})],F.prototype,"path",null),e([t({readOnly:!0})],F.prototype,"required",null),e([t()],F.prototype,"sortable",null),e([t({readOnly:!0,aliasOf:"field.type"})],F.prototype,"type",void 0),e([t()],F.prototype,"updateRowItemFunction",void 0),F=e([n("esri.widgets.FeatureTable.FieldColumn")],F);const C=F;export{C as default};
