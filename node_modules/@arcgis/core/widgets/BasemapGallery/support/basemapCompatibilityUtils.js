/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import{isNone as a,isSome as t}from"../../../core/maybe.js";import{throwIfAborted as i}from"../../../core/promiseUtils.js";import{isTiledLayer as r,isWMTSLayer as n}from"../../../layers/support/layerUtils.js";import{stringFromViewingMode as o,ViewingMode as s}from"../../../views/ViewingMode.js";import{getTileInfoAndExtentFromWMTSLayer as l,isVectorTileLayer as p,checkIfTileInfoSupportedForView as c}from"../../../views/3d/terrain/terrainUtils.js";import m from"../../../views/3d/terrain/TilingScheme.js";import{isSpatialReferenceSupported as f}from"../../../views/support/spatialReferenceSupport.js";async function u(e,a={}){await b(e,a),i(a)}async function y(e,a={}){const{basemap:t,view:n}=e;if(i(a),"spatialReferenceLocked"in n&&!n.spatialReferenceLocked)return;if(await t.load(a),i(a),0===t.baseLayers.length)return;const o=t.baseLayers.getItemAt(0);if(!r(o))return;if(t.spatialReference){if(n.spatialReference.equals(t.spatialReference))return;w()}await o.load(a),i(a);const s=(("supportedSpatialReferences"in o?o.supportedSpatialReferences:null)||["tileInfo"in o?o.tileInfo.spatialReference:null]).filter(Boolean);0!==s.length&&s.every((e=>!n.spatialReference.equals(e)))&&w()}function w(){throw new e("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}async function b(a,t){const{basemap:i,view:r}=a;if(await i.load(t),0===i.baseLayers.length)return;const n=h(i.baseLayers.concat(i.referenceLayers));if(n.length)throw n[0];const o=i.baseLayers.getItemAt(0);try{await o.load(t)}catch(s){const a="basemap-compatibility:unknown-error",t="Unknown basemap compatibility error",{name:i=a,message:r=t,details:n}=s;throw new e(i,r,n)}g(o,r)}function h(a){const t=["ArcGISTiledImageServiceLayer","ArcGISTiledMapServiceLayer","OpenStreetMap","VectorTileLayer","WebTiledLayer"];return a.toArray().filter((e=>-1===t.indexOf(e.operationalLayerType))).map((a=>new e("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:a,operationalLayerType:a.operationalLayerType||"unknown"})))}function g(i,r){const u=r.state.viewingMode;if(!u)return;let y=i.tileInfo,w=i.fullExtent;if(n(i)){const t=l(i,r.spatialReference,u);if(a(t.tileInfo))throw new e("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");y=t.tileInfo,w=t.fullExtent}if(a(y))return;if(!f(y.spatialReference,u))throw new e(`basemapgalleryitem:spatial-reference-unsupported-${o(u)}`,`Basemap spatial reference is unsupported in ${o(u)} mode`);const b=y.spatialReference.isGeographic,h=p(i)?y.getOrCreateCompatible(256,b?1:2):null;if(u===s.Global){let a=c(y,w,null,u);if(a&&p(i)&&t(w)&&h&&!c(h,w,null,u)&&(a=null),a){const t=y.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new e(`basemapgalleryitem:tiling-scheme-unsupported-${t}-global`,"Basemap tiling scheme is unsupported in global mode",{error:a})}}else if(m.checkUnsupported(y))throw new e("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const g=r.get("basemapTerrain.tilingScheme");if(g&&!g.compatibleWith(y)&&!(p(i)&&h&&g.compatibleWith(h)))throw new e("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}export{y as default2DCompatibility,u as default3DCompatibility};
