/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Collection.js";import{HandleOwnerMixin as i}from"../../core/HandleOwner.js";import s from"../../core/Loadable.js";import{isSome as r}from"../../core/maybe.js";import{watch as o,on as a}from"../../core/reactiveUtils.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import"../../core/arrayUtils.js";import"../../core/has.js";import{cast as p}from"../../core/accessorSupport/decorators/cast.js";import{subclass as c}from"../../core/accessorSupport/decorators/subclass.js";import{canProjectWithoutEngine as l,isLoaded as m,load as u}from"../../geometry/projection.js";import{equals as d}from"../../geometry/support/spatialReferenceUtils.js";import{contentEquals as h}from"../../support/basemapUtils.js";import{default3DCompatibility as v,default2DCompatibility as f}from"./support/basemapCompatibilityUtils.js";import y from"./support/BasemapGalleryItem.js";import b from"./support/LocalBasemapsSource.js";import w from"./support/PortalBasemapsSource.js";const j=t.ofType(y);function g(e){return e&&"esri.portal.Portal"===e.declaredClass}function _(e){return e&&!(e instanceof w)&&(!!e.portal||!!e.query)}function B(e){return e&&"basemaps"in e&&"state"in e&&"refresh"in e}let R=class extends(i(s)){constructor(e){super(e),this._loadingProjectionEngine=!1,this.items=new j,this.source=new w,this.view=null}initialize(){const e=()=>this._recreateItems();this.handles.add([o((()=>"ready"===this.state?this.compatibilityFunction:null),(()=>this._updateItems())),a((()=>{var e;return null==(e=this.source)?void 0:e.basemaps}),"change",e,{onListenerAdd:e})])}get activeBasemap(){var e,t,i;return null!=(e=null==(t=this.view)||null==(i=t.map)?void 0:i.basemap)?e:null}set activeBasemap(e){var t;if(!this.view.map)return;if(!e||!this.view.ready)return this.view.map.basemap=e,void this._clearOverride("activeBasemap");const i=e.spatialReference||(null==(t=this.items)?void 0:t.find((t=>t.basemap===e)).spatialReference);if(i&&"spatialReferenceLocked"in this.view&&!this.view.spatialReferenceLocked){const t=this.view.spatialReference;if(r(i)&&!d(t,i)&&!l(this.view.spatialReference,i)&&!m())return this._override("activeBasemap",e),this._loadingProjectionEngine=!0,void u().then((()=>{this._get("activeBasemap")===e&&(this.view.map.basemap=e,this.view.spatialReference=i,this._clearOverride("activeBasemap"))}),(()=>{})).then((()=>{this._loadingProjectionEngine=!1}));this.view.map.basemap=e,this._clearOverride("activeBasemap"),r(i)&&!d(this.view.spatialReference,i)&&(this.view.spatialReference=i)}else this.view.map.basemap=e,this._clearOverride("activeBasemap")}get compatibilityFunction(){var e;return"3d"===(null==(e=this.view)?void 0:e.type)?v:f}set compatibilityFunction(e){r(e)?this._override("compatibilityFunction",e):this._clearOverride("compatibilityFunction")}castSource(e){return Array.isArray(e)||t.isCollection(e)?new b({basemaps:e}):g(e)?new w({portal:e}):_(e)?new w(e):B(e)?e:null}get state(){var e;return null!=(e=this.view)&&e.ready&&this.source?this._loadingProjectionEngine?"loading":"ready":"disabled"}basemapEquals(e,t){return h(e,t)}refresh(){this._recreateItems()}load(e){return this.addResolvingPromise(s.isLoadable(this.source)?this.source.load(e):null),Promise.resolve(this)}_recreateItems(){var e;const t=null==(e=this.source)?void 0:e.basemaps,{view:i,compatibilityFunction:s}=this;this.items.removeAll().forEach((e=>e.destroy())),t&&this.items.addMany(t.map((e=>new y({basemap:e,compatibilityFunction:s,view:i}))))}_updateItems(){for(const e of this.items)e.compatibilityFunction=this.compatibilityFunction,e.view=this.view}};e([n()],R.prototype,"_loadingProjectionEngine",void 0),e([n()],R.prototype,"activeBasemap",null),e([n()],R.prototype,"compatibilityFunction",null),e([n({readOnly:!0,type:j})],R.prototype,"items",void 0),e([n()],R.prototype,"source",void 0),e([p("source")],R.prototype,"castSource",null),e([n({readOnly:!0})],R.prototype,"state",null),e([n()],R.prototype,"view",void 0),R=e([c("esri.widgets.BasemapGallery.BasemapGalleryViewModel")],R);const F=R;export{F as default};
