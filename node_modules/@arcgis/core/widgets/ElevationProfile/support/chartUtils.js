/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.23/esri/copyright.txt for details.
*/
import"../../../intl.js";import{binaryFindClosest as i}from"../../../core/arrayUtils.js";import{makeHandle as e,handlesGroup as t}from"../../../core/handleUtils.js";import{isNone as o,applySome as n,isSome as a,unwrapOr as s}from"../../../core/maybe.js";import{throwIfAborted as r}from"../../../core/promiseUtils.js";import{formatDecimal as l,unitName as d}from"../../../core/unitFormatUtils.js";import{convertUnit as c}from"../../../core/unitUtils.js";import{CHART_CSS as m}from"../css.js";import{NO_DATA_VALUE as p,FORMAT_PRECISION as x,NOT_AVAILABLE as u,MAX_CHART_RATIO as g}from"./constants.js";import{getTranslatedLineTitle as f}from"./intlUtils.js";import{niceScale as h}from"./niceScale.js";import{loadChartsModule as b}from"../../support/chartUtils.js";import{isRTL as v}from"../../support/widgetUtils.js";import"../../../core/has.js";import"../../../core/Logger.js";import{isDarkTheme as T}from"../../support/widgetThemeUtils.js";import{substitute as A}from"../../../intl/substitute.js";import{formatNumber as C}from"../../../intl/number.js";const L="#f8f8f8",y="#a9a9a9",z="#323232",k="line",P="fill",S=15,F=12,w=30,M=.001,Y=.5,X=.5,j=30,I=.02,W=.02,H={sideSpacing:S,paddingBottom:0,paddingLeft:0,paddingRight:0,paddingTop:0,axisFontSize:9,axisFontWeight:"400",axisGridStroke:"#f4f4f4",axisLabelsFontSize:9,axisLabelsFontWeight:"400",axisLabelsColor:y,axisTooltipFontSize:12,axisTooltipBackgroundColor:z,axisTooltipLabelColor:L,axisTooltipPaddingTop:Math.round(F/4),axisTooltipPaddingBottom:Math.round(F/4),axisTooltipPaddingHorizontal:Math.round(S/4),xAxisMinGridDistance:50,xAxisLabelsSpacing:Math.round(F/2),xAxisMinLabelPosition:.05,xAxisMaxLabelPosition:.9,yAxisMinGridDistance:30,yAxisLabelSpacing:Math.round(S/4),yAxisMinLabelPosition:0,yAxisMaxLabelPosition:.8,seriesTooltipFontSize:12,seriesTooltipBackgroundColor:L,seriesTooltipLabelColor:z,seriesFillLighten:.9,seriesTooltipSpacing:F/2,seriesTooltipPaddingVertical:Math.round(S/4),seriesTooltipPaddingHorizontal:Math.round(S/4),tooltipBorderRadius:0},O={...H,axisGridStroke:z,axisLabelsColor:y,axisTooltipBackgroundColor:z,axisTooltipLabelColor:L,seriesTooltipBackgroundColor:z,seriesTooltipLabelColor:L,seriesFillLighten:-.75},U={minX:void 0,maxX:void 0,minY:void 0,maxY:void 0};async function B(i){const e=await b();r(i.abortOptions);const{am4core:n,am4charts:a}=e;n.options.minPolylineStep=Y,n.options.autoSetClassName=!0,n.options.animationsEnabled=!1;const s=T(),l=s?O:H;s&&n.useTheme(e.am4themes_dark);const d=n.create(i.container,a.XYChart);d.arrangeTooltips=!1,d.preloader.disabled=!0,d.zoomOutButton.disabled=!0;const c=v(i.container);d.rtl=c,d.padding(l.paddingTop,c?l.paddingLeft:l.paddingRight,l.paddingBottom,c?l.paddingRight:l.paddingLeft);const m=d.plotContainer.background;m.strokeWidth=0,m.strokeOpacity=0,m.stroke=null;const p=d.xAxes.push(new a.ValueAxis),x=d.yAxes.push(new a.ValueAxis),u={params:i,amCharts4Index:e,amChart:d,xAxis:p,yAxis:x,series:new Map,data:null,messages:null,theme:l,zooming:!1,pointerIsOver:!1};d.cursor=E(u),D(u),G(u),R(u);const g=[ei(u,i.onRangeChange),oi(u,i.onCursorPositionChange),ti(u)];let f=null,h=!1;const A=()=>{o(f)||("undefined"!=typeof window&&"cancelIdleCallback"in window?window.cancelIdleCallback(f):clearTimeout(f),f=null)};return{...u,destroy(){h=!0,A(),t(g).remove(),d.dispose()},update(i){if(i.data===u.data&&i.messages===u.messages)return;if(A(),h)return;const e=()=>{h||(f=null,V(u,i))};f="undefined"!=typeof window&&"requestIdleCallback"in window?window.requestIdleCallback(e,{timeout:j}):setTimeout(e,j)},zoomOut(){h||(u.yAxis.zoom({start:0,end:1},!1,!0),u.xAxis.zoom({start:0,end:1},!1,!0))}}}function E(i){const e=new i.amCharts4Index.am4charts.XYCursor;return e.trackable=!0,e.lineY.disabled=!0,e.behavior="zoomXY",e}function D(i){const e=i.theme,t=i.amChart.tooltip,{am4core:o}=i.amCharts4Index;t.id="series-tooltip",t.fitPointerToBounds=!0,t.pointerOrientation="vertical",t.zIndex=-1,t.getFillFromObject=!1,t.label.fontSize=e.seriesTooltipFontSize,t.label.fill=o.color(e.seriesTooltipLabelColor),t.label.padding(e.seriesTooltipPaddingVertical,e.seriesTooltipPaddingHorizontal,e.seriesTooltipPaddingVertical,e.seriesTooltipPaddingHorizontal),t.background.cornerRadius=e.tooltipBorderRadius,t.background.stroke=null,t.background.fill=o.color(e.seriesTooltipBackgroundColor),t.background.padding(0,0,0,0),t.adapter.add("dy",(()=>e.seriesTooltipSpacing*(t.background.pointerY<=0?1:-1))),v(i.params.container)&&(t.label.textAlign="middle")}function G(i){const{xAxis:e,theme:t}=i,{am4core:o}=i.amCharts4Index;e.numberFormatter=di(i,"distance"),e.strictMinMax=!0,e.cursorTooltipEnabled=!1,e.title.visible=!1;const n=e.renderer;n.line.visible=!1,n.minGridDistance=t.xAxisMinGridDistance,n.minLabelPosition=t.xAxisMinLabelPosition,n.maxLabelPosition=t.xAxisMaxLabelPosition,n.fontWeight=t.axisFontWeight,n.fontSize=t.axisFontSize,n.baseGrid.disabled=!0;const a=n.labels.template;a.fontSize=t.axisLabelsFontSize,a.fontWeight=t.axisLabelsFontWeight,a.fill=o.color(t.axisLabelsColor),a.paddingTop=t.xAxisLabelsSpacing,a.horizontalCenter="left",a.paddingLeft=0;const s=e.tooltip;s.id="axis-tooltip",s.background.fill=o.color(t.axisTooltipBackgroundColor),s.background.stroke=null,s.background.padding(0,0,0,0),s.label.fontSize=t.axisTooltipFontSize,s.label.fill=o.color(t.axisTooltipLabelColor),s.label.padding(t.axisTooltipPaddingTop,t.axisTooltipPaddingHorizontal,t.axisTooltipPaddingBottom,t.axisTooltipPaddingHorizontal);const r=n.grid.template;r.strokeOpacity=1,r.stroke=o.color(t.axisGridStroke)}function R(i){const{yAxis:e,theme:t}=i,{am4core:o}=i.amCharts4Index;e.numberFormatter=di(i,"elevation"),e.title.visible=!1,e.cursorTooltipEnabled=!1,e.strictMinMax=!0,e.baseValue=p;const n=e.renderer;n.inside=!0,n.line.opacity=0,n.line.visible=!1,n.minGridDistance=t.yAxisMinGridDistance,n.minLabelPosition=t.yAxisMinLabelPosition,n.maxLabelPosition=t.yAxisMaxLabelPosition,n.fontWeight=t.axisFontWeight,n.fontSize=t.axisFontSize,n.baseGrid.disabled=!0;const a=n.labels.template;a.fontSize=t.axisLabelsFontSize,a.fontWeight=t.axisLabelsFontWeight,a.fill=o.color(t.axisLabelsColor),a.verticalCenter="bottom",a.paddingLeft=t.yAxisLabelSpacing,a.paddingBottom=0;const s=n.grid.template;s.strokeOpacity=1,s.stroke=o.color(t.axisGridStroke),v(i.params.container)&&(n.opposite=!0,a.textAlign="middle",a.paddingLeft=0,a.paddingRight=t.yAxisLabelSpacing)}function V(i,{data:e,messages:t}){const o=a(e)&&e.refined;i.amChart.cursor.disabled=!o,i.amChart.htmlContainer.classList.toggle(m.cursorEnabled,o);const s=i.data!==e,r=n(i.data,(i=>i.effectiveUnits))!==n(e,(i=>i.effectiveUnits));i.data=e,i.messages=t,s&&($(i),_(i)),r&&(i.yAxis.invalidateLabels(),i.xAxis.invalidateLabels()),ni(i)}function $(i){const{xAxis:e,yAxis:t}=i,{minX:o,maxX:n,minY:a,maxY:s}=Z({data:i.data,pixelWidth:e.pixelWidth,pixelHeight:t.pixelHeight});e.min=o,e.max=n,t.min=a,t.max=s}function Z({data:i,pixelWidth:e,pixelHeight:t}){if(o(i))return U;const a=i.statistics,s=0,r=n(a,(i=>i.maxDistance));let l=n(a,(i=>i.minElevation)),d=n(a,(i=>i.maxElevation));if(o(r)||o(l)||o(d))return U;const m=Math.max(r-s,M);let p=Math.max(d-l,M);const x=i.effectiveUnits;if(i.dynamicElevationRange){const i=c(m,x.distance,x.elevation);p=Math.max(p,i/g)}return l-=W*p,d=l+p+I*p,[l,d]=h(l,d,10),p=d-l,i.uniformScaling?q({data:i,bounds:{minX:s,maxX:r,minY:l,maxY:d},pixelWidth:e,pixelHeight:t,centered:!0}):{minX:s,maxX:s+m,minY:l,maxY:l+p}}function q({data:i,bounds:e,pixelWidth:t,pixelHeight:n,centered:a}){if(o(i))return e;let{minX:s,maxX:r,minY:l,maxY:d}=e;const m=r-s,p=d-l,x=i.effectiveUnits,u=c(p,x.elevation,x.distance)/n/(m/t);return u>=1?[s,r]=N([s,r],u,a):[l,d]=N([l,d],1/u,a),{minX:s,maxX:r,minY:l,maxY:d}}function N([i,e],t,o){const n=(e-i)*t;if(o){const t=(i+e)/2-n/2;return[t,t+n]}return[i,i+n]}function _(i){const{amChart:e,data:t}=i;if(o(t)||0===t.lines.length)return void e.series.clear();const a=new Map,s=new Set(e.series.values),r=t.lines.length;for(let o=0;o<r;o++){const l=t.lines[o];let d=i.series.get(l.id);d?(n(d.fill,(i=>s.delete(i))),s.delete(d.line)):(d=Q(i,l),n(d.fill,(i=>e.series.push(i))),e.series.push(d.line)),a.set(d.id,d);const c=r-o-1;n(d.fill,(i=>i.zIndex=c)),d.line.zIndex=r+c,J(i,d,l)}i.series=a;for(const o of s)e.series.removeValue(o)}function J(i,{line:e,fill:t},o){const{theme:a}=i,{am4core:r}=i.amCharts4Index,{r:l,g:d,b:c,a:m}=o.color,p=r.color({r:l,g:d,b:c,a:m}),x=s(o.samples,[]),u=x.length>0;e.stroke=p,e.visible=u,n(t,(i=>{i.visible=u,i.fill=p.lighten(a.seriesFillLighten)}));const g=x.length,f=e.data;if(f.length===g){for(let i=0;i<g;++i)K(f[i],x[i]);e.invalidateRawData(),n(t,(i=>i.invalidateRawData()))}else e.data=x,n(t,(i=>i.data=x))}function K(i,e){i.x=e.x,i.y=e.y,i.z=e.z,i.distance=e.distance,i.elevation=e.elevation}function Q(i,e){const{id:t}=e,o=ii(i,`${k}-${t}`);o.strokeWidth=e.chartStrokeWidth,o.dy=e.chartStrokeOffsetY;let n=null;return e.chartFillEnabled&&(n=ii(i,`${P}-${t}`),n.fillOpacity=1),{id:t,line:o,fill:n}}function ii(i,e){const t=new i.amCharts4Index.am4charts.LineSeries;t.id=e,t.showOnInit=!1,t.simplifiedProcessing=!0,t.minDistance=X,t.excludeFromTotal=!0,t.clickable=!1,t.contextMenuDisabled=!0,t.cursorHoverEnabled=!1,t.cursorTooltipEnabled=!1,t.connect=!1,t.fill=null,t.stroke=null;const o="distance";t.dataFields.valueX=o;const n="elevation";return t.dataFields.valueY=n,t}function ei(i,t){const{amChart:n,xAxis:a,yAxis:s}=i;let r=!1;const l=()=>{const{data:e}=i;if(!r||o(e)||!e.uniformScaling)return;r=!1;const{minX:t,maxX:l,minY:d,maxY:c}=q({data:i.data,bounds:{minX:a.minZoomed,maxX:a.maxZoomed,minY:s.minZoomed,maxY:s.maxZoomed},pixelWidth:a.pixelWidth,pixelHeight:s.pixelHeight,centered:!0});a.zoomToValues(t,l,!0),s.zoomToValues(d,c,!0),n.validate(),ni(i)},d=()=>{t(i.xAxis.zoomFactor,i.yAxis.zoomFactor)},c=e=>{i.zooming=e,ni(i)},m=[n.events.on("down",(()=>c(!0))),n.events.on("up",(()=>c(!1))),n.cursor.events.on("zoomended",(()=>{r=!0})),a.events.on("startendchanged",l),s.events.on("startendchanged",l),a.events.on("rangechangeended",d),s.events.on("rangechangeended",d)];return e((()=>{m.forEach((i=>i.dispose()))}))}function ti({xAxis:i,yAxis:t}){const o=i=>()=>{i.renderer.grid.each((i=>{i.visible="none"!==i.dataItem.label.dom.getAttribute("display")}))},n=[i.events.on("rangechangeended",o(i)),i.events.on("validated",o(i)),t.events.on("rangechangeended",o(t)),t.events.on("validated",o(t))];return e((()=>{n.forEach((i=>i.dispose()))}))}function oi(i,t){const{amChart:o,xAxis:n,yAxis:a}=i,{cursor:s,events:r}=o,l=e=>{i.pointerIsOver=e,ni(i)},d=()=>{l(!1),t(null,null)},c=[s.events.on("cursorpositionchanged",(()=>{if(!i.pointerIsOver)return;ni(i);const e=n.toAxisPosition(s.xPosition),o=a.toAxisPosition(s.yPosition);t(e,o)})),r.on("over",(()=>l(!0))),r.on("out",d),r.on("blur",d)];return e((()=>{c.forEach((i=>i.dispose()))}))}function ni(i){const{amChart:e,xAxis:t,data:n,theme:s,zooming:r,pointerIsOver:l}=i;if(i.amChart.tooltip.hide(),i.xAxis.hideTooltip(),!l)return;if(r)return;if(o(n)||!n.refined)return;const d=ai(i);if(a(d)){const{cursor:o,tooltip:n}=e;o.show(0),o.validate(),n.text=d.text,n.show(0),n.validate();const a=d.y-n.contentHeight-s.seriesTooltipSpacing;n.pointerOrientation=a<w?"up":"down",n.pointTo(d,!0),n.validate();const r=t.tooltip;r.text=li(i),r.show(0),r.validate()}}function ai(i){const{amChart:e,yAxis:t,data:a}=i;if(o(a))return null;const s=a.lines.map((e=>({line:e,y:n(ci(i,e),(i=>i.elevation))}))).sort(si),r=s.length?s[0].y:null;if(o(r))return null;const l=e.cursor,d=t.measuredHeight,c=d+e.pixelPaddingTop;return{text:s.map((({y:e,line:t})=>ri(i,t,e))).join("\n"),x:l.point.x+l.parent.pixelX+e.pixelPaddingLeft,y:c-t.valueToPosition(r)*d}}function si({y:i},{y:e}){return o(i)?1:o(e)?-1:e-i}function ri(i,e,t){const{data:n,messages:s}=i;if(o(n)||o(s))return"";const r=A(s.chartTooltip,{name:f(e,s),elevation:a(t)?l(s,t,n.effectiveUnits.elevation,x):u});return`[${e.color.toHex()}]●[/] ${r}`}function li(i){const{data:e,messages:t}=i;if(o(e)||o(t))return"";const n=e.lines[0],s=n?ci(i,n):null;return a(s)?l(t,s.distance,e.effectiveUnits.distance,x):"-"}function di(i,e){const t=i.xAxis.numberFormatter.clone();return t.format=(t,n,a)=>{const{messages:s,data:r}=i;if(o(s)||o(r)||"string"==typeof t)return"";return`${C(t,{maximumFractionDigits:a})} ${d(s,r.effectiveUnits[e],"abbr")}`},t}function ci({amChart:e,xAxis:t},o){const n=s(o.samples,[]);if(0===n.length)return null;const a=t.toAxisPosition(e.cursor.xPosition),r=t.positionToValue(a);return i(n,r,(i=>i.distance))}export{B as createChart,Z as getAdjustedBounds};
